<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Fleur De Vie - Checkout</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    /* RESET & BASE */
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family: "Montserrat", sans-serif; background: #F5E6CC; color:#112e1f; line-height:1.6; }
    a { text-decoration:none; color:inherit; }
    
    /* HEADER (Luxury Translucent Version) */
    .site-header {
      background: rgba(17,46,31,0.9); /* deep brand green, slightly see-through */
      backdrop-filter: blur(2px);
      -webkit-backdrop-filter: blur(5px);
      color: #F5E6CC;
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding:10px 24px;
      position:fixed;
      top:0; left:0; right:0;
      z-index:1000;
      height:68px;
      transition: background 0.3s ease, top 0.4s ease, opacity 0.4s ease;
    }
    
    .site-header.scrolled {
      background: #112e1f; /* solid brand color after scroll */
    }
    
    .site-header.hidden {
      opacity: 0;
      top: -80px;
      pointer-events: none;
    }
    
    .site-header:hover {
      background: rgba(17,46,31,0.9);
    }
    
    .header-left { display:flex; align-items:center; gap:10px; }
    .brand-logo { height:70px; transition:height 0.3s ease; }
    .brand-title { font-family:"Playfair Display", serif; font-size:22px; font-weight:700; }
    
    .header-right { display:flex; gap:20px; align-items:left; }
    
    .header-right a {
      font-weight: 500;
      color: inherit;
      position: relative;
      transition: color 0.3s ease, transform 0.3s ease;
    }
    
    .header-right a:hover {
      color: #c9e4ff;
      transform: translateY(-2px);
    }
    .cart-count { background:#FFD6BA; color:#112e1f; font-size:12px; font-weight:600; border-radius:50%; padding:2px 6px; margin-left:4px; }
    
    .hamburger { display:none; background:none; border:none; cursor:pointer; width:30px; height:24px; position:relative; }
    .hamburger span { display:block; width:100%; height:3px; background:#F5E6CC; border-radius:2px; position:absolute; left:0; transition:0.3s; }
    .hamburger span:nth-child(1){ top:0; }
    .hamburger span:nth-child(2){ top:10px; }
    .hamburger span:nth-child(3){ top:20px; }
    .hamburger.open span:nth-child(1){ transform:rotate(45deg); top:10px; }
    .hamburger.open span:nth-child(2){ opacity:0; }
    .hamburger.open span:nth-child(3){ transform:rotate(-45deg); top:10px; }
    
    /* HERO */
    .hero { position: relative; height:90vh; display:flex; justify-content:center; align-items:center; text-align:center; margin-top:0; overflow:hidden; }
    .hero::after { content:""; position:absolute; inset:0; background:url('../asset/bg18.jpg') center/cover no-repeat; transform:scale(1.1); z-index:-1; border-radius:12px; box-shadow: inset 0 0 0 2000px rgba(17,46,31,0.3); }
    .hero-text { position:relative; display:inline-block; color:#FFD6BA;  margin-bottom:12px; animation: shimmer 3s infinite linear; }
    .hero-text h1 { font-family:"Playfair Display", serif; font-size:clamp(36px,5vw,64px); margin-bottom:12px; }
    .hero-text p { font-size:clamp(16px,2vw,24px); max-width:700px; }

    /* checkout grid */
    section.checkout{padding:60px 20px}
    .container{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr 1.6fr;gap:28px}
    .checkout-form,.order-summary{border-radius:12px;padding:18px;box-shadow:0 4px 10px rgba(0,0,0,0.2)}
    .checkout-form{background:#F5E6CC}
    .order-summary{background:#F5E6CC}
    h2{font-family:"Playfair Display",serif;margin-bottom:12px;font-size:20px}
    label{display:block;margin-bottom:6px;font-weight:500}
    input,textarea,select{width:100%;padding:10px;border-radius:6px;border:1px solid #112e1f;margin-bottom:12px;font-family:inherit}
    textarea{min-height:80px;resize:vertical}
    .currency-selector{text-align:right;margin-bottom:12px}
    .checkout-btn{display:block;width:100%;background:#112e1f;color:#F5E6CC;padding:14px;border-radius:6px;border:none;font-weight:700;cursor:pointer}
    .checkout-btn:hover{background:#0a1d14}

    /* order summary */
    .order-summary ul{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:12px}
    .order-item{display:flex;gap:12px;align-items:flex-start;justify-content:space-between;padding:10px;border-radius:8px;background:#F5E6CC; box-shadow:0 4px 10px rgba(0,0,0,0.2)}
    .order-item .left{flex:1 1 70%}
    .order-item .right{flex:0 0 150px;text-align:right}
    .order-item .title{font-weight:600}
    .order-item .meta{font-size:0.95rem;color:#334d3a;margin-top:6px}

    .order-item {flex-wrap: nowrap;}
  
    .order-item .left { min-width: 0;}
  
    .order-item .right { white-space: nowrap; flex-shrink: 0;}


    /* variant toggle */
    .variant-toggle{display:inline-flex;align-items:center;justify-content:center;width:30px;height:30px;border-radius:6px;border:1px solid #112e1f;background:#FFD6BA;color:#112e1f;cursor:pointer;padding:0;margin-left:8px}
    .variant-toggle svg{width:14px;height:14px;transition:transform .25s ease}
    .variant-toggle[aria-expanded="true"] svg{transform:rotate(180deg)}
    .variants-container {
      max-height: 0;
      overflow: hidden;
      transition: max-height .28s ease, padding .28s ease;
      margin-top: 8px;
      width: 100%;
      box-sizing: border-box;
      padding: 0; /* remove inner indent */
      border: none; /* remove border that narrows width */
    }

    .variants-container.show{max-height:500px;padding-top:8px;padding-bottom:8px}
    .variant-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      padding: 6px 8px;
      border-bottom: 1px dashed rgba(0,0,0,0.06);
      width: 100%;
      box-sizing: border-box;
    }
    
    .variant-attrs,
    .variant-price {
      white-space: nowrap;
    }
    
    .variant-attrs {
      font-size: 0.95rem;
      color: #334d3a;
      flex: 1;
    }
    
    .variant-price {
      font-weight: 600;
      text-align: right;
      flex-shrink: 0;
      min-width: auto;
      padding-left: 8px;
    }

    .subtotal{font-weight:700;text-align:right;margin-top:12px}
    .note{font-size:0.9rem;color:#666;margin-top:8px}

    /* FOOTER */
    footer { text-align:center; padding:20px; background:transparent; color:#112e1f; margin-top:60px; }

    /* Hide mobile cart by default (desktop) */
    .mobile-cart {
      display: none;
    }  
    
    /* responsive */
    @media(max-width:900px){.container{grid-template-columns:1fr}}

    @media (max-width:900px) {
      .header-right {
        position: absolute;
        top: 68px;
        right: 0;
        background: rgba(17,46,31,0.95);
        flex-direction: column;
        width: 200px;
        padding: 20px;
        display: none;
        border-radius: 0 0 0 10px;
        z-index: 1100;
      }
    
      .header-right.open {
        display: flex !important;
        flex-direction: column;
        gap: 12px;
      }
    
      .hamburger {
        display: block;
      }

  
      .brand-logo{height:clamp(40px,15vw,80px)}
      .brand-title{font-size:clamp(16px,7vw,22px)}
      .hero{height:40vh}
      .mobile-cart { display:flex; align-items:center; margin-right:10px; }
      .mobile-cart a { color:#FFD6BA; font-size:20px; position:relative; }
      .mobile-cart .cart-count { position:absolute; top:-8px; right:-8px; }
     }
    
    /* small blur loader & spinner (injected by script) */
    .fdv-blur-overlay{position:fixed;inset:0;z-index:9999;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(6px);background:rgba(0,0,0,0.45)}
    .fdv-blur-spinner{width:54px;height:54px;border:6px solid rgba(255,255,255,0.15);border-top:6px solid rgba(255,255,255,0.95);border-radius:50%;animation:fdv-spin 1s linear infinite}
    @keyframes fdv-spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}

    
  /* ---------------- Floating Support Button + Tooltip ---------------- */
  #floatingSupportBtn {
    position: fixed;
    right: 22px;
    bottom: 22px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: none;
    background: #112e1f;
    color: #fff;
    z-index: 10002;
    box-shadow: 0 8px 30px rgba(212,245,105,1);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px; /* enlarged icon */
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  #floatingSupportBtn:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 36px rgba(212,245,105,0.8);
    animation: glowPulse 1.5s infinite ease-in-out;
  }
  #floatingSupportBtn::after {
    content: "Support";
    position: absolute;
    bottom: 70px;
    left: 50%;
    transform: translateX(-50%) translateY(0);
    background: #112e1f;
    color: #FFD6BA;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease, transform 0.4s ease;
  }
  #floatingSupportBtn:hover::after {
    opacity: 1;
    transform: translateX(-50%) translateY(-6px);
  }
  @keyframes glowPulse {
    0%,100%{ box-shadow:0 8px 30px rgba(212,245,105,1);}
    50%{ box-shadow:0 12px 36px rgba(212,245,105,0.6);}
  }

/* ---------- Checkout Variants Dropdown ---------- */
.checkout-variants-toggle {
  background: transparent;
  border: 1px solid var(--fleur-green, #1a3c34);
  color: var(--fleur-green, #1a3c34);
  font-family: "Playfair Display", serif;
  font-size: 0.95rem;
  padding: 6px 14px;
  border-radius: 6px;
  margin-top: 6px;
  cursor: pointer;
  transition: all 0.25s ease;
}

.checkout-variants-toggle:hover {
  background: var(--fleur-green, #1a3c34);
  color: #fff;
}

/* Container for the variant list */
.checkout-variants-container {
  max-height: 0;
  overflow: hidden;
  opacity: 0;
  transition: all 0.35s ease;
  margin-top: 0;
}

/* When open */
.checkout-variants-container.open {
  max-height: 400px;
  opacity: 1;
  margin-top: 8px;
  width: 100%;
  box-sizing: border-box;
  padding: 0;
}


/* Each variant row */
.checkout-variant-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  background: rgba(26, 60, 52, 0.05); /* soft transparent green tint */
  padding: 8px 12px;
  margin-bottom: 6px;
  border-radius: 8px;
}

/* Variant text */
.checkout-variant-meta {
  font-family: "Playfair Display", serif;
  font-size: 0.9rem;
  color: var(--fleur-green, #1a3c34);
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .checkout-variants-toggle {
    font-size: 0.85rem;
    padding: 5px 12px;
  }
  .checkout-variant-meta {
    font-size: 0.85rem;
  }

  .order-item .title {
  font-size: 14px;
}
  .variant-row {
    width: 100%;
    justify-content: space-between;
    padding-right: 10px;
  }
  .variant-attrs {
    flex: 1;
    font-size: 0.9rem;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  .variant-price {
    flex-shrink: 0;
    font-size: 0.9rem;
    min-width: 70px;
    text-align: right;
  }
}

    
</style>
</head>
<body>
  <header class="site-header">
    <div style="display:flex;align-items:center;gap:14px">
      <img src="../asset/logo.png" alt="Fleur De Vie Logo" class="brand-logo">
      <div class="brand-title">Fleur De Vie</div>
    </div>

    <div class="mobile-cart">
    <a href="../cart.html"><i class="fa-solid fa-cart-shopping"></i><span class="cart-count" id="cartCountMobile">0</span></a>
  </div>
    
    <!-- Hamburger -->
    <button class="hamburger" id="hamburger-btn">
      <span></span><span></span><span></span>
    </button>
    <nav class="header-right" id="nav-menu">
      <a href="../index.html">Home</a>
      <a href="../about.html">About</a>
      <a href="../shop.html">Shop</a>
      <a href="../cart.html">Cart <span class="cart-count" id="cartCount">0</span></a>
      <a href="../contact.html">Contact</a>
      <a href="../trackorder.html">Track</a>
    </nav>
  </header>

  <section class="hero"><div class="hero-text"><h1>Checkout</h1></div></section>

  <section class="checkout">
    <div class="container">
      <!-- Billing Form -->
      <div class="checkout-form">
        <h2>Billing Details</h2>
        <div id="errorBanner" role="alert" style="display:none;background:rgba(255,50,50,0.08);padding:10px;border-radius:6px;margin-bottom:10px;color:#7a1a1a"></div>
        <form id="checkoutForm" autocomplete="off" onsubmit="return false;">
          <label for="name">Full Name</label>
          <input type="text" id="name" required>
          <label for="email">Email</label>
          <input type="email" id="email" required>
          <label for="phone">Phone</label>
          <input type="tel" id="phone" required>
          <label for="address">Address</label>
          <textarea id="address" required></textarea>
        </form>
      </div>

      <!-- Order Summary -->
      <div class="order-summary">
        <h2>Order Summary</h2>
        <div class="currency-selector" id="currencySelectorWrapper" style="display:none">
          <label for="currency">Currency:</label>
          <select id="currency">
            <option value="NGN">NGN</option>
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
            <option value="GBP">GBP</option>
          </select>
        </div>
        <ul id="orderItems" aria-live="polite"></ul>
        <div class="subtotal" id="orderSubtotal"></div>
        <div class="note">You will be redirected to payment after clicking Proceed to Payment.</div>
        <button id="payBtn" class="checkout-btn">Proceed to Payment</button>
      </div>
    </div>
  </section>

    <!-- Floating support button -->
<button id="floatingSupportBtn" aria-label="Support">
  <i class="fas fa-headset"></i>
</button>

  <footer><p>© 2025 Fleur De Vie</p></footer>

  <!-- Flutterwave -->
  <script src="https://checkout.flutterwave.com/v3.js"></script>

<!-- FULL UPDATED Fleur De Vie checkout script -->
<script type="module">
/* -------------------- FIREBASE IMPORTS -------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, serverTimestamp, query, where, getDocs
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

/* -------------------- CONFIG -------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyCuiZXHFYl1fVKnGwojavRvbekSBpkipJg",
  authDomain: "brandisby.firebaseapp.com",
  projectId: "brandisby",
  storageBucket: "brandisby.firebasestorage.app",
  messagingSenderId: "87213267039",
  appId: "1:87213267039:web:339e9fd49e3ad31f7423ea"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* -------------------- BLUR LOADER (no-flash) -------------------- */
(function installBlurLoader() {
  try {
    const overlay = document.createElement('div');
    overlay.className = 'fdv-blur-overlay';
    overlay.id = 'fdv-blur-overlay';
    overlay.setAttribute('aria-hidden','true');

    const spinner = document.createElement('div');
    spinner.className = 'fdv-blur-spinner';

    const label = document.createElement('div');
    label.textContent = 'Loading...';
    label.style.color = '#fff';
    label.style.marginTop = '10px';
    label.style.fontSize = '13px';
    label.style.fontFamily = 'system-ui, -apple-system, "Segoe UI", Roboto';

    const wrap = document.createElement('div');
    wrap.style.display = 'flex';
    wrap.style.flexDirection = 'column';
    wrap.style.alignItems = 'center';
    wrap.appendChild(spinner);
    wrap.appendChild(label);

    overlay.appendChild(wrap);
    document.documentElement.appendChild(overlay);

    const main = document.querySelector('main') || document.querySelector('body');
    if(main) main.style.opacity = '0';
  } catch(e){}
})();

function removeBlurLoaderAndReveal(){
  try {
    const overlay = document.getElementById('fdv-blur-overlay');
    if(overlay) overlay.remove();
    const main = document.querySelector('main') || document.querySelector('body');
    if(main) main.style.opacity = '1';
  } catch(e){}
}

/* -------------------- HELPERS -------------------- */
function safeParseJSON(v, fallback = null){ try { return JSON.parse(v || 'null') || fallback; } catch(e){ return fallback; } }
function escapeHtml(s){ if(s === undefined || s === null) return ''; return String(s).replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[ch])); }
function formatPrice(val, cur = 'NGN'){ try { const locale = {USD:'en-US',EUR:'de-DE',GBP:'en-GB',NGN:'en-NG'}[cur] || 'en-US'; const minimumFractionDigits = cur==='NGN'?0:2; return new Intl.NumberFormat(locale,{style:'currency',currency:cur, minimumFractionDigits}).format(Number(val||0)); } catch(e) { return `${cur} ${Number(val||0).toFixed(2)}`; } }
function showSpinner(on = true){
  try {
    let el = document.getElementById('fdv-runtime-spinner');
    if(on){
      if(!el){
        el = document.createElement('div');
        el.id = 'fdv-runtime-spinner';
        el.style.position = 'fixed';
        el.style.top = '20px';
        el.style.right = '20px';
        el.style.zIndex = '99999';
        el.style.padding = '8px';
        el.style.borderRadius = '20px';
        el.style.background = 'rgba(0,0,0,0.6)';
        el.style.color = '#fff';
        el.style.display = 'flex';
        el.style.alignItems = 'center';
        const inner = document.createElement('div');
        inner.style.width = '8px';
        inner.style.height = '8px';
        inner.style.borderRadius = '50%';
        inner.style.background = '#FFD6BA';
        inner.style.marginRight = '8px';
        el.appendChild(inner);
        const txt = document.createElement('div'); txt.textContent = 'Processing...';
        el.appendChild(txt);
        document.body.appendChild(el);
      }
      el.style.display = 'flex';
    } else {
      if(el) el.style.display = 'none';
    }
  } catch(e){ console.warn(e); }
}
function showError(msg){
  const el = document.getElementById('errorBanner');
  if(!el) { if(msg) alert(msg); return; }
  if(!msg){ el.style.display='none'; el.textContent=''; } else { el.style.display='block'; el.textContent = msg; window.scrollTo({top:0, behavior:'smooth'}); }
}

/* -------------------- DOM & STATE -------------------- */
const STORAGE_KEY = 'cart';
const CURRENCY_KEY = 'currency';
const cartCountElem = document.getElementById('cartCount');
const orderItemsEl = document.getElementById('orderItems');
const orderSubtotalEl = document.getElementById('orderSubtotal');
const payBtn = document.getElementById('payBtn');
const currencySelect = document.getElementById('currency');
const currencyWrapper = document.getElementById('currencySelectorWrapper');
const nameInput = document.getElementById('name');
const emailInput = document.getElementById('email');
const phoneInput = document.getElementById('phone');
const addressInput = document.getElementById('address');
const cartCountMobileElem = document.getElementById('cartCountMobile');


let productCache = {};
let selectedCurrency = localStorage.getItem(CURRENCY_KEY) || 'NGN';
let rawCart = safeParseJSON(localStorage.getItem(STORAGE_KEY), []) || [];
// mergeCartItems is declared below; set rawCart after function defined
const urlParams = new URLSearchParams(window.location.search);
const quoteId = urlParams.get('quoteId') || null;
const orderId = urlParams.get('orderId') || null;

let activeQuoteRaw = null;
let activeOrderRaw = null;
let quote = null;
let isPaidOrder = false;

/* flags to prevent duplicate renders (fix flicker) */
let paidUIRenderedFor = null;
let paidRenderInProgress = false;

/* -------------------- UTIL: cart helpers -------------------- */
/* -------------------- CART COUNT / MODE-AWARE SYNC (desktop + mobile) -------------------- */
function totalQtyFromCartArray(arr) {
  try { return (arr || []).reduce((s, i) => s + Number(i.quantity || 0), 0); } 
  catch (e) { return 0; }
}

function totalQtyFromQuoteNormalized(q) {
  try { 
    return (q && Array.isArray(q.items)) 
      ? q.items.reduce((s, i) => s + Number(i.totalQuantity || 0), 0) 
      : 0; 
  } catch (e) { return 0; }
}

/* FIXED & CONSISTENT mergeCartItems */
function mergeCartItems(cartArr) {
  const merged = [];
  (cartArr || []).forEach(item => {
    const keyMatch = i => i.id === item.id && (i.color || '') === (item.color || '') && (i.size || '') === (item.size || '');
    const idx = merged.findIndex(keyMatch);
    if (idx === -1) merged.push({ ...item });
    else merged[idx].quantity = Number(merged[idx].quantity || 0) + Number(item.quantity || 0);
  });
  return merged;
}

/* compute/update cart count for desktop and mobile icons */
function computeAndUpdateCartCount() {
  try {
    const rawCart = safeParseJSON(localStorage.getItem(STORAGE_KEY), []) || [];
    const mergedCart = mergeCartItems(rawCart);
    const cartQty = totalQtyFromCartArray(mergedCart);

    const isUnpaidQuoteView = (!isPaidOrder && quote && Array.isArray(quote.items) && quote.items.length > 0 && !quote._isOrder && !quote._paidFlag);

    let displayCount = cartQty;
    if (isUnpaidQuoteView) {
      const quoteQty = totalQtyFromQuoteNormalized(quote);
      if (quoteId) displayCount = Number(quoteQty || 0) + Number(cartQty || 0);
      else displayCount = cartQty;
    }

    // Update desktop cart count
    if (cartCountElem) cartCountElem.textContent = String(displayCount || 0);
    // Update mobile cart count
    if (cartCountMobileElem) cartCountMobileElem.textContent = String(displayCount || 0);

  } catch (e) {
    if (cartCountElem) cartCountElem.textContent = '0';
    if (cartCountMobileElem) cartCountMobileElem.textContent = '0';
  }
}

/* react to storage changes from other tabs */
window.addEventListener('storage', (e) => {
  if (e.key === STORAGE_KEY || e.key === CURRENCY_KEY || e.key === 'paidQuoteInfo') {
    computeAndUpdateCartCount();
  }
  if (e.key === 'paidQuoteInfo') {
    const paid = safeParseJSON(localStorage.getItem('paidQuoteInfo'), null);
    if (paid && paid.verified) syncPaidQuoteUI().catch(() => { });
  }
});

/* Initialize on load */
document.addEventListener('DOMContentLoaded', computeAndUpdateCartCount);


/* -------------------- PRODUCT HELPERS (fetch product docs for fleurdevie) -------------------- */
async function fetchProductData(productId){
  try {
    if(productCache[productId]) return productCache[productId];
    const snap = await getDoc(doc(db, "brands", "fleurdevie", "products", productId));
    if(snap.exists()){ 
      productCache[productId] = snap.data(); 
      return productCache[productId]; 
    }
  } catch(e){ 
    console.warn("fetchProductData failed", e); 
  }
  return null;
}

async function buildQuoteFromCart(){
  rawCart = mergeCartItems(rawCart || []);
  const byProduct = new Map();
  rawCart.forEach(r=> { 
    if(!byProduct.has(r.id)) byProduct.set(r.id, []); 
    byProduct.get(r.id).push(r); 
  });
  const ids = Array.from(byProduct.keys());
  const pdPromises = ids.map(id => fetchProductData(id).then(d=>[id,d]));
  const pd = await Promise.all(pdPromises);
  const productsMap = Object.fromEntries(pd.map(([id,doc])=>[id,doc]));
  const items = [];

  for(const id of ids){
    const rows = byProduct.get(id) || [];
    const productDoc = productsMap[id] || null;
    const image = productDoc?.images?.[0] || productDoc?.imageUrl || rows[0]?.imageUrl || '';
    const name = productDoc?.name || rows[0]?.name || 'Product';

    const variants = rows.map(r=>{
      const qty = Number(r.quantity||1);
      const unitPrices = {
        NGN: Number(productDoc?.priceNGN ?? r.price ?? 0),
        USD: Number(productDoc?.priceUSD ?? 0),
        EUR: Number(productDoc?.priceEUR ?? 0),
        GBP: Number(productDoc?.priceGBP ?? 0)
      };
      return { 
        id: r.id||id, 
        color:r.color||'', 
        size:r.size||'', 
        quantity:qty, 
        unitPrices, 
        linePrices:{
          NGN: unitPrices.NGN*qty, 
          USD: unitPrices.USD*qty, 
          EUR: unitPrices.EUR*qty, 
          GBP: unitPrices.GBP*qty
        } 
      };
    });

    const totalQty = variants.reduce((s,v)=>s+v.quantity,0);
    const totalPrices = { NGN:0, USD:0, EUR:0, GBP:0 };
    variants.forEach(v=>{
      totalPrices.NGN += v.linePrices.NGN||0; 
      totalPrices.USD += v.linePrices.USD||0; 
      totalPrices.EUR += v.linePrices.EUR||0; 
      totalPrices.GBP += v.linePrices.GBP||0; 
    });

    items.push({ 
      productId:id, 
      name, 
      image, 
      totalQuantity: totalQty, 
      totalPrices, 
      variants, 
      description: productDoc?.description||'' 
    });
  }

  return { items };
}

/* ✅ Add this AFTER buildQuoteFromCart() closes */
async function renderCheckoutItems() {
  const checkoutList = document.getElementById('checkoutList');
  if (!checkoutList) return;

  const { items } = await buildQuoteFromCart();
  const currency = localStorage.getItem('currency') || 'NGN';
  checkoutList.innerHTML = '';

  items.forEach(item => {
    const hasVariantMeta =
      item.variants.length > 1 ||
      item.variants.some(v => v.color || v.size);

    const div = document.createElement('div');
    div.className = 'checkout-item';
    div.innerHTML = `
      <div class="checkout-item-inner" data-id="${item.productId}">
        <img src="${item.image}" alt="${item.name}" class="checkout-thumb">

        <div class="checkout-details">
          <h3 class="checkout-name">${escapeHtml(item.name)}</h3>
          <div class="checkout-price">${formatPrice(item.totalPrices[currency], currency)}</div>

          ${hasVariantMeta ? `
            <button class="checkout-variants-toggle">View Choices</button>
            <div class="checkout-variants-container">
              ${item.variants.map(v => `
                <div class="checkout-variant-row">
                  <div class="checkout-variant-meta">
                    ${[v.color, v.size].filter(Boolean).join(' / ')} ×${v.quantity}
                  </div>
                </div>`).join('')}
            </div>
          ` : ''}
        </div>
      </div>
    `;
    checkoutList.appendChild(div);
  });

  // toggle dropdown open/close
  checkoutList.addEventListener('click', e => {
    const btn = e.target.closest('.checkout-variants-toggle');
    if (!btn) return;
    const container = btn.nextElementSibling;
    const open = container.classList.toggle('open');
    btn.textContent = open ? 'Hide Choices' : 'View Choices';
  });
}

// run after DOM is ready
document.addEventListener('DOMContentLoaded', renderCheckoutItems);

  
/* -------------------- NORMALIZERS (quote/order) -------------------- */
function normalizeQuoteItems(rawQuote){
  const arr = Array.isArray(rawQuote.items) ? rawQuote.items : [];
  const items = arr.map(ci => {
    if(Array.isArray(ci.variants) && ci.variants.length){
      const variants = ci.variants.map(v => {
        const qty = Number(v.qty || v.quantity || 0);
        const unitPrices = {
          NGN: Number(v.priceNGN ?? v.price ?? 0),
          USD: Number(v.priceUSD ?? 0),
          EUR: Number(v.priceEUR ?? 0),
          GBP: Number(v.priceGBP ?? 0)
        };
        return {
          id: v.id || ci.id || '',
          color: v.color||'',
          size: v.size||'',
          quantity: qty,
          unitPrices,
          linePrices: { NGN: unitPrices.NGN*qty, USD: unitPrices.USD*qty, EUR: unitPrices.EUR*qty, GBP: unitPrices.GBP*qty }
        };
      });
      return {
        productId: ci.id || '',
        name: ci.name || '',
        image: (ci.image && ci.image !== '../asset/placeholder.jpg') ? ci.image : null,
        totalQuantity: variants.reduce((s,a)=>s+(a.quantity||0),0),
        totalPrices: {
          NGN: variants.reduce((s,a)=>s+(a.linePrices.NGN||0),0),
          USD: variants.reduce((s,a)=>s+(a.linePrices.USD||0),0),
          EUR: variants.reduce((s,a)=>s+(a.linePrices.EUR||0),0),
          GBP: variants.reduce((s,a)=>s+(a.linePrices.GBP||0),0)
        },
        variants,
        description: ci.desc || ci.description || ''
      };
    } else {
      const qty = Number(ci.qty || ci.quantity || 1);
      const unitPrices = { NGN: Number(ci.priceNGN ?? ci.price ?? 0), USD: Number(ci.priceUSD ?? 0), EUR: Number(ci.priceEUR ?? 0), GBP: Number(ci.priceGBP ?? 0) };
      return {
        productId: ci.id || '',
        name: ci.name || '',
        image: (ci.image && ci.image !== '../asset/placeholder.jpg') ? ci.image : null,
        totalQuantity: qty,
        totalPrices: { NGN: unitPrices.NGN*qty, USD: unitPrices.USD*qty, EUR: unitPrices.EUR*qty, GBP: unitPrices.GBP*qty },
        variants: [{ id:ci.id||'', color:'', size:'', quantity: qty, unitPrices, linePrices: { NGN: unitPrices.NGN*qty, USD: unitPrices.USD*qty, EUR: unitPrices.EUR*qty, GBP: unitPrices.GBP*qty } }],
        description: ci.desc || ci.description || ''
      };
    }
  });
  const normalized = { items };
  normalized._isOrder = false;
  normalized._paidFlag = (rawQuote && (rawQuote.status || '').toLowerCase() === 'paid') || false;
  return normalized;
}
function normalizeOrderItems(items){
  const normalized = (items||[]).map(it => ({
    productId: it.id || '',
    name: it.name || it.productName || '',
    image: (it.image && it.image !== '../asset/placeholder.jpg') ? it.image : null,
    totalQuantity: Number(it.qty || it.quantity || it.totalQuantity) || 1,
    description: it.desc || it.description || '',
    totalPrices: it.totalPrices || it.linePrices || {},
    variants: it.variants || []
  }));
  const result = { items: normalized };
  result._isOrder = true;
  result._paidFlag = true;
  return result;
}

/* -------------------- RENDER (keeps Fleur De Vie DOM & styles) -------------------- */
function renderOrderFromQuoteNormalized(quoteNormalized, currency='NGN', paid=false){
  if(!orderItemsEl || !orderSubtotalEl) return;
  orderItemsEl.innerHTML = '';
  if(!quoteNormalized || !Array.isArray(quoteNormalized.items)) {
    orderItemsEl.innerHTML = '<li class="small-note">No items</li>';
    orderSubtotalEl.textContent = `Subtotal: —`;
    computeAndUpdateCartCount();
    return;
  }
  let subtotal = 0;
  quoteNormalized.items.forEach((item, idx) => {
    const valueFromTotals = Number((item.totalPrices && (item.totalPrices[currency] ?? null)) ?? 0) || 0;
    const fallbackFromVariants = Array.isArray(item.variants) ? item.variants.reduce((s,v)=> s + Number((v.linePrices && (v.linePrices[currency] ?? null)) ?? (Number(v.unitPrices?.[currency]||0)*Number(v.quantity||0))), 0) : 0;
    const finalValue = valueFromTotals || fallbackFromVariants || 0;
    subtotal += finalValue;

    const li = document.createElement('li');
    li.className = 'order-item';

    const left = document.createElement('div');
    left.className = 'left';

    const headerWrapper = document.createElement('div');
    headerWrapper.style.display = 'flex';
    headerWrapper.style.alignItems = 'center';
    headerWrapper.style.gap = '10px';

    if(item.image){
      const img = document.createElement('img');
      img.src = item.image;
      img.alt = item.name;
      img.style.width = '56px';
      img.style.height = '56px';
      img.style.objectFit = 'cover';
      img.style.borderRadius = '6px';
      img.style.border = '1px solid rgba(0,0,0,0.06)';
      headerWrapper.appendChild(img);
    }

    const textWrap = document.createElement('div');
    const titleDiv = document.createElement('div');
    titleDiv.className = 'title';
    titleDiv.textContent = `${item.name} (x${item.totalQuantity})`;
    textWrap.appendChild(titleDiv);

    if(Array.isArray(item.variants) && item.variants.length > 1){
      const info = document.createElement('div');
      info.className = 'meta';
      info.textContent = 'Multiple options selected';
      textWrap.appendChild(info);
    } else {
      const singleV = item.variants && item.variants[0];
      if(singleV && (singleV.color || singleV.size)){
        const info = document.createElement('div');
        info.className = 'meta';
        info.textContent = `${singleV.color ? 'Color: ' + singleV.color : ''}${singleV.color && singleV.size ? ' · ' : ''}${singleV.size ? 'Size: ' + singleV.size : ''}`;
        textWrap.appendChild(info);
      }
    }
    headerWrapper.appendChild(textWrap);
    left.appendChild(headerWrapper);

    // variants container (hidden by default)
    if(Array.isArray(item.variants) && item.variants.length > 1){
      const toggle = document.createElement('button');
      toggle.className = 'variant-toggle';
      toggle.type = 'button';
      toggle.setAttribute('aria-expanded','false');
      toggle.title = 'View variants';
      toggle.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>`;
      headerWrapper.appendChild(toggle);

      const variantsContainer = document.createElement('div');
      variantsContainer.className = 'variants-container';
      item.variants.forEach(v=>{
        const row = document.createElement('div');
        row.className = 'variant-row';
        const leftRow = document.createElement('div');
        leftRow.style.display = 'flex';
        leftRow.style.gap = '8px';
        leftRow.style.alignItems = 'center';
        const attrs = document.createElement('div');
        attrs.className = 'variant-attrs';
        attrs.innerHTML = `${[v.color, v.size].filter(Boolean).join(' / ')} <span style="color:#556b59">×${v.quantity}</span>`;
        leftRow.appendChild(attrs);
        const rightPrice = document.createElement('div');
        rightPrice.className = 'variant-price';
        const variantLinePrice = Number((v.linePrices && (v.linePrices[currency] ?? null)) ?? (Number(v.unitPrices?.[currency]||0)*Number(v.quantity||0)));
        rightPrice.textContent = formatPrice(variantLinePrice, currency);
        row.appendChild(leftRow);
        row.appendChild(rightPrice);
        variantsContainer.appendChild(row);
      });
      left.appendChild(variantsContainer);

      toggle.addEventListener('click', () => {
        const isShown = variantsContainer.classList.toggle('show');
        toggle.setAttribute('aria-expanded', isShown ? 'true' : 'false');
      });
    }

    const right = document.createElement('div');
    right.className = 'right';
    right.style.minWidth = '120px';
    right.style.textAlign = 'right';
    right.innerHTML = `<div style="font-weight:600">${formatPrice(finalValue, currency)}</div>`;

    li.appendChild(left);
    li.appendChild(right);
    orderItemsEl.appendChild(li);
  });

  orderSubtotalEl.textContent = `Subtotal: ${formatPrice(subtotal, selectedCurrency)}`;
  computeAndUpdateCartCount();
}

/* -------------------- FILL BILLING -------------------- */
function fillBillingFields(data){
  if(nameInput) nameInput.value = data.name || data.customer || '';
  if(emailInput) emailInput.value = data.email || data.customerEmail || '';
  if(phoneInput) phoneInput.value = data.phone || data.phoneNumber || '';
  if(addressInput) addressInput.value = data.address || data.shippingAddress || '';
}

/* -------------------- UI CONFIG (cart / quote unpaid / paid) -------------------- */
function configureCheckoutUI(type, opts = {}){
  try {
    const disableCurrency = (val) => {
      if(currencySelect) currencySelect.disabled = val;
      if(currencyWrapper) {
        currencyWrapper.style.opacity = val ? '0.6' : '1';
        currencyWrapper.style.pointerEvents = val ? 'none' : 'auto';
        currencyWrapper.style.display = (type === 'quote-unpaid' ? 'block' : currencyWrapper.style.display || (type === 'cart' ? 'none' : 'block'));
      }
    };
    const billingFields = [nameInput, emailInput, phoneInput, addressInput].filter(Boolean);
    const setBillingDisabled = (v) => billingFields.forEach(f => f.disabled = !!v);

    if(type === 'cart'){
      disableCurrency(true);
      setBillingDisabled(false);
      if(payBtn) { payBtn.textContent = 'Proceed to Payment'; payBtn.disabled = false; payBtn.dataset.processing = '0'; }
    }

    if(type === 'quote-unpaid'){
      disableCurrency(false);
      setBillingDisabled(false);
      if(payBtn) { payBtn.textContent = 'Proceed to Payment'; payBtn.disabled = false; payBtn.dataset.processing = '0'; }
    }

    if(type === 'quote-paid' || type === 'order-paid'){
      disableCurrency(true);
      setBillingDisabled(true);
      if(payBtn) { payBtn.textContent = 'Paid ✅'; payBtn.disabled = true; payBtn.classList.add('paid-state'); }
      // show tracking ref if provided (hero h2 color)
      if(opts.trackingRef){
        let heroH2Color = null;
        try {
          const heroH2 = document.querySelector('.hero h2');
          if(heroH2) heroH2Color = window.getComputedStyle(heroH2).color;
        } catch(e){}
        const container = document.querySelector('.hero-text') || document.querySelector('.hero');
        if(container){
          let successElem = document.getElementById('paidSuccessMessage');
          if(!successElem){
            successElem = document.createElement('p');
            successElem.id = 'paidSuccessMessage';
            successElem.style.marginTop = '12px';
            successElem.style.fontWeight = '600';
            successElem.style.fontSize = '18px';
            container.appendChild(successElem);
          }
          successElem.textContent = 'Your order has been paid successfully.';
          if(heroH2Color) successElem.style.color = heroH2Color;

          let trackingElem = document.getElementById('trackingRefDisplay');
          if(!trackingElem){
            trackingElem = document.createElement('p');
            trackingElem.id = 'trackingRefDisplay';
            trackingElem.style.marginTop = '6px';
            trackingElem.style.fontWeight = '600';
            trackingElem.style.fontSize = '16px';
            container.appendChild(trackingElem);
          }
          trackingElem.textContent = `Order Reference: ${opts.trackingRef}`;
          if(heroH2Color) trackingElem.style.color = heroH2Color;
        }
      }
    }
  } catch(e){ console.warn('configureCheckoutUI error', e); }
}

/* -------------------- BUILD NORMALIZED FROM FS DOC -------------------- */
function buildNormalizedFromFirestoreDoc(docData){
  const itemsRaw = Array.isArray(docData.items) ? docData.items : [];
  const normalizedItems = itemsRaw.map(raw => {
    const qty = Number(raw.qty ?? raw.quantity ?? raw.totalQuantity ?? 0) || 0;
    const unitPrices = {
      NGN: Number(raw.priceNGN ?? raw.price ?? 0),
      USD: Number(raw.priceUSD ?? 0),
      EUR: Number(raw.priceEUR ?? 0),
      GBP: Number(raw.priceGBP ?? 0)
    };
    const linePrices = {
      NGN: unitPrices.NGN * qty,
      USD: unitPrices.USD * qty,
      EUR: unitPrices.EUR * qty,
      GBP: unitPrices.GBP * qty
    };
    return {
      productId: raw.productId || raw.id || '',
      name: raw.name || raw.productName || raw.title || '',
      image: (raw.image && raw.image !== '../asset/placeholder.jpg') ? raw.image : null,
      totalQuantity: qty,
      totalPrices: linePrices,
      variants: [{ id: raw.id || '', color: raw.color || '', size: raw.size || '', quantity: qty, unitPrices, linePrices }],
      description: raw.description || raw.desc || ''
    };
  });
  return { items: normalizedItems, _isOrder: true, _paidFlag: true };
}

/* -------------------- RENDER PAID UI FROM DOC (guarded) -------------------- */
function renderPaidUIFromDoc(docData){
  try {
    const docKey = (docData && (docData.orderId || docData.trackingRef || docData.id)) || (quoteId || orderId) || 'paid';
    if(paidUIRenderedFor && paidUIRenderedFor === docKey) return;
    if(paidRenderInProgress) return;
    paidRenderInProgress = true;

    // choose currency: doc -> paidQuoteInfo -> selectedCurrency
    const paidQuoteInfoLocal = safeParseJSON(localStorage.getItem('paidQuoteInfo'), null);
    const docCurrency = (docData && docData.currency) ? String(docData.currency).toUpperCase() : (paidQuoteInfoLocal && paidQuoteInfoLocal.currency ? String(paidQuoteInfoLocal.currency).toUpperCase() : selectedCurrency);
    selectedCurrency = docCurrency || selectedCurrency;
    if(currencySelect && currencyWrapper){
      try { currencySelect.value = selectedCurrency; } catch(e){}
      try { currencySelect.disabled = true; currencyWrapper.style.opacity = 0.6; currencyWrapper.style.pointerEvents = 'none'; } catch(e){}
    }

    // Normalize items from doc if present
    const normalized = buildNormalizedFromFirestoreDoc(docData);
    quote = normalized;
    quote._isOrder = true;
    quote._paidFlag = true;
    isPaidOrder = true;

    // render items & subtotal using the doc currency
    renderOrderFromQuoteNormalized(normalized, selectedCurrency, true);

    // fill billing
    fillBillingFields({
      name: docData.name || docData.customer || docData.customerName || '',
      email: docData.email || docData.customerEmail || '',
      phone: docData.phone || docData.phoneNumber || docData.customerPhone || '',
      address: docData.address || docData.shippingAddress || docData.shipping || docData.addressLine || ''
    });

    if(payBtn){ payBtn.textContent = 'Paid ✅'; payBtn.disabled = true; payBtn.classList.add('paid-state'); }

    // UI read-only + hero tracking ref
    configureCheckoutUI(orderId ? 'order-paid' : 'quote-paid', { trackingRef: docData.trackingRef || docData.orderId || docData.trackingRef });

    // persist minimal info locally
    try {
      localStorage.setItem('paidQuoteInfo', JSON.stringify({
        quoteId: docData.id || null,
        currency: selectedCurrency,
        billing: { name: docData.name || docData.customer || '', email: docData.email || '', phone: docData.phone || docData.phoneNumber || '', address: docData.address || docData.shippingAddress || '' },
        trackingRef: docData.trackingRef || docData.orderId || null,
        verified: true
      }));
    } catch(e){}

    paidUIRenderedFor = docKey;
    paidRenderInProgress = false;
    computeAndUpdateCartCount();
  } catch(e){
    paidRenderInProgress = false;
    console.error('renderPaidUIFromDoc failed', e);
  }
}

/* -------------------- SYNC PAID QUOTE ON LOAD (improved: check orders by source) -------------------- */
async function syncPaidQuoteUI(){
  const paidQuoteInfo = safeParseJSON(localStorage.getItem('paidQuoteInfo'), null);
  if(!paidQuoteInfo) { removeBlurLoaderAndReveal(); return; }

  // Quick initial render from local storage so UI isn't blank
  renderPaidUIFromDoc({
    id: paidQuoteInfo.quoteId,
    trackingRef: paidQuoteInfo.trackingRef,
    currency: paidQuoteInfo.currency,
    name: paidQuoteInfo.billing?.name,
    email: paidQuoteInfo.billing?.email,
    phone: paidQuoteInfo.billing?.phone,
    address: paidQuoteInfo.billing?.address,
    items: []
  });
  configureCheckoutUI(quoteId ? 'quote-paid' : 'order-paid', { trackingRef: paidQuoteInfo.trackingRef });

  try {
    if(paidQuoteInfo.quoteId){
      // First try: find an order that references this quote (source == quote:<id>)
      try {
        const ordersColl = collection(db, "brands", "fleurdevie", "orders");
        const q = query(ordersColl, where("source", "==", `quote:${paidQuoteInfo.quoteId}`), where("status", "in", ["paid", "Paid", "PAID"]));
        const snap = await getDocs(q);
        if(snap && !snap.empty){
          const oDoc = snap.docs[0].data(); oDoc.id = snap.docs[0].id;
          renderPaidUIFromDoc(oDoc);
          removeBlurLoaderAndReveal();
          return;
        }
      } catch(err){
        // ignore and fall back to reading quote or stored info
        console.warn('order lookup by source failed', err);
      }

      // fallback: try reading the quotes doc and show it
      try {
        const qSnap = await getDoc(doc(db, "brands", "fleurdevie", "quotes", paidQuoteInfo.quoteId));
        if(qSnap && qSnap.exists()){
          const qData = qSnap.data(); qData.id = qSnap.id;
          renderPaidUIFromDoc(qData);
          removeBlurLoaderAndReveal();
          return;
        }
      } catch(e){
        console.error('syncPaidQuoteUI quote read failed', e);
        removeBlurLoaderAndReveal();
        showError('Unable to verify quote details. Contact support.');
        return;
      }
    }
    removeBlurLoaderAndReveal();
  } catch(e){ console.error('syncPaidQuoteUI failed', e); removeBlurLoaderAndReveal(); }
}

/* -------------------- ORDER SAVE (persist billing into order doc) -------------------- */
function generateOrderReference(email, orderId, txRef){
  const rand = () => Math.random().toString(36).substring(2,6).toUpperCase();
  const now = new Date();
  const day = String(now.getDate()).padStart(2,'0');
  const month = now.toLocaleString('en',{month:'short'}).toUpperCase();
  const year = String(now.getFullYear()).slice(-2);
  const emailPrefix = email ? email.split('@')[0].slice(0,3).toUpperCase() : "FV";
  const shortTx = txRef ? String(txRef).slice(-4).toUpperCase() : rand();
  return `${emailPrefix}-${day}${month}${year}-${shortTx}`;
}

async function persistPaidOrder(orderData, txRef) {
  try {
    const trackingRef = generateOrderReference(orderData.email, orderData.id || "", txRef);
    const docRef = doc(db, "brands", "fleurdevie", "orders", trackingRef);
    const payload = {
      ...orderData,
      name: orderData.name || orderData.customer || '',
      email: orderData.email || '',
      phone: orderData.phone || '',
      address: orderData.address || '',
      currency: orderData.currency || selectedCurrency,
      items: orderData.items || [],
      total: orderData.total || 0,
      status: "paid",
      trackingRef,
      createdAt: serverTimestamp(),
      verifiedAt: serverTimestamp(),
      paidAt: serverTimestamp()
    };
    await setDoc(docRef, payload);

    // Update related quote if exists
    if(orderData.source && String(orderData.source).startsWith('quote:')){
      const qid = String(orderData.source).split('quote:')[1];
      if(qid){
        try {
          await updateDoc(doc(db, "brands", "fleurdevie", "quotes", qid), {
            status: "Paid",
            orderId: trackingRef,
            paidAt: serverTimestamp(),
            trackingRef
          });
        } catch(e){}
      }
    }
    return { orderId: trackingRef, trackingRef };
  } catch(e){
    console.error("persistPaidOrder failed", e);
    return null;
  }
}

/* -------------------- PAYMENT (Flutterwave) -------------------- */
const FLW_PUBLIC_KEY = "FLWPUBK_TEST-07eb9d2da345c08dc4d54278c3bc86f7-X";
const SERVERLESS_VERIFY = `${window.location.origin}/api/verify`;

async function fetchWithRetry(url, options={}, retries=1, backoff=500){
  try { const r = await fetch(url, options); if(!r.ok) throw new Error('HTTP '+r.status); return r; }
  catch(err){ if(retries>0){ await new Promise(res=>setTimeout(res, backoff)); return fetchWithRetry(url, options, retries-1, Math.round(backoff*1.5)); } throw err; }
}
async function verifyPayment(payload){
  try {
    const opts = { method: 'POST', headers: {'Content-Type':'application/json','Connection':'close'}, body: JSON.stringify(payload), cache:'no-store', mode:'cors', credentials:'omit', keepalive:true };
    const res = await fetchWithRetry(SERVERLESS_VERIFY, opts, 1);
    return await res.json();
  } catch(e){ console.error('verifyPayment error', e); throw e; }
}

async function initiatePaymentFlow(ev){
  if(ev && ev.preventDefault) ev.preventDefault();
  if(isPaidOrder) return;
  showError('');

  const name = (nameInput?.value||'').trim();
  const email = (emailInput?.value||'').trim();
  const phone = (phoneInput?.value||'').trim();
  const address = (addressInput?.value||'').trim();
  if(!name) return showError('Name is required.');
  if(!/^\S+@\S+\.\S+$/.test(email)) return showError('Please provide a valid email.');
  if(!phone) return showError('Phone is required.');
  if(!address) return showError('Address is required.');
  if(!quote || !Array.isArray(quote.items) || quote.items.length === 0) return showError('Cart is empty.');

  let subtotal = 0;
  quote.items.forEach(it => { subtotal += Number(it.totalPrices?.[selectedCurrency] ?? 0); });
  if(subtotal <= 0) return showError('Subtotal is zero. Cannot proceed.');

  if(payBtn?.dataset.processing === '1') return;
  if(payBtn){ payBtn.dataset.processing = '1'; payBtn.disabled = true; }

  showSpinner(true);

  const baseOrder = {
    name, email, phone, address,
    currency: selectedCurrency,
    items: quote.items,
    total: subtotal,
    status: 'placed',
    source: quoteId ? `quote:${quoteId}` : 'cart',
    createdAt: new Date().toISOString()
  };

  const txRef = 'fleurdevie_' + Date.now();
  let paymentCallbackHandled = false;

  async function finalizeAfterSuccess(verifyResp){
    try {
      const saved = await persistPaidOrder(baseOrder, txRef);
      const finalOrderId = saved?.orderId || null;
      const trackingRef = saved?.trackingRef || generateOrderReference(baseOrder.email, finalOrderId||'', txRef);

      if(!quoteId) localStorage.removeItem(STORAGE_KEY);

      const active = { ...baseOrder, id: finalOrderId, orderId: finalOrderId, status: 'paid', trackingRef };
      activeOrderRaw = active;
      quote = { items: active.items || [] };
      quote._isOrder = true;
      quote._paidFlag = true;
      isPaidOrder = true;

      renderPaidUIFromDoc(active);

      try {
        localStorage.setItem('paidQuoteInfo', JSON.stringify({
          quoteId: quoteId || null,
          currency: selectedCurrency,
          billing: { name: active.name, email: active.email, phone: active.phone, address: active.address },
          trackingRef,
          verified: true
        }));
      } catch(e){}

      try {
        localStorage.setItem('lastOrder_fleurdevie', JSON.stringify({
          id: finalOrderId,
          trackingRef,
          name: active.name,
          email: active.email,
          phone: active.phone,
          address: active.address,
          currency: selectedCurrency,
          total: subtotal,
          items: quote.items,
          status: 'paid',
          verified: true,
          createdAt: new Date().toISOString()
        }));
      } catch(e){}

      showSpinner(false);

      // redirect exactly as requested (no params)
      window.location.assign('thankyou.html');
    } catch(e){
      console.error('finalizeAfterSuccess error', e);
      showSpinner(false);
      showError('Payment verified but finalisation failed. Contact support with tx_ref: ' + txRef);
      if(payBtn){ payBtn.disabled = false; payBtn.dataset.processing = '0'; }
    }
  }

  const fwConfig = {
    public_key: FLW_PUBLIC_KEY,
    tx_ref: txRef,
    amount: Number(subtotal),
    currency: selectedCurrency,
    customer: { email: baseOrder.email, phonenumber: baseOrder.phone, name: baseOrder.name },
    customizations: { title: "Fleur De Vie", description: "Order Payment", logo: "../logo.png" },

    callback: async function(data){
      if(paymentCallbackHandled) return;
      paymentCallbackHandled = true;
      showSpinner(true);
      try {
        const flwId = data?.data?.id || data.id || data.transaction_id || null;
        if(!flwId) throw new Error('Missing transaction ID from Flutterwave');
        const payload = { transaction_id: flwId, tx_ref: data.tx_ref || txRef, expectedAmount: subtotal, currency: selectedCurrency, orderData: baseOrder, quoteId: quoteId || null };
        const verifyResp = await verifyPayment(payload);
        if(verifyResp && ((verifyResp.status === 'success') || (verifyResp.success === true) || (verifyResp.verified === true) || (verifyResp.data?.status === 'successful'))){
          await finalizeAfterSuccess(verifyResp);
        } else {
          showSpinner(false);
          showError('Payment verification failed. Contact support with tx_ref: ' + txRef);
          if(payBtn){ payBtn.disabled = false; payBtn.dataset.processing = '0'; }
        }
      } catch(e){
        console.error('Verification error', e);
        showSpinner(false);
        showError('Payment succeeded but could not be verified. Contact support.');
        if(payBtn){ payBtn.disabled = false; payBtn.dataset.processing = '0'; }
      }
    },

    onclose: function(){
      if(paymentCallbackHandled) return;
      paymentCallbackHandled = true;
      showSpinner(false);
      showError('Payment was cancelled. Please complete your checkout.');
      if(payBtn){ payBtn.disabled = false; payBtn.dataset.processing = '0'; }
    }
  };

  try { FlutterwaveCheckout(fwConfig); }
  catch(err){ showSpinner(false); if(payBtn){ payBtn.disabled = false; payBtn.dataset.processing = '0'; } console.error('Flutterwave failed', err); showError('Payment gateway unavailable. Try again later.'); }

  // Poll fallback verification
  let attempts = 0; const maxAttempts = 6;
  const poll = setInterval(async ()=>{
    if(paymentCallbackHandled) return clearInterval(poll);
    attempts++;
    try {
      const res = await verifyPayment({ tx_ref: txRef, orderData: baseOrder, expectedAmount: subtotal, currency: selectedCurrency });
      if(res && ((res.status === 'success') || (res.success === true) || (res.verified === true) || (res.data?.status === 'successful'))){
        clearInterval(poll); paymentCallbackHandled = true; await finalizeAfterSuccess(res);
      }
    } catch(e){
      if(attempts >= maxAttempts){ clearInterval(poll); showSpinner(false); showError('Automatic verification failed. Contact support with tx_ref: ' + txRef); if(payBtn){ payBtn.disabled = false; payBtn.dataset.processing = '0'; } }
    }
  }, 3000);
}

/* -------------------- LOAD CHECKOUT DATA: order -> quote -> cart -------------------- */
async function loadCheckoutData(){
  selectedCurrency = localStorage.getItem(CURRENCY_KEY) || selectedCurrency || 'NGN';
  if(currencySelect) currencySelect.value = selectedCurrency;
  if(currencyWrapper) currencyWrapper.style.display = quoteId ? 'block' : (currencyWrapper.style.display || 'none');

  try {
    showSpinner(true);

    // 1) orderId param -> fetch order and render paid summary
    if(orderId){
      try {
        const snap = await getDoc(doc(db, "brands", "fleurdevie", "orders", orderId));
        if(snap && snap.exists()){
          const data = snap.data(); data.id = snap.id;
          activeOrderRaw = data;
          if(data.currency) selectedCurrency = String(data.currency).toUpperCase();
          fillBillingFields(data);
          renderPaidUIFromDoc(data);
          showSpinner(false);
          removeBlurLoaderAndReveal();
          return;
        }
      } catch(e){
        console.error("Error loading order by id", e);
        showError('Unable to load order. Contact support.');
        removeBlurLoaderAndReveal();
        return;
      }
    }

    // 2) quoteId param -> try to find linked order first (prevent flicker & ensure correct data)
    if(quoteId){
      // Try find order where source == quote:<quoteId>
      try {
        const ordersColl = collection(db, "brands", "fleurdevie", "orders");
        const q = query(ordersColl, where("source", "==", `quote:${quoteId}`));
        const snap = await getDocs(q);
        if(snap && !snap.empty){
          // prefer first matched order (should normally be one)
          const orderDoc = snap.docs[0];
          const orderData = orderDoc.data(); orderData.id = orderDoc.id;
          activeOrderRaw = orderData;
          if(orderData.currency) selectedCurrency = String(orderData.currency).toUpperCase();
          fillBillingFields(orderData);
          renderPaidUIFromDoc(orderData);
          showSpinner(false);
          removeBlurLoaderAndReveal();
          return;
        }
      } catch(e){
        console.warn('Order lookup by source failed', e);
        // continue to fetch quote below as fallback
      }

      // If no order found, fetch quote and decide paid/unpaid
      let qSnap = null;
      try {
        qSnap = await getDoc(doc(db, "brands", "fleurdevie", "quotes", quoteId));
      } catch(e){
        console.error("Error fetching quote", e);
        showSpinner(false);
        removeBlurLoaderAndReveal();
        showError('Unable to access quote details. Contact support.');
        return;
      }
      if(!qSnap || !qSnap.exists()){ showSpinner(false); removeBlurLoaderAndReveal(); showError('Quote not found.'); return; }
      activeQuoteRaw = qSnap.data(); activeQuoteRaw.id = qSnap.id;
      const qStatus = (activeQuoteRaw.status || '').toLowerCase();

      if(qStatus === 'paid' && activeQuoteRaw.orderId){
        try {
          const orderSnap = await getDoc(doc(db, "brands", "fleurdevie", "orders", activeQuoteRaw.orderId));
          if(orderSnap && orderSnap.exists()){
            const orderData = orderSnap.data(); orderData.id = orderSnap.id;
            activeOrderRaw = orderData;
            if(orderData.currency) selectedCurrency = String(orderData.currency).toUpperCase();
            fillBillingFields(orderData);
            renderPaidUIFromDoc(orderData);
            showSpinner(false);
            removeBlurLoaderAndReveal();
            return;
          } else {
            // Quote marked paid, but order doc missing — still render using quote doc
            isPaidOrder = true;
            if(activeQuoteRaw.currency) selectedCurrency = String(activeQuoteRaw.currency).toUpperCase();
            renderPaidUIFromDoc(activeQuoteRaw);
            showSpinner(false);
            removeBlurLoaderAndReveal();
            return;
          }
        } catch(e){
          console.error('Error fetching order for paid quote', e);
          isPaidOrder = true;
          if(activeQuoteRaw.currency) selectedCurrency = String(activeQuoteRaw.currency).toUpperCase();
          renderPaidUIFromDoc(activeQuoteRaw);
          showSpinner(false);
          removeBlurLoaderAndReveal();
          return;
        }
      }

      // Unpaid quote case: populate customer/email if present and render computed quote
      if(activeQuoteRaw.customer && nameInput) nameInput.value = activeQuoteRaw.customer;
      if(activeQuoteRaw.email && emailInput) emailInput.value = activeQuoteRaw.email;
      quote = normalizeQuoteItems(activeQuoteRaw);
      quote._isOrder = false;
      quote._paidFlag = (activeQuoteRaw.status || '').toLowerCase() === 'paid';
      renderOrderFromQuoteNormalized(quote, selectedCurrency, false);
      configureCheckoutUI('quote-unpaid');
      setCheckoutUI();
      showSpinner(false);
      removeBlurLoaderAndReveal();
      return;
    }

    // 3) Cart view (local)
    rawCart = mergeCartItems(safeParseJSON(localStorage.getItem(STORAGE_KEY), []) || []);
    if(!rawCart.length){
      quote = { items: [] };
      renderOrderFromQuoteNormalized(quote, selectedCurrency, false);
      showSpinner(false);
      showError('Your cart is empty.');
      configureCheckoutUI('cart');
      removeBlurLoaderAndReveal();
      return;
    }
    quote = await buildQuoteFromCart();
    quote._isOrder = false;
    quote._paidFlag = false;
    renderOrderFromQuoteNormalized(quote, selectedCurrency, false);
    configureCheckoutUI('cart');
    setCheckoutUI();
    showSpinner(false);
    removeBlurLoaderAndReveal();
  } catch(e){
    showSpinner(false);
    console.error('loadCheckoutData failed', e);
    showError('Failed to load checkout data. Refresh and try again.');
    removeBlurLoaderAndReveal();
  }
}

/* -------------------- SET CHECKOUT UI (unpaid) -------------------- */
function setCheckoutUI(){
  const heroTitle = document.querySelector('.hero-text h1');
  if(heroTitle) heroTitle.textContent = quoteId ? 'Quote Checkout' : 'Checkout';
  if(payBtn){ payBtn.textContent = 'Proceed to Payment'; payBtn.disabled = false; payBtn.classList.remove('paid-state'); payBtn.dataset.processing = '0'; }
  computeAndUpdateCartCount();
}

/* -------------------- BINDINGS -------------------- */
if(payBtn) payBtn.addEventListener('click', initiatePaymentFlow);
if(currencySelect) currencySelect.addEventListener('change', ()=>{ selectedCurrency = currencySelect.value; localStorage.setItem(CURRENCY_KEY, selectedCurrency); if(quote) renderOrderFromQuoteNormalized(quote, selectedCurrency, isPaidOrder); });

window.addEventListener('scroll', () => {
  const header = document.querySelector('.site-header');
  if(!header) return;
  if(window.scrollY > 50) header.classList.add('scrolled'); else header.classList.remove('scrolled');
});

// hamburger
const hamburgerBtn = document.getElementById('hamburger-btn');
const navMenu = document.getElementById('nav-menu');
if(hamburgerBtn) hamburgerBtn.addEventListener('click', ()=>{ hamburgerBtn.classList.toggle('open'); if(navMenu) navMenu.classList.toggle('open'); });

/* -------------------- INIT -------------------- */
(async function init(){
  try { if(currencySelect) currencySelect.value = selectedCurrency; } catch(e){}
  try { computeAndUpdateCartCount(); } catch(e){}
  const paidQuoteInfo = safeParseJSON(localStorage.getItem('paidQuoteInfo'), null);
  if(quoteId && paidQuoteInfo && paidQuoteInfo.verified && paidQuoteInfo.quoteId === quoteId){
    await syncPaidQuoteUI();
  } else {
    await loadCheckoutData();
  }
})();

/* -------------------- suppress known noisy errors from FP/Flutterwave -------------------- */
window.addEventListener('error', (e)=>{
  try {
    const msg = (e && e.message) ? e.message.toLowerCase() : '';
    const file = (e && e.filename) ? e.filename.toLowerCase() : '';
    if(msg.includes('api key not found') || file.includes('metrics.flutterwave.com') || file.includes('loader_v') || file.includes('initfingerprint') || msg.includes('fpjs')){
      console.warn('Suppressed known noise:', e.message || e.filename);
      e.preventDefault && e.preventDefault();
    }
  } catch(err){}
});

/* -------------------- storage listeners to keep UI updated -------------------- */
window.addEventListener('storage', async (e)=>{
  if(e.key === STORAGE_KEY){
    rawCart = safeParseJSON(localStorage.getItem(STORAGE_KEY), []) || [];
    rawCart = mergeCartItems(rawCart);
    await loadCheckoutData();
  }
});

/* -------------------- small support: mailto link when clicking brand (optional) -------------------- */
try {
  const supportBtn = document.getElementById('floatingSupportBtn');
  supportBtn?.addEventListener('click', () => {
    window.location.href = 'mailto:yourstruly.fleurdevie@gmail.com?subject=Support%20Request';
  });
} catch(e){}

/* ----------------- Footer Year ----------------- */
try {
  const yearEl = document.getElementById('year');
  if(yearEl) yearEl.textContent = new Date().getFullYear();
} catch(e){}
</script>

<!-- Smart Mobile Input Experience: Final Universal Version -->
<script>
(() => {
  // --- 1️⃣ Ensure proper viewport meta ---
  const meta = document.querySelector('meta[name="viewport"]');
  if (meta) {
    meta.setAttribute('content', 'width=device-width, initial-scale=1, maximum-scale=1');
  } else {
    const newMeta = document.createElement('meta');
    newMeta.name = 'viewport';
    newMeta.content = 'width=device-width, initial-scale=1, maximum-scale=1';
    document.head.appendChild(newMeta);
  }

  // --- 2️⃣ Global mobile-friendly styles ---
  const style = document.createElement('style');
  style.textContent = `
    @media (max-width: 768px) {
      input, textarea, select {
        font-size: 16px !important;
      }
    }
    html, body {
      min-height: 100dvh;
      scroll-behavior: smooth;
    }
    /* Smoothly hide sticky/fixed UI when keyboard opens */
    .keyboard-open [data-sticky],
    .keyboard-open footer,
    .keyboard-open .sticky,
    .keyboard-open .fixed-bottom,
    .keyboard-open [class*="sticky"],
    .keyboard-open [class*="fixed"] {
      transform: translateY(120%);
      transition: transform 0.3s ease;
    }
  `;
  document.head.appendChild(style);

  // --- 3️⃣ Keyboard open/close detection ---
  let lastWindowHeight = window.innerHeight;
  let lastScrollY = 0;

  const onResize = () => {
    const diff = lastWindowHeight - window.innerHeight;
    if (diff > 150) {
      // Keyboard opened
      lastScrollY = window.scrollY;
      document.body.classList.add('keyboard-open');
    } else if (diff < -150) {
      // Keyboard closed
      document.body.classList.remove('keyboard-open');
      // Restore scroll position
      setTimeout(() => window.scrollTo({ top: lastScrollY, behavior: 'smooth' }), 200);
    }
    lastWindowHeight = window.innerHeight;
  };

  window.addEventListener('resize', onResize);
  window.addEventListener('focusin', () => {
    lastScrollY = window.scrollY;
    document.body.classList.add('keyboard-open');
  });
  window.addEventListener('focusout', () => {
    document.body.classList.remove('keyboard-open');
    setTimeout(() => window.scrollTo({ top: lastScrollY, behavior: 'smooth' }), 200);
  });

  // --- 4️⃣ iOS Safari input-jump prevention ---
  let activeInput = null;
  document.addEventListener('focusin', e => {
    if (['INPUT', 'TEXTAREA', 'SELECT'].includes(e.target.tagName)) {
      activeInput = e.target;
      setTimeout(() => {
        const rect = activeInput.getBoundingClientRect();
        if (rect.bottom > window.innerHeight - 100) {
          activeInput.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }, 300);
    }
  });
  document.addEventListener('focusout', () => {
    activeInput = null;
  });
})();
</script>
  

</body>
</html>
