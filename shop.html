<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Fleur De Vie - Shop</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
/* RESET & BASE */
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family: "Montserrat", sans-serif; background: #F5E6CC; color:#112e1f; line-height:1.6; }
a { text-decoration:none; color:inherit; }

/* HEADER (Luxury Translucent Version) */
.site-header {
  background: rgba(17,46,31,0.9); /* deep brand green, slightly see-through */
  backdrop-filter: blur(5px);
  -webkit-backdrop-filter: blur(10px);
  color: #F5E6CC;
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:10px 24px;
  position:fixed;
  top:0; left:0; right:0;
  z-index:1000;
  height:68px;
  transition: background 0.3s ease, top 0.4s ease, opacity 0.4s ease;
}

.site-header.scrolled {
  background: #112e1f; /* solid brand color after scroll */
}

.site-header.hidden {
  opacity: 0;
  top: -80px;
  pointer-events: none;
}

.site-header:hover {
  background: rgba(17,46,31,0.9);
}

.header-left { display:flex; align-items:center; gap:10px; }
.brand-logo { height:70px; transition:height 0.3s ease; }
.brand-title { font-family:"Playfair Display", serif; font-size:22px; font-weight:700; }

.header-right { display:flex; gap:20px; align-items:center; }
.header-right a {
  font-weight: 500;
  color: inherit;
  position: relative;
  transition: color 0.3s ease, transform 0.3s ease;
}

.header-right a:hover {
  color: #c9e4ff;
  transform: translateY(-2px);
}
.cart-count { background:#FFD6BA; color:#112e1f; font-size:12px; font-weight:600; border-radius:50%; padding:2px 6px; margin-left:4px; }

.hamburger { display:none; background:none; border:none; cursor:pointer; width:30px; height:24px; position:relative; }
.hamburger span { display:block; width:100%; height:3px; background:#F5E6CC; border-radius:2px; position:absolute; left:0; transition:0.3s; }
.hamburger span:nth-child(1){ top:0; }
.hamburger span:nth-child(2){ top:10px; }
.hamburger span:nth-child(3){ top:20px; }
.hamburger.open span:nth-child(1){ transform:rotate(45deg); top:10px; }
.hamburger.open span:nth-child(2){ opacity:0; }
.hamburger.open span:nth-child(3){ transform:rotate(-45deg); top:10px; }

/* HERO */
.hero { position: relative; height:90vh; display:flex; justify-content:center; align-items:center; text-align:center; margin-top:0; overflow:hidden; }
.hero::after { content:""; position:absolute; inset:0; background:url('asset/bg12.jpg') center/cover no-repeat; transform:scale(1.1); z-index:-1; border-radius:12px; box-shadow: inset 0 0 0 2000px rgba(17,46,31,0.3); }
.hero-text { position:relative; display:inline-block; color:#FFD6BA; margin-bottom:12px; animation: shimmer 3s infinite linear; }
.hero-text h1 { font-family:"Playfair Display", serif; font-size:clamp(36px,5vw,64px); margin-bottom:12px; }
.hero-text p { font-size:clamp(16px,2vw,24px); max-width:700px; }

/* SEARCH + SORT + CURRENCY */
.shop-controls { display:flex; justify-content:space-between; flex-wrap:wrap; margin-bottom:20px; gap:10px; align-items:center; }
.shop-controls input,
.shop-controls select { padding:8px; border-radius:6px; border:1px solid #112e1f; font-size:14px; flex:1; max-width:300px; } 
.currency-filter-group { display:flex; gap:10px; align-items:center; flex:1; max-width:300px; }

/* SHOP GRID */
section.shop { padding:80px 20px; background:#F5E6CC; }
.container { max-width:1100px; margin:auto; }
h2 { text-align:center; font-size:24px; font-family:"Playfair Display", serif; margin-bottom:40px; }

.product-grid { display:grid; gap:20px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
.product-card { background:#F5E6CC; padding:16px; border-radius:12px; box-shadow:0 4px 10px rgba(0,0,0,0.1); display:flex; flex-direction:column; transition: transform 0.2s; position:relative; color:inherit; }
.product-card:hover { transform: translateY(-5px); }
.product-card img { width:100%; height:180px; object-fit: contain; border-radius:8px; margin-bottom:12px; background: #fff; display:block; }
.product-card h3 { font-family:"Playfair Display", serif; font-size:1.1rem; margin-bottom:6px; }
.product-card .description { font-size:0.9rem; color:#112e1f; margin-bottom:8px; }
.product-card .price { font-weight:600; margin-bottom:12px; }
.product-card button { background:#112e1f; color:#F5E6CC; border:none; border-radius:6px; padding:10px; cursor:pointer; transition:0.3s; }
.product-card button:hover { background:#0a1d14; }
.quantity-controls { display:flex; gap:10px; align-items:center; margin-bottom:8px; }
.quantity-badge { font-weight:600; }

/* CUSTOMIZE BUTTON */
.customize-badge { position:absolute; top:10px; right:10px; background:#FFD6BA; color:#112e1f; font-size:12px; padding:6px 10px; border-radius:8px; font-weight:600; cursor:pointer; z-index:2; display:flex; align-items:center; gap:4px; box-shadow:0 2px 6px rgba(0,0,0,0.2); border:2px solid #112e1f; transition:0.2s; }
.customize-badge:hover { background:#112e1f; color:#FFD6BA; }

/* FOOTER */
footer { text-align:center; padding:20px; background:transparent; color:#112e1f; margin-top:60px; }

/* MEDIA */
@media(max-width:900px){ .product-grid { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); } }
@media(max-width:900px){
  .product-grid { grid-template-columns: repeat(2, 1fr); }
  .product-card img { height:140px; }
  .header-right { display:none; flex-direction:column; background:#112e1f; position:absolute; top:70px; right:0; width:200px; padding:20px; }
  .header-right.open { display:flex; }
  .hamburger { display:block; }
  .mobile-cart { display:flex; align-items:center; margin-right:10px; }
  .mobile-cart a { color:#FFD6BA; font-size:20px; position:relative; }
  .mobile-cart .cart-count { position:absolute; top:-8px; right:-8px; }
  .customize-badge { font-size:14px; padding:8px 12px; }
  .hero { height:40vh; margin-top:20px; padding-top:80px; } 
  .hero-text h1 { font-size:clamp(24px,5vw,32px); line-height:1.2; margin:0; }
  .hero-text p { font-size:clamp(14px,2.5vw,18px); margin:0 auto; }
}

 /* ---------------- Floating Support Button + Tooltip ---------------- */
  #floatingSupportBtn {
    position: fixed;
    right: 22px;
    bottom: 22px;
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: none;
    background: #112e1f;
    color: #fff;
    z-index: 10002;
    box-shadow: 0 8px 30px rgba(212,245,105,1);
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px; /* enlarged icon */
    transition: transform 0.3s ease, box-shadow 0.3s ease;
  }
  #floatingSupportBtn:hover {
    transform: translateY(-3px);
    box-shadow: 0 12px 36px rgba(212,245,105,0.8);
    animation: glowPulse 1.5s infinite ease-in-out;
  }
  #floatingSupportBtn::after {
    content: "Support";
    position: absolute;
    bottom: 70px;
    left: 50%;
    transform: translateX(-50%) translateY(0);
    background: #112e1f;
    color: #FFD6BA;
    padding: 6px 12px;
    border-radius: 6px;
    font-size: 14px;
    font-weight: 500;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease, transform 0.4s ease;
  }
  #floatingSupportBtn:hover::after {
    opacity: 1;
    transform: translateX(-50%) translateY(-6px);
  }
  @keyframes glowPulse {
    0%,100%{ box-shadow:0 8px 30px rgba(212,245,105,1);}
    50%{ box-shadow:0 12px 36px rgba(212,245,105,0.6);}
  }

</style>

</head>
<body>

<!-- HEADER -->
<header class="site-header">
  <div class="header-left">
    <img src="asset/logo.png" alt="Fleur De Vie Logo" class="brand-logo">
    <div class="brand-title">Fleur De Vie</div>
  </div>
  <div class="mobile-cart" style="display:none;">
    <a href="cart.html"><i class="fa-solid fa-cart-shopping"></i><span class="cart-count" id="cartCountMobile">0</span></a>
  </div>

  <!-- Hamburger -->
  <button class="hamburger" id="hamburger-btn">
    <span></span><span></span><span></span>
  </button>
  <nav class="header-right" id="nav-menu">
    <a href="index.html">Home</a>
    <a href="about.html">About</a>
    <a href="cart.html">Cart <span class="cart-count" id="cartCount">0</span></a>
    <a href="customization.html">Customize</a>
    <a href="contact.html">Contact</a>
  </nav>
</header>

<!-- HERO -->
<section class="hero">
  <div class="hero-text">
    <h1>Shop</h1>
    <p>Explore our collection of products</p>
  </div>
</section>

<!-- SHOP -->
<section class="shop">
  <div class="container">
    <h2>Our Products</h2>
    <div class="shop-controls">
      <input type="text" id="searchInput" placeholder="Search products...">
      <div class="currency-filter-group">
        <select id="currencySelect">
          <option value="NGN">NGN</option>
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
          <option value="GBP">GBP</option>
        </select>
        <select id="sortSelect">
          <option value="">Filter / Sort</option>
          <option value="alphabet">Alphabet</option>
          <option value="price-asc">Price: Low → High</option>
          <option value="price-desc">Price: High → Low</option>
        </select>
      </div>
    </div>
    <div class="product-grid" id="productGrid"></div>
  </div>
</section>
  
  <!-- Floating support button -->
<button id="floatingSupportBtn" aria-label="Support">
  <i class="fas fa-headset"></i>
</button>

<!-- FOOTER -->
<footer>
  <p>© 2025 Fleur De Vie</p>
</footer>

<script type="module">
/* ---------- FleurDeVie — Serac-parity shop script (drop-in) ---------- */

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

/* ---------- Firebase (existing config) ---------- */
const firebaseConfig = {
  apiKey: "AIzaSyCuiZXHFYl1fVKnGwojavRvbekSBpkipJg",
  authDomain: "brandisby.firebaseapp.com",
  projectId: "brandisby",
  storageBucket: "brandisby.firebasestorage.app",
  messagingSenderId: "87213267039",
  appId: "1:87213267039:web:339e9fd49e3ad31f7423ea"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------- DOM refs (keep FleurDeVie's IDs) ---------- */
const productGrid = document.getElementById('productGrid');
const cartCountElem = document.getElementById('cartCount');
const cartCountMobileElem = document.getElementById('cartCountMobile');
const searchInput = document.getElementById('searchInput');
const sortSelect = document.getElementById('sortSelect');
const currencySelect = document.getElementById('currencySelect');
const hamburgerBtn = document.getElementById('hamburger-btn');
const navMenu = document.getElementById('nav-menu');

/* ---------- FleurDeVie storage keys (preserve existing names) ---------- */
const CART_KEY = 'cart';
const CURRENCY_KEY = 'currency';

/* ---------- State ---------- */
let cart = (function(){ try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; } catch(e){ return []; } })();
cart = mergeCartItems(cart);
let productsData = {};
let currentPage = window.currentPage || 1;

/* restore currency preference */
try { if (localStorage.getItem(CURRENCY_KEY) && currencySelect) currencySelect.value = localStorage.getItem(CURRENCY_KEY); } catch(e){}

/* ---------- localStorage cart helpers ---------- */
function getCart() {
  try { return JSON.parse(localStorage.getItem(CART_KEY)) || []; } catch(e) { return []; }
}
function setCart(cartArray) {
  cart = mergeCartItems(cartArray || []);
  try { localStorage.setItem(CART_KEY, JSON.stringify(cart)); } catch(e){ console.warn("Could not set localStorage", e); }
  updateCartCount();
}
function mergeCartItems(cartArray) {
  const merged = [];
  (cartArray || []).forEach(item => {
    const idx = merged.findIndex(i => i.id === item.id && (i.color || '') === (item.color || '') && (i.size || '') === (item.size || ''));
    if (idx === -1) merged.push({ ...item });
    else merged[idx].quantity = (merged[idx].quantity || 0) + (item.quantity || 0);
  });
  return merged;
}

/* ---------- Cart operations (robust across variant id shapes) ---------- */
function getTotalQuantity(productId) {
  const c = getCart();
  let total = 0;
  (c || []).forEach(i => {
    if (String(i.id) === String(productId)) { total += (i.quantity || 0); return; }
    if (i.parentId && String(i.parentId) === String(productId)) { total += (i.quantity || 0); return; }
    if (i.productId && String(i.productId) === String(productId)) { total += (i.quantity || 0); return; }
    if (typeof i.id === 'string' && String(i.id).startsWith(String(productId) + '-')) { total += (i.quantity || 0); return; }
  });
  return total;
}

function addToCart(product) {
  const currentCart = getCart();
  const idx = currentCart.findIndex(i => i.id === product.id && (i.color || '') === (product.color || '') && (i.size || '') === (product.size || ''));
  if (idx > -1) currentCart[idx].quantity += 1;
  else currentCart.push({ ...product, quantity: 1 });
  setCart(currentCart);
  updateProductUI(product.id);
}

function removeFromCart(productId) {
  const currentCart = getCart();
  const idx = currentCart.findIndex(i => i.id === productId);
  if (idx > -1) {
    currentCart[idx].quantity -= 1;
    if (currentCart[idx].quantity <= 0) currentCart.splice(idx, 1);
  }
  setCart(currentCart);
  updateProductUI(productId);
}

/* ---------- Update cart count UI ---------- */
function updateCartCount() {
  const total = (getCart() || []).reduce((sum, i) => sum + (i.quantity || 0), 0);
  if (cartCountElem) cartCountElem.textContent = total;
  if (cartCountMobileElem) cartCountMobileElem.textContent = total;
}

/* ---------- Price formatting (preserve FleurDeVie's locales) ---------- */
function formatPrice(product, currency) {
  if (!product) return '';
  const price = currency === 'NGN' ? product.priceNGN :
                currency === 'USD' ? product.priceUSD :
                currency === 'EUR' ? product.priceEUR :
                currency === 'GBP' ? product.priceGBP : product.priceNGN;
  const localeMap = { NGN: 'en-NG', USD: 'en-US', EUR: 'de-DE', GBP: 'en-GB' };
  try {
    return new Intl.NumberFormat(localeMap[currency] || 'en-US', { style: 'currency', currency, minimumFractionDigits: currency === 'NGN' ? 0 : 2 }).format(price);
  } catch (e) {
    return `${currency} ${Number(price||0).toFixed(currency==='NGN'?0:2)}`;
  }
}

/* ---------- Modal styles injection (FleurDeVie look preserved) ---------- */
(function injectModalCSS(){
  if (document.getElementById('fdv-variant-modal-css')) return;
  const css = `
  .fdv-modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.15); z-index: 9999; }
  .fdv-modal { position: absolute; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.45); color: #fff; min-width: 220px; max-width: 360px; z-index:10000; overflow:hidden; transform-origin: top left; }
  .fdv-modal .fdv-modal-inner { padding: 12px 14px; }
  .fdv-modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
  .fdv-modal-title { font-family: "Playfair Display", serif; font-size:15px; color: #FFD6BA; }
  .fdv-modal-close { background:none; border:0; color:#FFD6BA; font-size:20px; cursor:pointer; }
  .fdv-modal-body { max-height:280px; overflow:auto; padding-right:6px; }
  .fdv-variant-row { display:flex; gap:10px; align-items:center; padding:8px 0; border-bottom: 1px solid rgba(255,255,255,0.04); }
  .fdv-variant-row img { width:52px; height:52px; object-fit:cover; border-radius:6px; background:#fff; }
  .fdv-variant-meta h4{ margin:0; font-size:13px; color:#fff; }
  .fdv-variant-meta p{ margin:0; font-size:12px; color:#E6E6E6; }
  .fdv-modal-footer { display:flex; justify-content:flex-end; gap:8px; margin-top:10px; }
  .fdv-btn { border:1px solid rgba(255,214,186,0.15); background:transparent; color:#FFD6BA; padding:6px 10px; border-radius:8px; cursor:pointer; font-weight:600; }
  .fdv-btn.primary { background: #FFD6BA; color:#112e1f; border: none; }
  .fdv-anim-enter { animation: fdv-slide-fade-in 220ms ease forwards; }
  .fdv-anim-leave { animation: fdv-slide-fade-out 220ms ease forwards; }
  @keyframes fdv-slide-fade-in { 0% { opacity: 0; transform: translateY(8px) scale(0.98); } 100% { opacity: 1; transform: translateY(0) scale(1); } }
  @keyframes fdv-slide-fade-out { 0% { opacity: 1; transform: translateY(0) scale(1); } 100% { opacity: 0; transform: translateY(8px) scale(0.98); } }

  /* Pagination & action button style parity (keeps FleurDeVie's look but Serac UX) */
  .fdv-pagination { display:flex; justify-content:center; align-items:center; gap:0.6rem; margin-top:2rem; padding:1rem 0.5rem; width:100%; flex-wrap:wrap; }
  .fdv-pagination button { background: transparent !important; color: #FFD6BA; border: 1px solid #FFD6BA; padding:0.5rem 1rem; cursor:pointer; border-radius:6px; font-weight:500; transition:all 0.3s ease; }
  .fdv-pagination button:hover { background: #FFD6BA; color:#112e1f; }
  .fdv-pagination button.active { background: #FFD6BA; color:#112e1f; border-color: #FFD6BA; }
  .fdv-pagination button:disabled { opacity:0.4; cursor:not-allowed; }

  .fdv-gold-hover { position:relative; background:transparent; color:#FFD6BA; border:1px solid #FFD6BA; padding:8px 12px; border-radius:8px; font-weight:600; overflow:hidden; transition: color 0.25s ease; }
  .fdv-gold-hover::after { content:''; position:absolute; left:0; top:0; width:0; height:100%; background:#FFD6BA; z-index:-1; transition: width 0.25s ease; }
  .fdv-gold-hover:hover { color:#112e1f; }
  .fdv-gold-hover:hover::after { width:100%; }
  `;
  const s = document.createElement('style');
  s.id = 'fdv-variant-modal-css';
  s.textContent = css;
  document.head.appendChild(s);
})();

/* ---------- Build selected variant rows for a product (reads cart shapes) ---------- */
function buildVariantRowsForProduct(productId) {
  const c = getCart();
  const rows = [];
  (c || []).forEach(item => {
    const matches =
      String(item.id) === String(productId) ||
      (item.parentId && String(item.parentId) === String(productId)) ||
      (item.productId && String(item.productId) === String(productId)) ||
      (typeof item.id === 'string' && String(item.id).startsWith(String(productId) + '-'));
    if (matches) {
      const master = productsData[String(productId)] || {};
      const nameParts = [];
      if (master.name) nameParts.push(master.name);
      if (item.color) nameParts.push(item.color);
      if (item.size) nameParts.push(item.size);
      const displayName = item.name || nameParts.join(' — ') || `Product ${productId}`;
      const imageUrl = item.image || master.imageUrl || (master.images && master.images[0]) || '';
      rows.push({
        id: item.id,
        parentId: item.parentId || null,
        productId: item.productId || null,
        name: displayName,
        imageUrl,
        color: item.color || null,
        size: item.size || null,
        quantity: item.quantity || 0
      });
    }
  });
  return rows;
}

/* ---------- Variant modal (positioned near trigger) ---------- */
let activeModal = null;
function showVariantModal(productId, triggerElem = null) {
  // close existing modal first
  closeVariantModalImmediate();

  const rows = buildVariantRowsForProduct(productId);
  if (!rows || rows.length === 0) {
    const cur = localStorage.getItem(CURRENCY_KEY) || 'NGN';
    window.location.href = `product.html?productId=${encodeURIComponent(productId)}&currency=${encodeURIComponent(cur)}`;
    return;
  }

  const backdrop = document.createElement('div');
  backdrop.className = 'fdv-modal-backdrop';
  backdrop.style.zIndex = 9999;
  document.body.appendChild(backdrop);

  const modal = document.createElement('div');
  modal.className = 'fdv-modal fdv-anim-enter';
  modal.setAttribute('role', 'dialog');
  modal.setAttribute('aria-modal', 'true');

  modal.innerHTML = `
    <div class="fdv-modal-inner">
      <div class="fdv-modal-header">
        <div class="fdv-modal-title">Your selection</div>
        <button class="fdv-modal-close" aria-label="Close">&times;</button>
      </div>
      <div class="fdv-modal-body"></div>
      <div class="fdv-modal-footer">
        <button class="fdv-btn clear-selection">Clear all selection</button>
        <button class="fdv-btn primary edit-selection">Edit selection</button>
      </div>
    </div>
  `;

  document.body.appendChild(modal);
  activeModal = { backdrop, modal };

  const body = modal.querySelector('.fdv-modal-body');
  rows.forEach(r => {
    const row = document.createElement('div');
    row.className = 'fdv-variant-row';
    row.innerHTML = `
      <img src="${escapeHtml(r.imageUrl || '')}" alt="${escapeHtml(r.name || '')}">
      <div class="fdv-variant-meta">
        <h4>${escapeHtml(r.name || '')}</h4>
        <p>${(r.color ? `Color: ${escapeHtml(r.color)} • ` : '') + (r.size ? `Size: ${escapeHtml(r.size)} • ` : '')}Qty: ${r.quantity}</p>
      </div>
    `;
    body.appendChild(row);
  });

  // brand color detection for modal background (non-destructive)
  const bg = detectBrandGreen() || '#112e1f';
  modal.style.background = bg;

  // position and handlers
  positionModalNearTrigger(modal, triggerElem);

  modal.querySelector('.fdv-modal-close').addEventListener('click', closeVariantModal);
  modal.querySelector('.clear-selection').addEventListener('click', () => {
    const current = getCart();
    const filtered = (current || []).filter(item => {
      const matches =
        String(item.id) === String(productId) ||
        (item.parentId && String(item.parentId) === String(productId)) ||
        (item.productId && String(item.productId) === String(productId)) ||
        (typeof item.id === 'string' && String(item.id).startsWith(String(productId) + '-'));
      return !matches;
    });
    setCart(filtered);
    closeVariantModal();
    loadProducts();
  });
  modal.querySelector('.edit-selection').addEventListener('click', () => {
    const cur = localStorage.getItem(CURRENCY_KEY) || 'NGN';
    closeVariantModal();
    window.location.href = `product.html?productId=${encodeURIComponent(productId)}&currency=${encodeURIComponent(cur)}`;
  });

  backdrop.addEventListener('click', () => closeVariantModal());
  modal.addEventListener('click', e => e.stopPropagation());

  function __reposition(){ positionModalNearTrigger(modal, triggerElem); }
  window.addEventListener('resize', __reposition);
  window.addEventListener('scroll', __reposition, { passive: true });
  modal._cleanup = () => { window.removeEventListener('resize', __reposition); window.removeEventListener('scroll', __reposition); };
}

function closeVariantModalImmediate(){
  if (!activeModal) return;
  try { activeModal.modal._cleanup && activeModal.modal._cleanup(); } catch(e){}
  activeModal.backdrop.remove();
  activeModal.modal.remove();
  activeModal = null;
}

function closeVariantModal(){
  if (!activeModal) return;
  const { backdrop, modal } = activeModal;
  modal.classList.remove('fdv-anim-enter');
  modal.classList.add('fdv-anim-leave');
  setTimeout(() => {
    try { modal._cleanup && modal._cleanup(); } catch(e){}
    backdrop.remove();
    modal.remove();
    activeModal = null;
  }, 220);
}

/* ---------- modal positioning (robust) ---------- */
function positionModalNearTrigger(modal, triggerElem){
  if (!modal) return;
  const rect = triggerElem ? triggerElem.getBoundingClientRect() : { left: window.innerWidth/2, top: window.innerHeight/2, bottom: window.innerHeight/2 };
  const mw = Math.min(window.innerWidth - 24, 360);
  const scrollY = window.scrollY || window.pageYOffset;
  const scrollX = window.scrollX || window.pageXOffset;

  // default horizontal: align left but keep inside viewport
  let left = (rect.left || (window.innerWidth - mw)/2) + scrollX;
  if (left + mw + 12 > scrollX + window.innerWidth) left = (scrollX + window.innerWidth) - mw - 12;
  if (left < scrollX + 12) left = scrollX + 12;
  if (window.innerWidth <= 480) left = scrollX + Math.max(12, (window.innerWidth - mw) / 2);

  // vertical: below if space else above
  const spaceBelow = window.innerHeight - (rect.bottom || rect.top);
  const spaceAbove = rect.top || 0;
  let top;
  if (spaceBelow > 220 || spaceBelow >= spaceAbove) {
    top = (rect.bottom || (window.innerHeight/2)) + 8 + scrollY;
  } else {
    top = (rect.top || (window.innerHeight/2)) - 8 - (modal.offsetHeight || 200) + scrollY;
    if (top < scrollY + 8) top = (rect.bottom || (window.innerHeight/2)) + 8 + scrollY;
  }

  modal.style.width = mw + 'px';
  modal.style.left = Math.round(left) + 'px';
  modal.style.top = Math.round(top) + 'px';
}

/* ---------- try to detect FleurDeVie's brand green for modal BG ---------- */
function detectBrandGreen(){
  try {
    const el = document.querySelector('.product-card button, .add-cart, .select-variant, .product-card .add-cart');
    if (!el) return '#112e1f';
    const cs = getComputedStyle(el);
    const bg = cs.backgroundColor || cs.color || null;
    return bg || '#112e1f';
  } catch(e){ return '#112e1f'; }
}

/* ---------- Load & render products (FleurDeVie collection) ---------- */
async function loadProducts() {
  try {
    if (productGrid) productGrid.innerHTML = '<p style="text-align:center; color:var(--muted);">Loading products…</p>';
    const q = query(collection(db, "brands", "fleurdevie", "products"), where("published", "==", true));
    const snapshot = await getDocs(q);
    const products = [];
    productsData = {};
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      if (!data.name) return;
      const p = { id: docSnap.id, ...data };
      products.push(p);
      productsData[docSnap.id] = p;
    });
    displayProducts(products);
  } catch (e) {
    console.error(e);
    if (productGrid) productGrid.innerHTML = '<p style="text-align:center;color:tomato;">Failed to load products.</p>';
  }
}

/* ---------- Display with Serac-like behavior but FleurDeVie styling ---------- */
function displayProducts(products) {
  const term = (searchInput?.value || '').toLowerCase();
  let filtered = (products || []).filter(p => (p.name || '').toLowerCase().includes(term));
  const sortVal = sortSelect?.value;
  const currency = currencySelect?.value || (localStorage.getItem(CURRENCY_KEY) || 'NGN');

  function getPriceForCurrency(product) {
    return currency === 'NGN' ? product.priceNGN : currency === 'USD' ? product.priceUSD : currency === 'EUR' ? product.priceEUR : currency === 'GBP' ? product.priceGBP : product.priceNGN;
  }

  if (sortVal === 'alphabet') filtered.sort((a,b) => (a.name || '').localeCompare(b.name || ''));
  if (sortVal === 'price-asc') filtered.sort((a,b) => (getPriceForCurrency(a) || 0) - (getPriceForCurrency(b) || 0));
  if (sortVal === 'price-desc') filtered.sort((a,b) => (getPriceForCurrency(b) || 0) - (getPriceForCurrency(a) || 0));

  /* Pagination */
  const productsPerPage = 24; // Serac uses 24 — keep same UX scale
  const totalPages = Math.ceil(filtered.length / productsPerPage) || 1;
  if (currentPage > totalPages) currentPage = totalPages;

  const start = (currentPage - 1) * productsPerPage;
  const paginated = filtered.slice(start, start + productsPerPage);

  if (productGrid) productGrid.innerHTML = '';
  for (const p of paginated) {
    const quantity = getTotalQuantity(p.id);
    const priceForCurrency = getPriceForCurrency(p);

    const hasVariants = Boolean(
      (p.variants && Array.isArray(p.variants) && p.variants.length > 0) ||
      (p.options && Array.isArray(p.options) && p.options.length > 0) ||
      (p.variantOptions && Array.isArray(p.variantOptions) && p.variantOptions.length > 0) ||
      p.variantsAvailable === true ||
      p.hasVariants === true ||
      p.isVariant === true ||
      (Array.isArray(p.colors) && p.colors.length > 0) ||
      (Array.isArray(p.sizes) && p.sizes.length > 0)
    );

    const div = document.createElement('div');
    div.className = 'product-card';
    div.id = `product-${p.id}`;
    div.dataset.hasVariants = hasVariants ? 'true' : 'false';

    let quantityControlsHtml = '';
    if (hasVariants) {
      quantityControlsHtml = `<div class="quantity-controls" aria-hidden="true"><span class="quantity-badge">${quantity > 0 ? quantity : ''}</span></div>`;
    } else {
      quantityControlsHtml = `
        <div class="quantity-controls">
          <button class="minus" aria-label="Decrease">-</button>
          <span class="quantity-badge">${quantity > 0 ? quantity : ''}</span>
          <button class="plus" aria-label="Increase">+</button>
        </div>
      `;
    }

    const actionButtonHtml = hasVariants
      ? `<button class="select-variant fdv-gold-hover" data-id="${p.id}">${quantity > 0 ? 'View selection' : 'Select your choice'}</button>`
      : `<button class="add-cart" style="display:${quantity > 0 ? 'none' : 'block'};">Add to Cart</button>`;

    div.innerHTML = `
      ${p.customizationAvailable ? `<a href="customization.html?productId=${p.id}" class="customize-badge" onclick="event.stopPropagation()"><i class="fa-solid fa-wand-magic-sparkles"></i> Customize</a>` : ''}
      <a href="product.html?productId=${p.id}&price=${encodeURIComponent(priceForCurrency)}&currency=${encodeURIComponent(currency)}">
        <img src="${escapeHtml(p.imageUrl || '')}" alt="${escapeHtml(p.name || '')}">
      </a>
      <h3>${escapeHtml(p.name || '')}</h3>
      <div class="description">${escapeHtml(truncateText(p.description || '', 15))}</div>
      <div class="price">${formatPrice(p, currency)}</div>
      ${quantityControlsHtml}
      ${actionButtonHtml}
    `;

    // wire events
    if (!hasVariants) {
      div.querySelector('.plus')?.addEventListener('click', e => { e.stopPropagation(); addToCart(p); });
      div.querySelector('.minus')?.addEventListener('click', e => { e.stopPropagation(); removeFromCart(p.id); });
      div.querySelector('.add-cart')?.addEventListener('click', e => { e.stopPropagation(); addToCart(p); });
    } else {
      const selectBtn = div.querySelector('.select-variant');
      if (selectBtn) {
        selectBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          const totalSelected = getTotalQuantity(p.id);
          if (totalSelected > 0) {
            showVariantModal(p.id, selectBtn);
          } else {
            const url = `product.html?productId=${encodeURIComponent(p.id)}&price=${encodeURIComponent(priceForCurrency)}&currency=${encodeURIComponent(currency)}`;
            window.location.href = url;
          }
        });
      }
    }

    productGrid?.appendChild(div);
  }

  /* Pagination UI */
  const existing = document.querySelector('.fdv-pagination');
  if (existing) existing.remove();

  const paginationContainer = document.createElement('div');
  paginationContainer.className = 'fdv-pagination';

  const prevBtn = document.createElement('button');
  prevBtn.textContent = 'Previous';
  prevBtn.disabled = currentPage === 1 || totalPages <= 1;
  prevBtn.addEventListener('click', () => {
    if (currentPage > 1) { currentPage -= 1; displayProducts(products); window.scrollTo({ top:0, behavior:'smooth' }); }
  });
  paginationContainer.appendChild(prevBtn);

  for (let i = 1; i <= Math.max(totalPages,1); i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    btn.className = (i === currentPage) ? 'active' : '';
    btn.addEventListener('click', () => { currentPage = i; displayProducts(products); window.scrollTo({ top:0, behavior:'smooth' }); });
    paginationContainer.appendChild(btn);
  }

  const nextBtn = document.createElement('button');
  nextBtn.textContent = 'Next';
  nextBtn.disabled = currentPage === totalPages || totalPages <= 1;
  nextBtn.addEventListener('click', () => {
    if (currentPage < totalPages) { currentPage += 1; displayProducts(products); window.scrollTo({ top:0, behavior:'smooth' }); }
  });
  paginationContainer.appendChild(nextBtn);

  if (productGrid && productGrid.parentElement) {
    productGrid.insertAdjacentElement('afterend', paginationContainer);
  } else {
    document.body.appendChild(paginationContainer);
  }

  // ensure UI reflects cart totals
  updateCartCount();
  (paginated || []).forEach(p => updateProductUI(p.id));
}

/* ---------- Update product card UI (badge and Add button visibility) ---------- */
function updateProductUI(productId) {
  const card = document.getElementById(`product-${productId}`);
  if (!card) return;
  const addBtn = card.querySelector('.add-cart, .fdv-add-cart');
  const selBtn = card.querySelector('.select-variant');
  const badge = card.querySelector('.quantity-badge');
  const totalQty = getTotalQuantity(productId);
  const isVariant = card.dataset.hasVariants === 'true';

  if (isVariant) {
    if (badge) badge.textContent = totalQty > 0 ? totalQty : '';
    if (selBtn) {
      selBtn.style.display = 'inline-block';
      selBtn.textContent = totalQty > 0 ? 'View selection' : 'Select your choice';
      selBtn.classList.add('fdv-gold-hover');
    }
    const plus = card.querySelector('.plus');
    const minus = card.querySelector('.minus');
    if (plus) plus.style.display = 'none';
    if (minus) minus.style.display = 'none';
  } else {
    if (totalQty > 0) {
      if (addBtn && addBtn.classList.contains('add-cart')) addBtn.style.display = 'none';
      if (badge) badge.textContent = totalQty;
    } else {
      if (addBtn && addBtn.classList.contains('add-cart')) addBtn.style.display = 'block';
      if (badge) badge.textContent = '';
    }
  }
}

/* ---------- Helpers ---------- */
function truncateText(text, wordLimit) { return (text || '').split(' ').slice(0, wordLimit).join(' '); }
function escapeHtml(str) { if (!str && str !== 0) return ""; return String(str).replace(/[&<>"']/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": "&#39;" }[s])); }

/* ---------- Event wiring (search/sort/currency) ---------- */
searchInput?.addEventListener('input', () => { window.currentPage = 1; loadProducts(); });
sortSelect?.addEventListener('change', () => { window.currentPage = 1; loadProducts(); });

/* currency change: persist preference and update prices in-place (Serac parity) */
currencySelect?.addEventListener('change', () => {
  const newCurrency = currencySelect.value;
  try { localStorage.setItem(CURRENCY_KEY, newCurrency); } catch(e){}
  // update all rendered price elements (do not reload full list)
  Object.values(productsData).forEach(product => {
    const card = document.getElementById(`product-${product.id}`);
    if (!card) return;
    const priceElem = card.querySelector('.price');
    if (!priceElem) return;
    priceElem.textContent = formatPrice(product, newCurrency);
    // also update product links that included price/currency query params
    const a = card.querySelector('a[href*="product.html?productId="]');
    if (a) {
      const newUrl = `product.html?productId=${encodeURIComponent(product.id)}&price=${encodeURIComponent(getPriceStringForProduct(product, newCurrency))}&currency=${encodeURIComponent(newCurrency)}`;
      a.setAttribute('href', newUrl);
    }
  });
});

/* helper to produce numeric price string used in product link (no currency symbol) */
function getPriceStringForProduct(product, currency) {
  const n = currency === 'NGN' ? product.priceNGN : currency === 'USD' ? product.priceUSD : currency === 'EUR' ? product.priceEUR : currency === 'GBP' ? product.priceGBP : product.priceNGN;
  return String(n != null ? n : '');
}

/* ---------- Hamburger & mobile cart (keep existing handlers) ---------- */
if (hamburgerBtn) hamburgerBtn.addEventListener('click', () => { hamburgerBtn.classList.toggle('open'); if (navMenu) navMenu.classList.toggle('open'); });
function handleMobileCart(){ const el = document.querySelector('.mobile-cart'); if(!el) return; el.style.display = window.innerWidth <= 900 ? 'flex' : 'none'; }
window.addEventListener('resize', handleMobileCart);
handleMobileCart();

/* ---------- Storage sync (other tabs) and pageshow to reflect product page changes ---------- */
window.addEventListener('storage', () => {
  cart = getCart();
  cart = mergeCartItems(cart);
  updateCartCount();
  Object.keys(productsData || {}).forEach(pid => updateProductUI(pid));
});
window.addEventListener('pageshow', () => {
  cart = mergeCartItems(getCart());
  updateCartCount();
  Object.keys(productsData || {}).forEach(pid => updateProductUI(pid));
});

/* ---------- Document-level listener for "select-variant" (ensures modal opens reliably) ---------- */
document.addEventListener('click', (e) => {
  const btn = e.target.closest('.select-variant');
  if (!btn) return;
  const productId = btn.dataset.id || btn.getAttribute('data-id') || (btn.closest && btn.closest('.product-card') && btn.closest('.product-card').id?.replace(/^product-/, ''));
  if (!productId) return;
  showVariantModal(productId, btn);
});

/* ---------- Initial load ---------- */
updateCartCount();
loadProducts();

</script>


</body>
</html>
