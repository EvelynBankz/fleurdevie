<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sérac - Checkout</title>

<!-- Fonts + Icons -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root{
  --bg-dark: #141517;
  --gold: #B66E41;
  --muted: #bdbdbd;
  --transition: 0.25s cubic-bezier(.2,.9,.2,1);
  --card-bg: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.02));
}

/* RESET */
*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%}
body{font-family:"Montserrat",sans-serif;background:var(--bg-dark);color:#e6e6e6;line-height:1.6}
a{color:inherit;text-decoration:none;transition:color var(--transition)}

/* HEADER */
.site-header{background:transparent;transition:background .3s,border-bottom .3s,color .3s;display:flex;justify-content:space-between;align-items:center;padding:16px 28px;position:fixed;top:0;left:0;right:0;z-index:1000;border-bottom:1px solid rgba(255,255,255,0.04)}
.site-header.scrolled{background:var(--bg-dark);border-bottom:1px solid rgba(255,255,255,0.06)}

.header-left { display:flex; align-items:center; gap:14px; }
.brand-logo { height:56px; width:auto; object-fit:contain; filter: drop-shadow(0 4px 12px rgba(0,0,0,0.6)); }
.brand-title { font-family:"Playfair Display", serif; font-size:22px; font-weight:700; color:var(--gold); letter-spacing:0.6px; }

.header-right { display:flex; gap:22px; align-items:left; }

.header-right { display:flex; gap:22px; align-items:left; }
.header-right a { font-weight:500; color:var(--muted); padding:6px 8px; border-radius:8px; transition: all var(--transition); }
.header-right a:hover { color:#fff; transform:translateY(-2px); text-shadow: 0 4px 18px rgba(182,110,65,0.15); }

.cart-count { background:var(--gold); color:var(--bg-dark); font-size:12px; font-weight:700; border-radius:50%; padding:3px 7px; margin-left:6px; box-shadow:0 4px 10px rgba(182,110,65,0.12); }

/* Hamburger */
.hamburger { display:none; background:none; border:none; cursor:pointer; width:30px; height:24px; position:relative; }
.hamburger span { display:block; width:100%; height:3px; background:#B66E41; border-radius:2px; position:absolute; left:0; transition:0.3s; }
.hamburger span:nth-child(1){ top:0; }
.hamburger span:nth-child(2){ top:10px; }
.hamburger span:nth-child(3){ top:20px; }
.hamburger.open span:nth-child(1){ transform:rotate(45deg); top:10px; background:#B66E41; }
.hamburger.open span:nth-child(2){ opacity:0; }
.hamburger.open span:nth-child(3){ transform:rotate(-45deg); top:10px; background:#B66E41; }

/* HERO */
.hero { position: relative; height: 95vh; display: flex; justify-content: center; align-items: center; text-align: center; margin-top: 0px; overflow: hidden; padding-top:72px; }
.hero::after { content: ""; position: absolute; inset: 0; background: url("../asset/bg25.jpg") center/cover no-repeat; transform: scale(1.06); z-index: -1; border-radius: 12px; box-shadow: inset 0 0 0 2000px rgba(20,21,23,0.55); }
.hero-text { position: relative; display: inline-block; margin-bottom:12px; }
.hero-text h1 { font-family:"Playfair Display", serif; font-size: clamp(36px,5vw,64px); margin-bottom:12px; color:#B66E41; }
.hero-text p { font-size: clamp(16px,2vw,22px); max-width:700px; color:#F5F5F3}

/* === UNDERLINE HOVER EFFECT (replicated from About page) === */
.header-right a {
  color: #F5F5F3;
  position: relative;
  padding: 6px 0;
  font-size: 1rem;
  font-weight: 500;
  transition: color 0.3s ease;
}

.header-right a::after {
  content: "";
  position: absolute;
  bottom: -4px;
  left: 0;
  width: 0;
  height: 2px;
  background: var(--gold);
  transition: width 0.3s ease;
}

.header-right a:hover {
  color: var(--gold);
}

.header-right a:hover::after {
  width: 100%;
}


/* Paid state */
.hero.paid{background:url('../asset/bg25.jpg') center/cover no-repeat}
#payBtn.paid-state{background-color:#1faa59 !important;cursor:default;pointer-events:none}

/* LAYOUT */
section.checkout{padding:56px 18px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0))}
.checkout-inner{max-width:1100px;margin:0 auto;display:grid;grid-template-columns:1fr 1.4fr;gap:28px;align-items:start}
@media(max-width:980px){.checkout-inner{grid-template-columns:1fr;padding:0 12px}.hero{height:30vh}}
.card{border-radius:16px;background:var(--card-bg);padding:22px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 12px 30px rgba(0,0,0,0.55)}
.checkout-form h2,.order-summary h2{font-family:"Playfair Display",serif;color:#fff;margin-bottom:12px;font-size:22px}
label{display:block;margin-bottom:6px;color:#e9e9e9;font-weight:600}
input[type="text"],input[type="email"],input[type="tel"],textarea,select{width:100%;padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:#e6e6e6;font-family:inherit;margin-bottom:12px}
textarea{min-height:120px;resize:vertical}
.order-summary ul{list-style:none;padding:0;margin:0;display:flex;flex-direction:column;gap:12px}
.order-item{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px;border-radius:12px;background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.02);transition:all var(--transition)}
.order-item .left{display:flex;gap:12px;align-items:center;flex:1;min-width:0;padding-left:0}
.order-item img{width:56px;height:56px;object-fit:cover;border-radius:8px;border:1px solid rgba(255,255,255,0.04)}
.order-item .meta,.order-item .title{font-size:0.95rem;color:var(--muted);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;text-align:left}
.order-item .title{font-weight:700;color:#fff}
.order-item .price{font-weight:700;color:var(--gold);min-width:110px;text-align:right}
.show-variants-btn{background:transparent;color:var(--muted);border:1px solid rgba(255,255,255,0.04);border-radius:8px;padding:6px 8px;cursor:pointer;font-weight:700;transition:all var(--transition);font-size:13px;margin-top:8px}
.variants-container{display:none;flex-direction:column;gap:8px;margin-top:8px;padding-left:0;border-left:2px dashed rgba(255,255,255,0.03)}
.variant-line{display:flex;justify-content:space-between;gap:12px;align-items:center;padding:8px 10px;border-radius:8px;background:rgba(255,255,255,0.01);border:1px solid rgba(255,255,255,0.02);color:var(--muted);font-size:0.95rem}
.currency-selector{display:flex;justify-content:flex-end;gap:8px;align-items:center;margin-bottom:12px}
.totals{margin-top:12px;text-align:right;font-weight:700;color:#fff;font-size:18px}
.pay-btn{display:block;width:100%;margin-top:16px;padding:14px;border-radius:12px;background:linear-gradient(180deg,var(--gold),#a55a36);color:#fff;border:none;font-weight:800;cursor:pointer;transition:transform var(--transition)}
.pay-btn:disabled{opacity:0.6;cursor:not-allowed;transform:none}
.error-banner{display:none;margin-bottom:12px;padding:12px;border-radius:8px;background:linear-gradient(180deg, rgba(255,50,50,0.12), rgba(255,30,30,0.06));color:#ffd6d6;border:1px solid rgba(255,30,30,0.12)}
.spinner-backdrop{display:none;position:fixed;top:20px;right:20px;z-index:9999;pointer-events:none;display:flex;align-items:center;justify-content:center}
.spinner{display:flex;gap:6px;padding:6px;background:rgba(0,0,0,0.6);border-radius:24px;box-shadow:0 4px 12px rgba(0,0,0,0.5);align-items:center;justify-content:center}
.spinner .dot{width:8px;height:8px;border-radius:50%;background:var(--gold);animation:bounce 1s infinite ease-in-out}
.spinner .dot:nth-child(2){animation-delay:0.2s}.spinner .dot:nth-child(3){animation-delay:0.4s}
@keyframes bounce{0%,80%,100%{transform:scale(0.8);opacity:0.6}40%{transform:scale(1.3);opacity:1}}
.note{font-size:0.95rem;color:var(--muted);margin-top:8px}
footer{text-align:center;padding:22px;background:transparent;color:var(--muted);margin-top:36px;border-top:1px solid rgba(255,255,255,0.02)}
.order-item .left{display:flex;flex-direction:column;gap:6px;min-width:0}
.show-details-btn{background:none;border:none;color:#ccc;cursor:pointer;font-size:0.95rem;padding:6px 0;text-align:left}
.details-container{flex-direction:column;padding-left:0;padding-right:0;margin-bottom:8px;border-left:2px solid rgba(255,255,255,0.03);display:none}
.details-container.show{display:flex}
.details-container div{display:flex;justify-content:space-between;font-size:0.95rem;color:#bbb;padding:6px 0;overflow:hidden;white-space:nowrap;text-overflow:ellipsis}

button:focus, a:focus, input:focus, select:focus { outline: 3px solid rgba(182,110,65,0.12); outline-offset:2px; }

 /* Chat-style floating support button */
    #floatingSupportBtn {
      position: fixed;
      bottom: 25px;
      right: 25px;
      width: 56px;
      height: 56px;
      background: #1a202b; /* Sérac primary color */
      color: #fff;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 20px rgba(182, 110, 65, 1);
      transition: all 0.3s ease;
      z-index: 9999;
    }

    #floatingSupportBtn:hover {
      background: #20232b;
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(75, 78, 84, 1.0);
    }

    /* Tooltip */
    .support-tooltip {
      position: absolute;
      bottom: 50px;      /* tooltip above button */
      left: 20%;
      transform: translateX(-50%);
      background: #1c1e22;
      color: #fff;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 14px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    #floatingSupportBtn:hover .support-tooltip {
      opacity: 1;
      transform: translateX(-50%) translateY(-6px);
    }

  
@media(max-width:980px){
  .header-right { display:none; flex-direction:column; background:rgba(20,21,23,0.98); position:absolute; top:70px; right:0; width:220px; padding:18px; border-radius:8px; z-index:1100; }
  .header-right.open { display:flex; }
  .hamburger { display:block; }
  .mobile-cart { display:flex; align-items:center; margin-right:10px; }
  .mobile-cart a { color:var(--gold); font-size:20px; position:relative; }
  .mobile-cart .cart-count { position:absolute; top:-8px; right:-8px; }
  .cart-item-header img { width:90px; height:90px; }
  .hero{height:60vh}
  .hero-text h1 { font-size:32px; }
  .small-note{color:var(--muted);padding:8px;text-align:center}
  .quantity-controls input { width:56px; }
  .site-header {
    opacity: 1;
    transition: background 0.3s ease, border-bottom 0.3s ease, opacity 0.3s ease;
  }
  .site-header.scrolled {
    background: var(--bg-dark);
    border-bottom: 1px solid rgba(255,255,255,0.06);
    opacity: 1;
  }
  .site-header:not(.scrolled) {
    opacity: 0.95;
  }

@media(max-width:680px){.order-item img{width:48px;height:48px}.brand-logo{height:48px}.hero{height:40vh}.checkout-inner{grid-template-columns:1fr;gap:20px;padding:12px}.order-item .meta{font-size:0.92rem}.order-item .price{min-width:60px;font-size:0.95rem}textarea{min-height:100px}}
  
@media(max-width:480px){
  .hero { height:40vh; margin-top:0; padding-top:80px; }
  .hero-text h1 { font-size:clamp(24px,5vw,32px); line-height:1.2; margin:0; }
  .hero-text p { font-size:clamp(14px,2.5vw,18px); margin:0 auto; }
}

</style>

<style>
@media(min-width: 200px) {
  .hero { position: relative; overflow: visible; }

  .hero-peek {
    position: absolute;
    bottom: -20px;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    height: 20px;
    border-radius: 10px / 50%;
    z-index: 2;
    box-shadow: 0 -6px 15px rgba(0,0,0,0.15);
    animation: peekFloat 2s ease-in-out infinite alternate;
  }

  .hero-peek[data-theme="dark"] {
    background: linear-gradient(to top, rgba(182,110,65,0.3), transparent);
  }

  .hero-peek[data-theme="light"] {
    background: linear-gradient(to top, rgba(255,235,200,0.35), transparent);
  }

  @keyframes peekFloat {
    0% { transform: translateX(-50%) translateY(0); opacity: 0.85; }
    100% { transform: translateX(-50%) translateY(-4px); opacity: 1; }
  }
}
</style>

  
</head>
<body>

<header class="site-header" id="siteHeader">
  <div class="header-left">
    <img src="../asset/logo.png" alt="Sérac Logo" class="brand-logo">
    <div class="brand-title">Sérac</div>
  </div>

<!-- mobile cart (visible only on small screens) -->
  <div class="mobile-cart" style="display:none;">
    <a href="../cart.html"><i class="fa-solid fa-cart-shopping"></i><span class="cart-count" id="cartCountMobile">0</span></a>
  </div>

  
  <nav class="header-right" id="headerRight">
    <a href="../index.html">Home</a>
    <a href="../shop.html">Shop</a>
    <a href="../about.html">About</a>
    <a href="../cart.html">Cart <span class="cart-count" id="cartCount">0</span></a>
    <a href="../customization.html">Customize</a>
    <a href="../contact.html">Contact</a>
    <a href="../trackorder.html">Track</a>
  </nav>
  <button class="hamburger" id="hamburger" aria-label="Menu"><span></span><span></span><span></span></button>
</header>

<section class="hero" id="heroSection" style="--hero-bg: url('../asset/bg25.jpg');">
  <div class="hero-text">
    <h1 id="heroH1">Checkout</h1>
    <p id="heroP">Complete your order — secure payment and quick processing</p>
  </div>
</section>

<section class="checkout">
  <div class="checkout-inner">
    <div class="card checkout-form" id="checkoutCard">
      <h2>Billing Details</h2>
      <div class="error-banner" id="errorBanner" role="alert"></div>
      <form id="checkoutForm" autocomplete="off" onsubmit="return false;">
        <label for="name">Full Name</label>
        <input id="name" name="fullname" type="text" placeholder="Jane Doe" required>

        <label for="email">Email</label>
        <input id="email" name="email" type="email" placeholder="you@example.com" required>

        <label for="phone">Phone</label>
        <input id="phone" name="phone" type="tel" placeholder="+2348000000000" required>

        <label for="address">Address</label>
        <textarea id="address" name="address" placeholder="Street, City, Country" required></textarea>
      </form>
    </div>

    <aside class="card order-summary" id="orderCard">
      <h2 id="orderCardTitle">Order Summary</h2>

      <div class="currency-selector" id="currencySelector" style="display:none">
        <label for="currency">Currency</label>
        <select id="currency" aria-label="Currency">
          <option value="NGN">NGN</option>
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
          <option value="GBP">GBP</option>
        </select>
      </div>

      <ul id="orderItems" aria-live="polite"></ul>

      <div class="totals" id="totalsText">Subtotal: —</div>
      <div class="note" id="feesNote">Fees does not include shipping</div>
      <div class="note">You will be redirected to payment after clicking Proceed to Payment.</div>

      <button id="payBtn" class="pay-btn" type="button">Proceed to Payment</button>
    </aside>
  </div>
</section> 

 <!-- Floating Chat-Style Support Button -->
<button id="floatingSupportBtn" aria-label="Contact Support">
  <i class="fas fa-headset"></i>
  <span class="support-tooltip">Support</span>
</button>

<footer><p>© 2025 Sérac</p></footer>

<div class="spinner-backdrop" id="spinnerBackdrop" role="status" aria-hidden="true">
  <div class="spinner" id="spinnerBox">
    <div class="dot"></div><div class="dot"></div><div class="dot"></div>
  </div>
</div>

<script src="https://checkout.flutterwave.com/v3.js"></script>

<script type="module">
/* -------------------- FIREBASE IMPORTS -------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import {
  getFirestore, doc, getDoc, collection, addDoc, updateDoc, serverTimestamp, query, where, getDocs, arrayUnion, setDoc
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

/* -------------------- CONFIG (unchanged) -------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyCuiZXHFYl1fVKnGwojavRvbekSBpkipJg",
  authDomain: "brandisby.firebaseapp.com",
  projectId: "brandisby",
  storageBucket: "brandisby.firebasestorage.app",
  messagingSenderId: "87213267039",
  appId: "1:87213267039:web:339e9fd49e3ad31f7423ea"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* -------------------- PREMIUM BLUR LOADER (NO-FLASH) -------------------- */
(function installBlurLoader() {
  try {
  const overlay = document.createElement('div');
  overlay.id = 'serac-blur-overlay';
  overlay.setAttribute('aria-hidden', 'true');
  overlay.style.position = 'fixed';
  overlay.style.inset = '0';
  overlay.style.zIndex = '9999';
  overlay.style.display = 'flex';
  overlay.style.alignItems = 'center';
  overlay.style.justifyContent = 'center';
  overlay.style.backdropFilter = 'blur(8px)';
  overlay.style.background = 'rgba(0,0,0,0.6)';
  overlay.style.transition = 'opacity 0.36s ease';
  overlay.style.opacity = '1';

  const spinner = document.createElement('div');
  spinner.id = 'serac-blur-spinner';
  spinner.style.width = '54px';
  spinner.style.height = '54px';
  spinner.style.border = '6px solid rgba(255,255,255,0.15)';
  spinner.style.borderTop = '6px solid rgba(255,255,255,0.9)';
  spinner.style.borderRadius = '50%';
  spinner.style.boxShadow = '0 6px 18px rgba(0,0,0,0.2)';
  spinner.style.animation = 'serac-spin 1s linear infinite';
  spinner.style.backgroundClip = 'padding-box';

  const label = document.createElement('div');
  label.textContent = 'Loading...';
  label.style.marginTop = '12px';
  label.style.fontSize = '13px';
  label.style.color = 'rgba(255,255,255,0.8)';
  label.style.fontFamily = 'system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial';

  const wrap = document.createElement('div');
  wrap.style.display = 'flex';
  wrap.style.flexDirection = 'column';
  wrap.style.alignItems = 'center';
  wrap.appendChild(spinner);
  wrap.appendChild(label);

  overlay.appendChild(wrap);

    const style = document.createElement('style');
    style.textContent = `
      @keyframes serac-spin { 0%{ transform: rotate(0deg);} 100%{ transform: rotate(360deg);} }
      .serac-hidden-until-ready { opacity: 0 !important; transition: opacity 0.36s ease !important; }
      .serac-revealed { opacity: 1 !important; transition: opacity 0.36s ease !important; }
    `;
    document.head.appendChild(style);

    document.documentElement.appendChild(overlay);

    const main = document.getElementById('checkout-container') || document.getElementById('checkout') || document.querySelector('main') || document.body;
    if(main) main.classList.add('serac-hidden-until-ready');
  } catch (err) { /* non-fatal */ }
})();

function removeBlurLoaderAndReveal() {
  try {
    const overlay = document.getElementById('serac-blur-overlay');
    const main = document.getElementById('checkout-container') || document.getElementById('checkout') || document.querySelector('main') || document.body;
    if (overlay) {
      overlay.style.opacity = '0';
      setTimeout(() => { try { overlay.remove(); } catch(e){} }, 380);
    }
    if (main) {
      main.classList.remove('serac-hidden-until-ready');
      main.classList.add('serac-revealed');
    }
  } catch (e) { /* ignore */ }
}

/* -------------------- HELPERS -------------------- */
function safeParseJSON(val, fallback = null) {
  try { return JSON.parse(val || 'null') || fallback; } catch (e) { return fallback; }
}
function escapeHtml(s){ if(s === undefined || s === null) return ''; return String(s).replace(/[&<>"']/g, ch => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[ch])); }
function formatPrice(val, cur = 'NGN'){ try { const locale = {USD:'en-US',EUR:'de-DE',GBP:'en-GB',NGN:'en-NG'}[cur] || 'en-US'; const minimumFractionDigits = cur==='NGN'?0:2; return new Intl.NumberFormat(locale,{style:'currency',currency:cur, minimumFractionDigits}).format(Number(val||0)); } catch(e) { return `${cur} ${Number(val||0).toFixed(2)}`; } }
function showSpinner(on = true){ const s = document.getElementById('spinnerBackdrop'); if(s) s.style.display = on ? 'flex' : 'none'; }
function showError(msg){ const el = document.getElementById('errorBanner'); if(!el){ if(msg) alert(msg); return; } if(!msg){ el.style.display='none'; el.textContent=''; } else { el.style.display='block'; el.textContent=msg; window.scrollTo({top:0, behavior:'smooth'}); } }

/* -------------------- DOM & STATE -------------------- */
const STORAGE_KEY = 'seracCart';
const CURRENCY_KEY = 'seracCurrency';
const cartCountElem = document.getElementById('cartCount');
const orderItemsEl = document.getElementById('orderItems');
const totalsText = document.getElementById('totalsText');
const payBtn = document.getElementById('payBtn');
const currencySelect = document.getElementById('currency');          // actual <select>
const currencySelector = document.getElementById('currencySelector'); // wrapper
const nameInput = document.getElementById('name');
const emailInput = document.getElementById('email');
const phoneInput = document.getElementById('phone');
const addressInput = document.getElementById('address');
const hero = document.getElementById('heroSection') || document.querySelector('.hero');
const heroH1 = document.getElementById('heroH1');
const heroP = document.getElementById('heroP');

let productCache = {};
let selectedCurrency = localStorage.getItem(CURRENCY_KEY) || 'NGN';
let cart = safeParseJSON(localStorage.getItem(STORAGE_KEY), []) || [];
const urlParams = new URLSearchParams(window.location.search);
const quoteId = urlParams.get('quoteId') || null;
const orderId = urlParams.get('orderId') || null;

let activeQuoteRaw = null;   // original quote doc
let activeOrderRaw = null;   // original order doc
let quote = null;            // normalized quote for UI
let isPaidOrder = false;


/* -------------------- CART COUNT / MODE-AWARE SYNC (desktop + mobile) -------------------- */
function totalQtyFromCartArray(arr){
  try { return (arr||[]).reduce((s,i)=>s + Number(i.quantity||0),0); } catch(e){ return 0; }
}
function totalQtyFromQuoteNormalized(q){
  try { return (q && Array.isArray(q.items)) ? q.items.reduce((s,i)=>s + Number(i.totalQuantity||0),0) : 0; } catch(e){ return 0; }
}

/* FIXED & CONSISTENT mergeCartItems (previously had a bug) */
function mergeCartItems(cartArr){
  const merged = [];
  (cartArr||[]).forEach(item=>{
    const keyMatch = i => i.id === item.id && (i.color || '') === (item.color || '') && (i.size || '') === (item.size || '');
    const idx = merged.findIndex(keyMatch);
    if(idx === -1) merged.push({...item});
    else merged[idx].quantity = Number(merged[idx].quantity || 0) + Number(item.quantity || 0);
  });
  return merged;
}

/* compute/update cart count for desktop and mobile icons */
function computeAndUpdateCartCount(){
  try {
    const rawCart = safeParseJSON(localStorage.getItem(STORAGE_KEY), []) || [];
    const mergedCart = mergeCartItems(rawCart);
    const cartQty = totalQtyFromCartArray(mergedCart);

    const isUnpaidQuoteView = (!isPaidOrder && quote && Array.isArray(quote.items) && quote.items.length > 0 && !quote._isOrder && !quote._paidFlag);

    let displayCount = cartQty;
    if (isUnpaidQuoteView) {
      const quoteQty = totalQtyFromQuoteNormalized(quote);
      if (quoteId) displayCount = Number(quoteQty || 0) + Number(cartQty || 0);
      else displayCount = cartQty;
    } else {
      displayCount = cartQty;
    }

    // Update desktop cart count
    if (typeof cartCountElem !== 'undefined' && cartCountElem)
      cartCountElem.textContent = String(displayCount || 0);

    // Update mobile cart count
    const cartCountMobile = document.getElementById('cartCountMobile');
    if (cartCountMobile)
      cartCountMobile.textContent = String(displayCount || 0);

  } catch(e){
    if(cartCountElem) cartCountElem.textContent = '0';
    const cartCountMobile = document.getElementById('cartCountMobile');
    if (cartCountMobile) cartCountMobile.textContent = '0';
  }
}

/* react to storage changes from other tabs */
window.addEventListener('storage', (e)=>{
  if(e.key === STORAGE_KEY || e.key === CURRENCY_KEY || e.key === 'paidQuoteInfo'){
    computeAndUpdateCartCount();
  }
  if(e.key === 'paidQuoteInfo'){
    const paid = safeParseJSON(localStorage.getItem('paidQuoteInfo'), null);
    if(paid && paid.verified) syncPaidQuoteUI().catch(()=>{});
  }
});

/* Initialize on load */
document.addEventListener('DOMContentLoaded', computeAndUpdateCartCount);

  
/* -------------------- PRODUCT HELPERS (used for cart->quote building) -------------------- */
async function fetchProductData(productId){
  try {
    if(productCache[productId]) return productCache[productId];
    const snap = await getDoc(doc(db, "brands", "serac", "products", productId));
    if(snap.exists()){ productCache[productId] = snap.data(); return productCache[productId]; }
  } catch(e){ console.warn("fetchProductData failed", e); }
  return null;
}

/* buildQuoteFromCart uses corrected mergeCartItems to avoid duplicate counting */
async function buildQuoteFromCart(){
  cart = mergeCartItems(cart || []);
  const byProduct = new Map();
  cart.forEach(r=> { if(!byProduct.has(r.id)) byProduct.set(r.id, []); byProduct.get(r.id).push(r); });
  const ids = Array.from(byProduct.keys());
  const pdPromises = ids.map(id => fetchProductData(id).then(d=>[id,d]));
  const pd = await Promise.all(pdPromises);
  const productsMap = Object.fromEntries(pd.map(([id,doc])=>[id,doc]));
  const items = [];
  for(const id of ids){
    const rows = byProduct.get(id) || [];
    const productDoc = productsMap[id] || null;
    const image = productDoc?.images?.[0] || productDoc?.imageUrl || null;
    const name = productDoc?.name || rows[0]?.name || 'Product';
    const variants = rows.map(r=>{
      const qty = Number(r.quantity||1);
      const unitPrices = {
        NGN: Number(productDoc?.priceNGN ?? r.price ?? 0),
        USD: Number(productDoc?.priceUSD ?? 0),
        EUR: Number(productDoc?.priceEUR ?? 0),
        GBP: Number(productDoc?.priceGBP ?? 0)
      };
      return { id: r.id||id, color:r.color||'', size:r.size||'', quantity:qty, unitPrices, linePrices:{
        NGN: unitPrices.NGN*qty, USD: unitPrices.USD*qty, EUR: unitPrices.EUR*qty, GBP: unitPrices.GBP*qty
      } };
    });
    const totalQty = variants.reduce((s,v)=>s+v.quantity,0);
    const totalPrices = { NGN:0, USD:0, EUR:0, GBP:0 };
    variants.forEach(v=>{ totalPrices.NGN += v.linePrices.NGN||0; totalPrices.USD += v.linePrices.USD||0; totalPrices.EUR += v.linePrices.EUR||0; totalPrices.GBP += v.linePrices.GBP||0; });
    items.push({ productId:id, name, image, totalQuantity: totalQty, totalPrices, variants, description: productDoc?.description||'' });
  }
  return { items };
}

/* -------------------- NORMALIZERS (unchanged) -------------------- */
function normalizeQuoteItems(rawQuote){
  const arr = Array.isArray(rawQuote.items) ? rawQuote.items : [];
  const items = arr.map(ci => {
    if(Array.isArray(ci.variants) && ci.variants.length){
      const variants = ci.variants.map(v => {
        const qty = Number(v.qty || v.quantity || 0);
        const unitPrices = {
          NGN: Number(v.priceNGN ?? v.price ?? 0),
          USD: Number(v.priceUSD ?? 0),
          EUR: Number(v.priceEUR ?? 0),
          GBP: Number(v.priceGBP ?? 0)
        };
        return {
          id: v.id || ci.id || '',
          color: v.color||'',
          size: v.size||'',
          quantity: qty,
          unitPrices,
          linePrices: { NGN: unitPrices.NGN*qty, USD: unitPrices.USD*qty, EUR: unitPrices.EUR*qty, GBP: unitPrices.GBP*qty }
        };
      });
      return {
        productId: ci.id || '',
        name: ci.name || '',
        image: (ci.image && ci.image !== '../asset/placeholder.jpg') ? ci.image : null,
        totalQuantity: variants.reduce((s,a)=>s+(a.quantity||0),0),
        totalPrices: {
          NGN: variants.reduce((s,a)=>s+(a.linePrices.NGN||0),0),
          USD: variants.reduce((s,a)=>s+(a.linePrices.USD||0),0),
          EUR: variants.reduce((s,a)=>s+(a.linePrices.EUR||0),0),
          GBP: variants.reduce((s,a)=>s+(a.linePrices.GBP||0),0)
        },
        variants,
        description: ci.desc || ci.description || ''
      };
    } else {
      const qty = Number(ci.qty || ci.quantity || 1);
      const unitPrices = { NGN: Number(ci.priceNGN ?? ci.price ?? 0), USD: Number(ci.priceUSD ?? 0), EUR: Number(ci.priceEUR ?? 0), GBP: Number(ci.priceGBP ?? 0) };
      return {
        productId: ci.id || '',
        name: ci.name || '',
        image: (ci.image && ci.image !== '../asset/placeholder.jpg') ? ci.image : null,
        totalQuantity: qty,
        totalPrices: { NGN: unitPrices.NGN*qty, USD: unitPrices.USD*qty, EUR: unitPrices.EUR*qty, GBP: unitPrices.GBP*qty },
        variants: [{ id:ci.id||'', color:'', size:'', quantity: qty, unitPrices, linePrices: { NGN: unitPrices.NGN*qty, USD: unitPrices.USD*qty, EUR: unitPrices.EUR*qty, GBP: unitPrices.GBP*qty } }],
        description: ci.desc || ci.description || ''
      };
    }
  });
  const normalized = { items };
  normalized._isOrder = false;
  normalized._paidFlag = (rawQuote && (rawQuote.status || '').toLowerCase() === 'paid') || false;
  return normalized;
}
function normalizeOrderItems(items){
  const normalized = (items||[]).map(it => ({
    productId: it.id || '',
    name: it.name || it.productName || '',
    image: (it.image && it.image !== '../asset/placeholder.jpg') ? it.image : null,
    totalQuantity: Number(it.qty || it.quantity) || 1,
    description: it.description || '',
    totalPrices: it.totalPrices || it.linePrices || {},
    variants: it.variants || []
  }));
  const result = { items: normalized };
  result._isOrder = true;
  result._paidFlag = true;
  return result;
}

/* -------------------- RENDER ORDER/QUOTE UI (unchanged but preserved) -------------------- */
function renderOrderFromQuoteNormalized(quoteNormalized, currency='NGN', paid=false){
  if(!orderItemsEl || !totalsText) return;
  orderItemsEl.innerHTML = '';
  if(!quoteNormalized || !Array.isArray(quoteNormalized.items)) {
    orderItemsEl.innerHTML = '<li class="small-note">No items</li>';
    totalsText.textContent = `Subtotal: —`;
    computeAndUpdateCartCount();
    return;
  }
  let subtotal = 0;
  quoteNormalized.items.forEach((item, idx) => {
    const value = (item.totalPrices && (item.totalPrices[currency] ?? 0)) || 0;
    subtotal += value;
    const li = document.createElement('li');
    li.className = 'order-item';
    li.dataset.idx = String(idx);
    const imageHtml = item.image ? `<img src="${escapeHtml(item.image)}" alt="${escapeHtml(item.name)}">` : '';
    if(paid){
      li.innerHTML = `
        <div class="left" style="flex-direction:row;align-items:center;">
          ${imageHtml}
          <div style="min-width:0">
            <div class="title">${escapeHtml(item.name)}</div>
            <div class="meta">${escapeHtml(String(item.totalQuantity) + ' item(s)')}</div>
            <button class="show-details-btn" data-idx="${idx}">Show Details ▾</button>
          </div>
        </div>
        <div class="price">${formatPrice(value, currency)}</div>`;
      orderItemsEl.appendChild(li);
      const details = document.createElement('div');
      details.className = 'details-container';
      details.dataset.forIdx = String(idx);
      details.style.display = 'none';
      details.innerHTML = `<div style="padding:8px;color:var(--muted)">${escapeHtml(item.description||'')}</div>`;
      li.insertAdjacentElement('afterend', details);
    } else {
      li.innerHTML = `
        <div class="left" style="flex-direction:row;align-items:center;">
          ${imageHtml}
          <div style="min-width:0">
            <div class="title">${escapeHtml(item.name)}</div>
            <div class="meta">${escapeHtml(String(item.totalQuantity) + ' item(s)')}</div>
            ${ (Array.isArray(item.variants) && item.variants.length > 1) ? `<button class="show-variants-btn" data-idx="${idx}">Show Choices ▾</button>` : '' }
            <button class="show-details-btn" data-idx="${idx}" style="margin-top:6px;">Show Details ▾</button>
          </div>
        </div>
        <div class="price">${formatPrice(value, currency)}</div>`;
      orderItemsEl.appendChild(li);
      if(Array.isArray(item.variants) && item.variants.length){
        const variantsContainer = document.createElement('div');
        variantsContainer.className = 'variants-container';
        variantsContainer.dataset.forIdx = String(idx);
        variantsContainer.style.display = 'none';
        item.variants.forEach(v=>{
          const line = document.createElement('div');
          line.className = 'variant-line';
          const labelParts = [];
          if(v.color) labelParts.push(escapeHtml(v.color));
          if(v.size) labelParts.push(escapeHtml(v.size));
          const label = labelParts.length ? `${labelParts.join(' · ')} ×${v.quantity}` : `×${v.quantity}`;
          const linePrice = (v.linePrices && (v.linePrices[selectedCurrency] ?? 0)) || 0;
          line.innerHTML = `<div style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${label}</div><div style="min-width:110px;text-align:right;color:var(--muted)">${formatPrice(linePrice, selectedCurrency)}</div>`;
          variantsContainer.appendChild(line);
        });
        li.insertAdjacentElement('afterend', variantsContainer);
      }
      const details = document.createElement('div');
      details.className = 'details-container';
      details.dataset.forIdx = String(idx);
      details.style.display = 'none';
      details.innerHTML = `<div style="padding:8px;color:var(--muted)">${escapeHtml(item.description||'')}</div>`;
      li.insertAdjacentElement('afterend', details);
    }
  });

  document.querySelectorAll('.show-variants-btn').forEach(btn=>{
    btn.removeEventListener('click', onShowVariants);
    btn.addEventListener('click', onShowVariants);
  });
  document.querySelectorAll('.show-details-btn').forEach(btn=>{
    btn.removeEventListener('click', onShowDetails);
    btn.addEventListener('click', onShowDetails);
  });

  totalsText.textContent = `Subtotal: ${formatPrice(subtotal, selectedCurrency)}`;

  computeAndUpdateCartCount();
}
function onShowVariants(ev){ const idx = ev.currentTarget.dataset.idx; const c = document.querySelector(`.variants-container[data-for-idx="${idx}"]`); if(!c) return; const shown = c.classList.toggle('show'); c.style.display = shown ? 'flex' : 'none'; ev.currentTarget.textContent = shown ? 'Hide Choices ▴' : 'Show Choices ▾'; }
function onShowDetails(ev){ const idx = ev.currentTarget.dataset.idx; const c = document.querySelector(`.details-container[data-for-idx="${idx}"]`); if(!c) return; const shown = c.classList.toggle('show'); c.style.display = shown ? 'flex' : 'none'; ev.currentTarget.textContent = shown ? 'Hide Details ▴' : 'Show Details ▴'; }

/* -------------------- FILL BILLING FIELDS -------------------- */
function fillBillingFields(data){
  if(nameInput) nameInput.value = data.name || data.customer || '';
  if(emailInput) emailInput.value = data.email || data.customerEmail || '';
  if(phoneInput) phoneInput.value = data.phone || data.phoneNumber || '';
  if(addressInput) addressInput.value = data.address || data.shippingAddress || '';
}

/* -------------------- UI CONFIGURATOR (unchanged) -------------------- */
function configureCheckoutUI(type, opts = {}) {
  try {
    const disableCurrency = (val) => {
      if(currencySelect) currencySelect.disabled = val;
      if(currencySelector) {
        currencySelector.style.opacity = val ? '0.6' : '1';
        currencySelector.style.pointerEvents = val ? 'none' : 'auto';
        currencySelector.style.display = (type === 'quote-unpaid' ? 'flex' : currencySelector.style.display || (type === 'cart' ? 'none' : 'flex'));
      }
    };

    const billingFields = [nameInput, emailInput, phoneInput, addressInput].filter(Boolean);
    const setBillingDisabled = (v) => billingFields.forEach(f => f.disabled = !!v);

    if(type === 'cart'){
      disableCurrency(true);
      setBillingDisabled(false);
      if(payBtn) { payBtn.textContent = 'Proceed to Payment'; payBtn.disabled = false; payBtn.classList.remove('paid-state'); payBtn.dataset.processing = '0'; }
      if(hero) { hero.classList.remove('paid'); if(heroH1) heroH1.textContent = 'Checkout'; if(heroP) heroP.textContent = 'Review your items and proceed to payment.'; }
      const t = document.getElementById('trackingRefDisplay'); if(t) t.style.display = 'none';
    }

    if(type === 'quote-unpaid'){
      disableCurrency(false);
      setBillingDisabled(false);
      if(payBtn) { payBtn.textContent = 'Proceed to Payment'; payBtn.disabled = false; payBtn.classList.remove('paid-state'); payBtn.dataset.processing = '0'; }
      if(hero) { hero.classList.remove('paid'); if(heroH1) heroH1.textContent = 'Quote Checkout'; if(heroP) heroP.textContent = 'Review your items and proceed to payment.'; }
      const t = document.getElementById('trackingRefDisplay'); if(t) t.style.display = 'none';
    }

    if(type === 'quote-paid' || type === 'order-paid'){
      disableCurrency(true);
      setBillingDisabled(true);
      if(payBtn) { payBtn.textContent = 'Paid ✅'; payBtn.disabled = true; payBtn.classList.add('paid-state'); }
      if(hero) { hero.classList.add('paid'); if(heroH1) heroH1.textContent = 'Order Summary'; if(heroP) heroP.textContent = 'Your order has been paid successfully.'; }
      if(orderItemsEl) orderItemsEl.style.display = 'block';
      const t = document.getElementById('trackingRefDisplay'); if(t){ t.style.display = 'block'; if(opts.trackingRef) t.textContent = `Order Reference: ${opts.trackingRef}`; }
    }
  } catch(e){ console.warn('configureCheckoutUI error', e); }
}

/* -------------------- RENDER PAID UI (unchanged) -------------------- */
function renderPaidUIFromDoc(docData){
  const normalized = (docData.items && Array.isArray(docData.items)) ? normalizeOrderItems(docData.items) : normalizeQuoteItems(docData);
  normalized._isOrder = true;
  normalized._paidFlag = true;

  isPaidOrder = true;
  quote = normalized;
  renderOrderFromQuoteNormalized(normalized, selectedCurrency, true);

  if(hero) hero.classList.add('paid');
  if(heroH1) heroH1.textContent = "Order Summary";
  if(heroP) heroP.textContent = "Your order has been paid successfully.";

  let trackingElem = document.getElementById('trackingRefDisplay');
  if(!trackingElem){
    trackingElem = document.createElement('p');
    trackingElem.id = 'trackingRefDisplay';
    trackingElem.style.marginTop = '12px';
    trackingElem.style.color = 'var(--accent)';
    trackingElem.style.fontWeight = '600';
    if(heroP && heroP.parentNode) heroP.parentNode.insertBefore(trackingElem, heroP.nextSibling);
    else if(hero) hero.appendChild(trackingElem);
  }
  trackingElem.textContent = docData.trackingRef ? `Order Reference: ${docData.trackingRef}` : '';

  fillBillingFields(docData);
  if(currencySelect && currencySelector){ currencySelect.value = docData.currency || selectedCurrency; currencySelect.disabled = true; currencySelector.style.opacity = 0.6; currencySelector.style.pointerEvents = 'none'; }
  if(payBtn){ payBtn.textContent = 'Paid ✅'; payBtn.disabled = true; payBtn.classList.add('paid-state'); }

  configureCheckoutUI(orderId ? 'order-paid' : 'quote-paid', { trackingRef: docData.trackingRef });

  localStorage.setItem('paidQuoteInfo', JSON.stringify({
    quoteId: docData.id || null,
    currency: docData.currency || selectedCurrency,
    billing: { name: docData.name || '', email: docData.email || '', phone: docData.phone || '', address: docData.address || '' },
    trackingRef: docData.trackingRef || null,
    verified: true
  }));

  computeAndUpdateCartCount();
}

/* -------------------- SYNC PAID QUOTE ON LOAD (unchanged) -------------------- */
async function syncPaidQuoteUI(){
  const paidQuoteInfo = safeParseJSON(localStorage.getItem('paidQuoteInfo'), null);
  if(!paidQuoteInfo) {
    removeBlurLoaderAndReveal();
    return;
  }
  renderPaidUIFromDoc({
    id: paidQuoteInfo.quoteId,
    trackingRef: paidQuoteInfo.trackingRef,
    currency: paidQuoteInfo.currency,
    name: paidQuoteInfo.billing?.name,
    email: paidQuoteInfo.billing?.email,
    phone: paidQuoteInfo.billing?.phone,
    address: paidQuoteInfo.billing?.address,
    items: []
  });
  configureCheckoutUI(quoteId ? 'quote-paid' : 'order-paid', { trackingRef: paidQuoteInfo.trackingRef });

  try {
    if(paidQuoteInfo.quoteId){
      const docSnap = await getDoc(doc(db, "brands", "serac", "quotes", paidQuoteInfo.quoteId));
      if(docSnap.exists()){
        const q = docSnap.data(); q.id = paidQuoteInfo.quoteId;
        if((q.status || '').toLowerCase() === 'paid' && q.orderId){
          const orderSnap = await getDoc(doc(db, "brands", "serac", "orders", q.orderId));
          if(orderSnap.exists()){
            const o = orderSnap.data(); o.id = orderSnap.id;
            renderPaidUIFromDoc(o);
            removeBlurLoaderAndReveal();
            return;
          }
        }
        renderPaidUIFromDoc(q);
        removeBlurLoaderAndReveal();
      } else {
        removeBlurLoaderAndReveal();
      }
    } else {
      removeBlurLoaderAndReveal();
    }
  } catch(e){ console.error('syncPaidQuoteUI failed', e); removeBlurLoaderAndReveal(); }
}

/* -------------------- ORDER REFERENCE GENERATOR & SAVE ORDER (unchanged except setDoc import used) -------------------- */
function generateOrderReference(email, orderId, txRef){
  const rand = () => Math.random().toString(36).substring(2,6).toUpperCase();
  const now = new Date();
  const day = String(now.getDate()).padStart(2,'0');
  const month = now.toLocaleString('en',{month:'short'}).toUpperCase();
  const year = String(now.getFullYear()).slice(-2);
  const emailPrefix = email ? email.split('@')[0].slice(0,3).toUpperCase() : "SR";
  const shortTx = txRef ? txRef.slice(-4).toUpperCase() : rand();
  return `${emailPrefix}-${day}${month}${year}-${shortTx}`;
}
async function persistPaidOrder(orderData, txRef) {
  try {
    const trackingRef = generateOrderReference(orderData.email, orderData.id || "", txRef);

    // Save order using trackingRef as doc ID
    const docRef = doc(db, "brands", "serac", "orders", trackingRef);
    await setDoc(docRef, {
      ...orderData,
      createdAt: serverTimestamp(),
      verifiedAt: serverTimestamp(),
      status: "paid",
      trackingRef
    });

    // Update related quote if exists
    if(orderData.source?.startsWith('quote:')){
      const qid = orderData.source.split('quote:')[1];
      if(qid){
        await updateDoc(doc(db, "brands", "serac", "quotes", qid), {
          status: "Paid",
          orderId: trackingRef,
          paidAt: serverTimestamp(),
          trackingRef
        });
      }
    }

    return { orderId: trackingRef, trackingRef };
  } catch(e){
    console.error("persistPaidOrder failed", e);
    return null;
  }
}

/* -------------------- PAYMENT FLOW (FLUTTERWAVE) (unchanged) -------------------- */
const FLW_PUBLIC_KEY = "FLWPUBK_TEST-07eb9d2da345c08dc4d54278c3bc86f7-X";
const SERVERLESS_VERIFY = `${window.location.origin}/api/verify`;

async function fetchWithRetry(url, options={}, retries=1, backoff=500){
  try { const r = await fetch(url, options); if(!r.ok) throw new Error('HTTP '+r.status); return r; }
  catch(err){ if(retries>0){ await new Promise(res=>setTimeout(res, backoff)); return fetchWithRetry(url, options, retries-1, Math.round(backoff*1.5)); } throw err; }
}
async function verifyPayment(payload){
  try {
    const opts = { method: 'POST', headers: {'Content-Type':'application/json','Connection':'close'}, body: JSON.stringify(payload), cache:'no-store', mode:'cors', credentials:'omit', keepalive:true };
    const res = await fetchWithRetry(SERVERLESS_VERIFY, opts, 1);
    return await res.json();
  } catch(e){ console.error('verifyPayment error', e); throw e; }
}

/* initiatePaymentFlow copied exactly from your original (preserved) */
async function initiatePaymentFlow(ev){
  if(ev && ev.preventDefault) ev.preventDefault();
  if(isPaidOrder) return;
  showError('');

  const name = (nameInput?.value||'').trim();
  const email = (emailInput?.value||'').trim();
  const phone = (phoneInput?.value||'').trim();
  const address = (addressInput?.value||'').trim();
  if(!name) return showError('Name is required.');
  if(!/^\S+@\S+\.\S+$/.test(email)) return showError('Please provide a valid email.');
  if(!phone) return showError('Phone is required.');
  if(!address) return showError('Address is required.');
  if(!quote || !Array.isArray(quote.items) || quote.items.length === 0) return showError('Cart is empty.');

  let subtotal = 0;
  quote.items.forEach(it => { subtotal += Number(it.totalPrices?.[selectedCurrency] ?? 0); });
  if(subtotal <= 0) return showError('Subtotal is zero. Cannot proceed.');

  if(payBtn?.dataset.processing === '1') return;
  if(payBtn){ payBtn.dataset.processing = '1'; payBtn.disabled = true; }

  showSpinner(true);

  const baseOrder = {
    name, email, phone, address,
    currency: selectedCurrency,
    items: quote.items,
    total: subtotal,
    status: 'placed',
    source: quoteId ? `quote:${quoteId}` : 'cart',
    createdAt: new Date().toISOString()
  };

  const txRef = 'serac_' + Date.now();
  let paymentCallbackHandled = false;

  async function finalizeAfterSuccess(verifyResp){
  try {
    const saved = await persistPaidOrder(baseOrder, txRef);
    const finalOrderId = saved?.orderId || null;
    const trackingRef = saved?.trackingRef || generateOrderReference(baseOrder.email, finalOrderId||'', txRef);

    if(!quoteId) localStorage.removeItem(STORAGE_KEY);

    const active = { ...baseOrder, id: finalOrderId, orderId: finalOrderId, status: 'paid', trackingRef };
    activeOrderRaw = active;
    quote = { items: active.items || [] };
    quote._isOrder = true;
    quote._paidFlag = true;
    isPaidOrder = true;

    renderPaidUIFromDoc(active);

    localStorage.setItem('paidQuoteInfo', JSON.stringify({
      quoteId: quoteId || null,
      currency: selectedCurrency,
      billing: { 
        name: active.name, 
        email: active.email, 
        phone: active.phone, 
        address: active.address 
      },
      trackingRef,
      verified: true
    }));

    // ✅ Save complete order details for thankyou.html
    localStorage.setItem('lastOrder_serac', JSON.stringify({
      id: finalOrderId,
      trackingRef,
      name: active.name,
      email: active.email,
      phone: active.phone,
      address: active.address,
      currency: selectedCurrency,
      total: subtotal,
      items: quote.items,
      status: 'paid',
      verified: true,
      createdAt: new Date().toISOString()
    }));

    showSpinner(false);

    // ✅ Redirect with correct path and orderId
    window.location.assign('/Serac/thankyou.html?orderId=' + encodeURIComponent(finalOrderId));

  } catch(e){
    console.error('finalizeAfterSuccess error', e);
    showSpinner(false);
    showError('Payment verified but finalisation failed. Contact support with tx_ref: ' + txRef);
    if(payBtn){ 
      payBtn.disabled = false; 
      payBtn.dataset.processing = '0'; 
    }
  }
}
  
  const fwConfig = {
    public_key: FLW_PUBLIC_KEY,
    tx_ref: txRef,
    amount: Number(subtotal),
    currency: selectedCurrency,
    customer: { email: baseOrder.email, phonenumber: baseOrder.phone, name: baseOrder.name },
    customizations: { title: "Sérac", description: "Order Payment", logo: "/asset/logo.png" },

    callback: async function(data){
      if(paymentCallbackHandled) return;
      paymentCallbackHandled = true;
      showSpinner(true);
      try {
        const flwId = data?.data?.id || data.id || data.transaction_id || null;
        if(!flwId) throw new Error('Missing transaction ID from Flutterwave');
        const payload = { transaction_id: flwId, tx_ref: data.tx_ref || txRef, expectedAmount: subtotal, currency: selectedCurrency, orderData: baseOrder, quoteId: quoteId || null };
        const verifyResp = await verifyPayment(payload);
        if(verifyResp && ((verifyResp.status === 'success') || (verifyResp.success === true) || (verifyResp.verified === true) || (verifyResp.data?.status === 'successful'))){
          await finalizeAfterSuccess(verifyResp);
        } else {
          showSpinner(false);
          showError('Payment verification failed. Contact support with tx_ref: ' + txRef);
          if(payBtn){ payBtn.disabled = false; payBtn.dataset.processing = '0'; }
        }
      } catch(e){
        console.error('Verification error', e);
        showSpinner(false);
        showError('Payment succeeded but could not be verified. Contact support.');
        if(payBtn){ payBtn.disabled = false; payBtn.dataset.processing = '0'; }
      }
    },

    onclose: function(){
      if(paymentCallbackHandled) return;
      paymentCallbackHandled = true;
      showSpinner(false);
      showError('Payment was cancelled. Please complete your checkout.');
      if(payBtn){ payBtn.disabled = false; payBtn.dataset.processing = '0'; }
    }
  };

  try { FlutterwaveCheckout(fwConfig); }
  catch(err){ showSpinner(false); if(payBtn){ payBtn.disabled = false; payBtn.dataset.processing = '0'; } console.error('Flutterwave failed', err); showError('Payment gateway unavailable. Try again later.'); }

  let attempts = 0; const maxAttempts = 6;
  const poll = setInterval(async ()=>{
    if(paymentCallbackHandled) return clearInterval(poll);
    attempts++;
    try {
      const res = await verifyPayment({ tx_ref: txRef, orderData: baseOrder, expectedAmount: subtotal, currency: selectedCurrency });
      if(res && ((res.status === 'success') || (res.success === true) || (res.verified === true) || (res.data?.status === 'successful'))){
        clearInterval(poll); paymentCallbackHandled = true; await finalizeAfterSuccess(res);
      }
    } catch(e){
      if(attempts >= maxAttempts){ clearInterval(poll); showSpinner(false); showError('Automatic verification failed. Contact support with tx_ref: ' + txRef); if(payBtn){ payBtn.disabled = false; payBtn.dataset.processing = '0'; } }
    }
  }, 3000);
}

/* -------------------- LOAD CHECKOUT DATA: (order -> quote -> cart) -------------------- */
async function loadCheckoutData(){
  selectedCurrency = localStorage.getItem(CURRENCY_KEY) || selectedCurrency || 'NGN';
  if(currencySelect) currencySelect.value = selectedCurrency;
  if(currencySelector) currencySelector.style.display = quoteId ? 'flex' : (currencySelector.style.display || 'none');

  try {
    showSpinner(true);

    // 1) orderId param -> fetch order and render paid summary
    if(orderId){
      try {
        const snap = await getDoc(doc(db, "brands", "serac", "orders", orderId));
        if(snap.exists()){
          const data = snap.data(); data.id = snap.id;
          activeOrderRaw = data;
          fillBillingFields(data);
          renderPaidUIFromDoc(data);
          showSpinner(false);
          removeBlurLoaderAndReveal();
          return;
        }
      } catch(e){ console.error("Error loading order by id", e); }
    }

    // 2) quoteId param -> fetch quote doc
    if(quoteId){
      const qSnap = await getDoc(doc(db, "brands", "serac", "quotes", quoteId));
      if(!qSnap.exists()){ showSpinner(false); removeBlurLoaderAndReveal(); showError('Quote not found.'); return; }
      activeQuoteRaw = qSnap.data(); activeQuoteRaw.id = qSnap.id;
      const qStatus = (activeQuoteRaw.status || '').toLowerCase();

      if(qStatus === 'paid' && activeQuoteRaw.orderId){
        const orderSnap = await getDoc(doc(db, "brands", "serac", "orders", activeQuoteRaw.orderId));
        if(orderSnap.exists()){
          const orderData = orderSnap.data(); orderData.id = orderSnap.id;
          activeOrderRaw = orderData;
          fillBillingFields(orderData);
          renderPaidUIFromDoc(orderData);
          showSpinner(false);
          removeBlurLoaderAndReveal();
          return;
        } else {
          isPaidOrder = true;
          renderPaidUIFromDoc(activeQuoteRaw);
          showSpinner(false);
          removeBlurLoaderAndReveal();
          return;
        }
      }

      if(activeQuoteRaw.customer && nameInput) nameInput.value = activeQuoteRaw.customer;
      if(activeQuoteRaw.email && emailInput) emailInput.value = activeQuoteRaw.email;
      quote = normalizeQuoteItems(activeQuoteRaw);
      quote._isOrder = false;
      quote._paidFlag = (activeQuoteRaw.status || '').toLowerCase() === 'paid';
      renderOrderFromQuoteNormalized(quote, selectedCurrency, false);
      configureCheckoutUI('quote-unpaid');
      setCheckoutUI();
      showSpinner(false);
      removeBlurLoaderAndReveal();
      return;
    }

    // 3) Cart view
    cart = safeParseJSON(localStorage.getItem(STORAGE_KEY), []) || [];
    cart = mergeCartItems(cart);
    if(!cart.length){
      quote = { items: [] };
      renderOrderFromQuoteNormalized(quote, selectedCurrency, false);
      showSpinner(false);
      showError('Your cart is empty.');
      configureCheckoutUI('cart');
      removeBlurLoaderAndReveal();
      return;
    }
    // compute and update cart count (fixes duplication)
    computeAndUpdateCartCount();

    quote = await buildQuoteFromCart();
    quote._isOrder = false;
    quote._paidFlag = false;
    renderOrderFromQuoteNormalized(quote, selectedCurrency, false);
    configureCheckoutUI('cart');
    setCheckoutUI();
    showSpinner(false);
    removeBlurLoaderAndReveal();
  } catch(e){
    showSpinner(false);
    console.error('loadCheckoutData failed', e);
    showError('Failed to load checkout data. Refresh and try again.');
    removeBlurLoaderAndReveal();
  }
}

/* -------------------- SET CHECKOUT UI (unpaid) -------------------- */
function setCheckoutUI(){
  if(hero) hero.classList.remove('paid');
  if(heroH1) heroH1.textContent = quoteId ? 'Quote Checkout' : 'Checkout';
  if(heroP) heroP.textContent = 'Review your items and proceed to payment.';
  if(payBtn){ payBtn.textContent = 'Proceed to Payment'; payBtn.disabled = false; payBtn.classList.remove('paid-state'); payBtn.dataset.processing = '0'; }
  computeAndUpdateCartCount();
}

/* -------------------- BINDINGS -------------------- */
if(payBtn) payBtn.addEventListener('click', initiatePaymentFlow);
if(currencySelect) currencySelect.addEventListener('change', ()=>{ selectedCurrency = currencySelect.value; localStorage.setItem(CURRENCY_KEY, selectedCurrency); if(quote) renderOrderFromQuoteNormalized(quote, selectedCurrency, isPaidOrder); });

/* -------------------- HEADER/HERO BEHAVIOR (with hamburger awareness) -------------------- */
/* -------------------- HEADER/HERO BEHAVIOR (safe version – works with existing hamburger) -------------------- */
(function headerHeroBehavior(){
  const headerEl = document.querySelector('.site-header');
  const heroEl =
    document.querySelector('.hero') ||
    document.getElementById('heroSection') ||
    document.querySelector('.hero-about');
  const hamburger = document.getElementById('hamburger');
  if(!headerEl || !heroEl) return;

  let lastY = window.scrollY || 0;
  let hidden = false;
  let heroHeight = Math.round(heroEl.getBoundingClientRect().height);
  let hoverShown = false;

  function isMenuOpen(){
    return hamburger && hamburger.classList.contains('open');
  }

  function handleScroll(){
    const y = window.scrollY || 0;
    const menuOpen = isMenuOpen();

    // turn header dark after hero
    if(y > Math.max(50, heroHeight - 80))
      headerEl.classList.add('scrolled');
    else
      headerEl.classList.remove('scrolled');

    // if hamburger menu open, force header visible
    if(menuOpen){
      headerEl.style.top = '0';
      headerEl.style.opacity = '1';
      headerEl.style.pointerEvents = 'auto';
      return;
    }

    if(y > heroHeight - 80){
      if(y > lastY && !hidden){
        headerEl.style.top = '-90px';
        headerEl.style.opacity = '0';
        headerEl.style.pointerEvents = 'none';
        hidden = true;
      } else if(y < lastY && hidden){
        headerEl.style.top = '0';
        headerEl.style.opacity = '1';
        headerEl.style.pointerEvents = 'auto';
        headerEl.classList.add('scrolled');
        hidden = false;
      }
    } else {
      headerEl.style.top = '0';
      headerEl.style.opacity = '1';
      headerEl.style.pointerEvents = 'auto';
      headerEl.classList.remove('scrolled');
      hidden = false;
    }

    lastY = y;
  }

  // hover reveal (disabled when menu open)
  document.addEventListener('mousemove', (e) => {
    if(isMenuOpen()) return;

    if(e.clientY < 100){
      if(hidden){
        headerEl.style.top = '0';
        headerEl.style.opacity = '1';
        headerEl.style.pointerEvents = 'auto';
        headerEl.classList.add('scrolled');
        hidden = false;
        hoverShown = true;
      }
    } else if(hoverShown){
      setTimeout(()=>{
        if(window.scrollY > heroHeight - 80 && !isMenuOpen()){
          headerEl.style.top = '-90px';
          headerEl.style.opacity = '0';
          headerEl.style.pointerEvents = 'none';
          hidden = true;
        }
        hoverShown = false;
      }, 220);
    }
  });

  // when hamburger opens/closes, re-evaluate visibility
  if(hamburger){
    hamburger.addEventListener('click', () => {
      setTimeout(handleScroll, 200); // slight delay ensures proper detection
    });
  }

  window.addEventListener('resize', () => {
    heroHeight = Math.round(heroEl.getBoundingClientRect().height);
    handleScroll();
  }, { passive: true });

  window.addEventListener('scroll', handleScroll, { passive: true });
  window.addEventListener('load', () => {
    heroHeight = Math.round(heroEl.getBoundingClientRect().height);
    handleScroll();
  });
})();

/* -------------------- MOBILE CART ICON (show on small screens) -------------------- */
/* mobile cart visibility */
function handleMobileCart(){ 
  const el = document.querySelector('.mobile-cart');
  if(!el) return;
  el.style.display = window.innerWidth <= 900 ? 'flex' : 'none';
}
window.addEventListener('resize', handleMobileCart);
handleMobileCart();

/* header scrolled background (simple fallback) */
window.addEventListener('scroll', ()=>{
  const header = document.querySelector('.site-header');
  if(!header) return;
  if(window.scrollY > 50) header.classList.add('scrolled'); else header.classList.remove('scrolled');
});

/* storage sync (other tabs) */
window.addEventListener('storage', ()=>{
  cart = loadCartFromStorage();
  cart = mergeCartItems(cart);
  updateCartCount();
  renderCart();
});

/* -------------------- INIT -------------------- */
(async function init(){
  try { if(currencySelect) currencySelect.value = selectedCurrency; } catch(e){}
  try { computeAndUpdateCartCount(); } catch(e){}
  const paidQuoteInfo = safeParseJSON(localStorage.getItem('paidQuoteInfo'), null);
  if(quoteId && paidQuoteInfo && paidQuoteInfo.verified && paidQuoteInfo.quoteId === quoteId){
    await syncPaidQuoteUI();
  } else {
    await loadCheckoutData();
  }
})();

/* -------------------- suppress known noisy errors from FP/Flutterwave -------------------- */
window.addEventListener('error', (e)=>{
  try {
    const msg = (e && e.message) ? e.message.toLowerCase() : '';
    const file = (e && e.filename) ? e.filename.toLowerCase() : '';
    if(msg.includes('api key not found') || file.includes('metrics.flutterwave.com') || file.includes('loader_v') || file.includes('initfingerprint') || msg.includes('fpjs')){
      console.warn('Suppressed known noise:', e.message || e.filename);
      e.preventDefault && e.preventDefault();
    }
  } catch(err){}
});

 const supportBtn = document.getElementById('floatingSupportBtn');
  if(supportBtn) {
    supportBtn.addEventListener('click', () => {
      window.location.href = 'mailto:stonecold.serac@gmail.com?subject=Support%20Request';
    });
  }

/* ------------------- Hamburger ---------------------*/
const hamburger = document.getElementById('hamburger');
const headerRight = document.querySelector('.header-right'); // not #headerRight

if (hamburger && headerRight) {
  hamburger.addEventListener('click', (e) => {
    e.stopPropagation();
    hamburger.classList.toggle('open');
    headerRight.classList.toggle('open');
  });

  // close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    if (
      headerRight.classList.contains('open') &&
      !headerRight.contains(e.target) &&
      !hamburger.contains(e.target)
    ) {
      headerRight.classList.remove('open');
      hamburger.classList.remove('open');
    }
  });
}

</script>

<script>
(function() {
  const applyHeroPeek = () => {
    const heroes = document.querySelectorAll('.hero');
    heroes.forEach(hero => {
      if (hero.querySelector('.hero-peek')) return;

      const peek = document.createElement('div');
      peek.className = 'hero-peek';

      // Determine hero brightness (basic)
      const bg = window.getComputedStyle(hero).backgroundColor;
      let darkHero = true;
      if (bg.startsWith('rgb')) {
        const rgb = bg.match(/\d+/g).map(Number);
        const brightness = (rgb[0]*299 + rgb[1]*587 + rgb[2]*114) / 1000;
        darkHero = brightness < 128; // simple threshold
      }

      peek.dataset.theme = darkHero ? 'dark' : 'light';
      hero.appendChild(peek);
    });
  };

  window.addEventListener('load', applyHeroPeek);
  window.addEventListener('resize', applyHeroPeek);
})();
</script>
  
</body>
</html>
