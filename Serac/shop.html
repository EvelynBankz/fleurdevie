<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sérac - Shop</title>

<!-- Fonts + Icons -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root{
  --bg-dark: #141517;
  --bg-mid: #2A2B30;
  --gold: #B66E41;
  --muted: #bdbdbd;
  --accent-strong: rgba(182,110,65,0.95);
  --radius: 12px;
  --transition: 0.25s cubic-bezier(.2,.9,.2,1);
}

/* RESET */
* { margin:0; padding:0; box-sizing:border-box; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
body { font-family:"Montserrat", sans-serif; background:var(--bg-dark); color:#e6e6e6; line-height:1.6; }
a { text-decoration:none; color:inherit; transition: color var(--transition); }

/* HEADER */
.site-header {
  background: transparent;
  transition: background 0.3s ease, border-bottom 0.3s ease;
  color:#f5f5f5;
  display:flex; justify-content:space-between; align-items:center;
  padding:16px 28px;
  position:fixed; top:0; left:0; right:0;
  z-index:1000;
  border-bottom:1px solid rgba(255,255,255,0.04);
}
.site-header.scrolled { background:var(--bg-dark); border-bottom:1px solid rgba(255,255,255,0.06); }

.header-left { display:flex; align-items:center; gap:14px; }
.brand-logo { height:56px; width:auto; object-fit:contain; filter: drop-shadow(0 4px 12px rgba(0,0,0,0.6)); }
.brand-title { font-family:"Playfair Display", serif; font-size:22px; font-weight:700; color:var(--gold); letter-spacing:0.6px; }

.header-right { display:flex; gap:22px; align-items:left; }
.header-right a { font-weight:500; color:var(--muted); padding:6px 8px; border-radius:8px; transition: all var(--transition); }
.header-right a:hover { color:#fff; transform:translateY(-2px); text-shadow: 0 4px 18px rgba(182,110,65,0.15); }

.cart-count { background:var(--gold); color:var(--bg-dark); font-size:12px; font-weight:700; border-radius:50%; padding:3px 7px; margin-left:6px; box-shadow:0 4px 10px rgba(182,110,65,0.12); }

/* Hamburger */
.hamburger { display:none; background:none; border:none; cursor:pointer; width:30px; height:24px; position:relative; }
.hamburger span { display:block; width:100%; height:3px; background:#B66E41; border-radius:2px; position:absolute; left:0; transition:0.3s; }
.hamburger span:nth-child(1){ top:0; }
.hamburger span:nth-child(2){ top:10px; }
.hamburger span:nth-child(3){ top:20px; }
.hamburger.open span:nth-child(1){ transform:rotate(45deg); top:10px; background:#B66E41; }
.hamburger.open span:nth-child(2){ opacity:0; }
.hamburger.open span:nth-child(3){ transform:rotate(-45deg); top:10px; background:#B66E41; }

/* HERO */
.hero { position: relative; height: 95vh; display: flex; justify-content: center; align-items: center; text-align: center; margin-top: 0px; overflow: hidden; padding-top:72px; }
.hero::after { content: ""; position: absolute; inset: 0; background: url("asset/bg25.jpg") center/cover no-repeat; transform: scale(1.06); z-index: -1; border-radius: 12px; box-shadow: inset 0 0 0 2000px rgba(20,21,23,0.55); }
.hero-text { position: relative; display: inline-block; margin-bottom:12px; }
.hero-text h1 { font-family:"Playfair Display", serif; font-size: clamp(36px,5vw,64px); margin-bottom:12px; color:#B66E41; }
.hero-text p { font-size: clamp(16px,2vw,22px); max-width:700px; color:#F5F5F3}


/* === UNDERLINE HOVER EFFECT (replicated from About page) === */
.header-right a {
  color: #F5F5F3;
  position: relative;
  padding: 6px 0;
  font-size: 1rem;
  font-weight: 500;
  transition: color 0.3s ease;
}

.header-right a::after {
  content: "";
  position: absolute;
  bottom: -4px;
  left: 0;
  width: 0;
  height: 2px;
  background: var(--gold);
  transition: width 0.3s ease;
}

.header-right a:hover {
  color: var(--gold);
}

.header-right a:hover::after {
  width: 100%;
}


  
/* SHOP CONTROLS */
.shop-controls { display:flex; justify-content:space-between; flex-wrap:wrap; margin-bottom:24px; gap:12px; align-items:center; }
.shop-controls input,
.shop-controls select {
  padding:10px 12px; border-radius:8px; border:1px solid rgba(255,255,255,0.04);
  font-size:14px; flex:1; max-width:320px; background:transparent; color:#e8e8e8; outline:none;
  box-shadow: inset 0 1px 0 rgba(255,255,255,0.01); transition: all var(--transition);
}
.shop-controls input:focus, .shop-controls select:focus {
  box-shadow:0 6px 28px rgba(182,110,65,0.06); transform:translateY(-2px); border-color: rgba(182,110,65,0.18);
}
.currency-filter-group { display:flex; gap:10px; align-items:center; flex:1; max-width:360px; }

/* SHOP GRID */
section.shop { padding:88px 20px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(0,0,0,0.03)); }
.container { max-width:1100px; margin:auto; }
h2 { text-align:center; font-size:24px; font-family:"Playfair Display", serif; margin-bottom:36px; color:#bfbfbf; letter-spacing:0.2px; }

.product-grid { display:grid; gap:22px; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); }
.product-card {
  background: var(--bg-mid); padding:16px; border-radius:var(--radius);
  box-shadow: 0 6px 24px rgba(2,2,2,0.6); display:flex; flex-direction:column;
  transition: transform var(--transition), box-shadow var(--transition); position:relative; overflow:hidden;
}
.product-card:hover { transform:translateY(-8px) scale(1.01); box-shadow:0 14px 60px rgba(11,12,13,0.72); }
.product-card img {
  width: 100%;
  height: 220px; /* Increased for better visibility */
  object-fit: contain;
  background: #fff;
  border-radius: 10px;
  display: block;
  margin: 0 auto 12px;
}
.product-card h3 { font-family:"Playfair Display", serif; font-size:1.05rem; margin-bottom:6px; color:#fff; }
.product-card .description { font-size:0.9rem; color:#bfbfbf; margin-bottom:10px; min-height:40px; }
.product-card .price { font-weight:700; margin-bottom:12px; color:var(--gold); font-size:1rem; }
.product-card button { background:var(--gold); color:var(--bg-dark); border:none; border-radius:8px; padding:10px; cursor:pointer; transition: all var(--transition); box-shadow:0 8px 24px rgba(182,110,65,0.12); font-weight:600; }
.product-card button:hover { transform:translateY(-3px); box-shadow:0 18px 50px rgba(182,110,65,0.16); }

.quantity-controls { display:flex; gap:10px; align-items:center; margin-bottom:8px; }
.quantity-controls .minus, .quantity-controls .plus { background:transparent; border:1px solid rgba(255,255,255,0.04); color:#e6e6e6; padding:8px 10px; border-radius:8px; cursor:pointer; transition: all var(--transition); }
.quantity-controls .minus:hover, .quantity-controls .plus:hover { background: rgba(182,110,65,0.06); transform:translateY(-2px); }
.quantity-badge { font-weight:700; color:#fff; min-width:28px; text-align:center; }

.customize-badge { position:absolute; top:12px; right:12px; background: #141517; color:var(--gold); font-size:12px; padding:6px 10px; border-radius:10px; font-weight:700; cursor:pointer; z-index:2; display:flex; align-items:center; gap:8px; border:1px solid rgba(182,110,65,0.18); backdrop-filter: blur(2px); transition: all var(--transition); box-shadow:0 6px 18px rgba(0,0,0,0.6); }
.customize-badge:hover { background: rgba(182,110,65,0.08); color:#fff; transform:translateY(-4px); }

footer { text-align:center; padding:22px; background:transparent; color:#bdbdbd; margin-top:60px; border-top:1px solid rgba(255,255,255,0.02); }

@media(max-width:900px){ .product-grid { grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); } }
@media(max-width:900px){
  .product-grid { grid-template-columns: repeat(2, 1fr); gap:12px; }
  .product-card img { height:140px; }
  .header-right { display:none; flex-direction:column; background:rgba(20,21,23,0.98); position:absolute; top:70px; right:0; width:220px; padding:18px; border-radius:8px; z-index:1100; }
  .header-right.open { display:flex; }
  .hamburger { display:block; }
  .mobile-cart { display:flex; align-items:center; margin-right:10px; }
  .mobile-cart a { color:var(--gold); font-size:20px; position:relative; }
  .mobile-cart .cart-count { position:absolute; top:-8px; right:-8px; }
  .hero-text h1 { font-size:32px; }
}
  
@media(max-width:600px){
  .hero { height:40vh; margin-top:0; padding-top:80px; }
  .hero-text h1 { font-size:clamp(24px,5vw,32px); line-height:1.2; margin:0; }
  .hero-text p { font-size:clamp(14px,2.5vw,18px); margin:0 auto; }
}

button:focus, a:focus, input:focus, select:focus { outline: 3px solid rgba(182,110,65,0.12); outline-offset:2px; }

 /* Chat-style floating support button */
    #floatingSupportBtn {
      position: fixed;
      bottom: 25px;
      right: 25px;
      width: 56px;
      height: 56px;
      background: #1a202b; /* Sérac primary color */
      color: #fff;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 20px rgba(182, 110, 65, 1);
      transition: all 0.3s ease;
      z-index: 9999;
    }

    #floatingSupportBtn:hover {
      background: #20232b;
      transform: translateY(-2px);
      box-shadow: 0 8px 24px rgba(75, 78, 84, 1.0);
    }

    /* Tooltip */
    .support-tooltip {
      position: absolute;
      bottom: 50px;      /* tooltip above button */
      left: 20%;
      transform: translateX(-50%);
      background: #1c1e22;
      color: #fff;
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 14px;
      white-space: nowrap;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease, transform 0.3s ease;
    }

    #floatingSupportBtn:hover .support-tooltip {
      opacity: 1;
      transform: translateX(-50%) translateY(-6px);
    }

</style>

<style>
@media(min-width: 200px) {
  .hero { position: relative; overflow: visible; }

  .hero-peek {
    position: absolute;
    bottom: -20px;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    height: 20px;
    border-radius: 10px / 50%;
    z-index: 2;
    box-shadow: 0 -6px 15px rgba(0,0,0,0.15);
    animation: peekFloat 2s ease-in-out infinite alternate;
  }

  .hero-peek[data-theme="dark"] {
    background: linear-gradient(to top, rgba(182,110,65,0.3), transparent);
  }

  .hero-peek[data-theme="light"] {
    background: linear-gradient(to top, rgba(255,235,200,0.35), transparent);
  }

  @keyframes peekFloat {
    0% { transform: translateX(-50%) translateY(0); opacity: 0.85; }
    100% { transform: translateX(-50%) translateY(-4px); opacity: 1; }
  }
}
</style>
  
</head>
<body>

<header class="site-header">
  <div class="header-left">
    <img src="asset/logo.png" alt="Sérac Logo" class="brand-logo">
    <div class="brand-title">Sérac</div>
  </div>

  <div class="mobile-cart" style="display:none;">
    <a href="cart.html"><i class="fa-solid fa-cart-shopping"></i><span class="cart-count" id="cartCountMobile">0</span></a>
  </div>

  
  <nav class="header-right" id="headerRight">
    <a href="index.html">Home</a>
    <a href="about.html">About</a>
    <a href="cart.html">Cart <span class="cart-count" id="cartCount">0</span></a>
    <a href="customization.html">Customize</a>
    <a href="contact.html">Contact</a>
    <a href="trackorder.html">Track</a>
  </nav>

   <button class="hamburger" id="hamburger" aria-label="Menu" aria-expanded="false">
      <span></span><span></span><span></span>
   </button>
  
</header>

<section class="hero">
  <div class="hero-text">
    <h1>Shop</h1>
    <p>Explore our collection of products</p>
  </div>
</section>

<section class="shop">
  <div class="container">
    <h2>Our Products</h2>
    <div class="shop-controls">
      <input type="text" id="searchInput" placeholder="Search products...">
      <div class="currency-filter-group">
        <select id="currencySelect">
          <option value="NGN">NGN</option>
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
          <option value="GBP">GBP</option>
        </select>
        <select id="sortSelect">
          <option value="">Filter / Sort</option>
          <option value="alphabet">Alphabet</option>
          <option value="price-asc">Price: Low → High</option>
          <option value="price-desc">Price: High → Low</option>
        </select>
      </div>
    </div>

    <div class="product-grid" id="productGrid"></div>
  </div>
</section>

<!-- Floating Chat-Style Support Button -->
  <button id="floatingSupportBtn" aria-label="Contact Support">
    <i class="fas fa-headset"></i>
    <span class="support-tooltip">Support</span>
  </button>


<footer>
  <p>© 2025 Sérac</p>
</footer>

<script type="module">
/* ---------- Firebase ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, collection, getDocs, query, where } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCuiZXHFYl1fVKnGwojavRvbekSBpkipJg",
  authDomain: "brandisby.firebaseapp.com",
  projectId: "brandisby",
  storageBucket: "brandisby.firebasestorage.app",
  messagingSenderId: "87213267039",
  appId: "1:87213267039:web:339e9fd49e3ad31f7423ea"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------- DOM refs ---------- */
const productGrid = document.getElementById('productGrid');
const cartCountElem = document.getElementById('cartCount');
const cartCountMobileElem = document.getElementById('cartCountMobile');
const searchInput = document.getElementById('searchInput');
const sortSelect = document.getElementById('sortSelect');
const currencySelect = document.getElementById('currencySelect');
const hamburger = document.getElementById('hamburger');
const headerRight = document.querySelector('.header-right');

/* ---------- Namespaced localStorage keys for Serac ---------- */
const CART_KEY = 'seracCart';
const CURRENCY_KEY = 'seracCurrency';

/* ---------- State ---------- */
let cart = JSON.parse(localStorage.getItem(CART_KEY)) || [];
cart = mergeCartItems(cart);
let productsData = {}; // map id -> product data

/* ---------- Init: restore currency preference ---------- */
try { if (localStorage.getItem(CURRENCY_KEY) && currencySelect) currencySelect.value = localStorage.getItem(CURRENCY_KEY); } catch(e){}

/* ---------- Utility: localStorage cart helpers ---------- */
function getCart() { return JSON.parse(localStorage.getItem(CART_KEY)) || []; }
function setCart(cartArray) {
  cart = mergeCartItems(cartArray);
  try { localStorage.setItem(CART_KEY, JSON.stringify(cart)); }
  catch(e) { console.warn("Could not set localStorage", e); }
  updateCartCount();
}
function mergeCartItems(cartArray) {
  const merged = [];
  (cartArray || []).forEach(item => {
    const idx = merged.findIndex(i => i.id === item.id && (i.color || '') === (item.color || '') && (i.size || '') === (item.size || ''));
    if (idx === -1) merged.push({ ...item });
    else merged[idx].quantity = (merged[idx].quantity || 0) + (item.quantity || 0);
  });
  return merged;
}
function updateCartCount() {
  const total = (getCart() || []).reduce((sum, i) => sum + (i.quantity || 0), 0);
  if (cartCountElem) cartCountElem.textContent = total;
  if (cartCountMobileElem) cartCountMobileElem.textContent = total;
}

/* ---------- Cart operations ---------- */
/* Robust getTotalQuantity to count variants stored in multiple shapes */
function getTotalQuantity(productId) {
  const c = getCart();
  let total = 0;
  c.forEach(i => {
    if (String(i.id) === String(productId)) { total += (i.quantity || 0); return; }
    if (i.parentId && String(i.parentId) === String(productId)) { total += (i.quantity || 0); return; }
    if (i.productId && String(i.productId) === String(productId)) { total += (i.quantity || 0); return; }
    if (typeof i.id === 'string' && String(i.id).startsWith(String(productId) + '-')) { total += (i.quantity || 0); return; }
  });
  return total;
}

function addToCart(product) {
  let currentCart = getCart();
  const idx = currentCart.findIndex(i => i.id === product.id && (i.color || '') === (product.color || '') && (i.size || '') === (product.size || ''));
  if (idx > -1) currentCart[idx].quantity += 1;
  else currentCart.push({ ...product, quantity: 1 });
  setCart(currentCart);
  updateProductUI(product.id);
}

function removeFromCart(productId) {
  let currentCart = getCart();
  const idx = currentCart.findIndex(i => i.id === productId);
  if (idx > -1) {
    currentCart[idx].quantity -= 1;
    if (currentCart[idx].quantity <= 0) currentCart.splice(idx, 1);
  }
  setCart(currentCart);
  updateProductUI(productId);
}

/* Update a product card UI (badge and Add button visibility) */
function updateProductUI(productId) {
  const card = document.getElementById(`product-${productId}`);
  if (!card) return;
  const addBtn = card.querySelector('.add-cart, .select-variant');
  const badge = card.querySelector('.quantity-badge');
  const totalQty = getTotalQuantity(productId);

  // Determine if product is variant-type (data attribute set at render)
  const isVariant = card.dataset.hasVariants === 'true';

  if (isVariant) {
    if (badge) badge.textContent = totalQty > 0 ? totalQty : '';
    if (addBtn) {
      addBtn.style.display = 'block';
      addBtn.textContent = totalQty > 0 ? 'View selection' : 'Select your choice';
      addBtn.classList.add('gold-hover');
    }
    const plus = card.querySelector('.plus');
    const minus = card.querySelector('.minus');
    if (plus) plus.style.display = 'none';
    if (minus) minus.style.display = 'none';
  } else {
    if (totalQty > 0) {
      if (addBtn && addBtn.classList.contains('add-cart')) addBtn.style.display = 'none';
      if (badge) badge.textContent = totalQty;
    } else {
      if (addBtn && addBtn.classList.contains('add-cart')) addBtn.style.display = 'block';
      if (badge) badge.textContent = '';
    }
  }
}

/* Price formatting */
function formatPrice(product, currency) {
  if (!product) return '';
  const price = currency === 'NGN' ? product.priceNGN : currency === 'USD' ? product.priceUSD : currency === 'EUR' ? product.priceEUR : currency === 'GBP' ? product.priceGBP : product.priceNGN;
  const localeMap = { NGN: 'en-NG', USD: 'en-US', EUR: 'de-DE', GBP: 'en-GB' };
  try {
    return new Intl.NumberFormat(localeMap[currency] || 'en-US', { style: 'currency', currency, minimumFractionDigits: currency === 'NGN' ? 0 : 2 }).format(price);
  } catch (e) {
    return `${currency} ${Number(price||0).toFixed(currency==='NGN'?0:2)}`;
  }
}

/* ---------- --- MODAL: dynamic dropdown injection & helper --- ---------- */
function injectModalStyles() {
  if (document.getElementById('serac-variant-modal-styles')) return;
  const css = `
  .serac-modal-backdrop {
    position: fixed;
    inset: 0;
    background: transparent;
    z-index: 9999;
  }
  .serac-modal {
    position: absolute;
    width: 320px;
    background: #1a1a1a;
    border: 1px solid rgba(255,255,255,0.08);
    border-radius: 10px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.4);
    color: #eaeaea;
    font-family: "Montserrat", sans-serif;
    overflow: hidden;
    animation: fadeIn 0.15s ease-out;
  }
  @keyframes fadeIn {
    from {opacity: 0; transform: translateY(-10px);}
    to {opacity: 1; transform: translateY(0);}
  }
  .serac-modal-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 10px 14px; border-bottom: 1px solid rgba(255,255,255,0.05);
  }
  .serac-modal-title { font-size: 15px; color: var(--gold); font-family: "Playfair Display", serif; }
  .serac-modal-close { background: none; border: 0; color: #bbb; font-size: 14px; cursor: pointer; }
  .serac-modal-body { padding: 10px 14px; max-height: 250px; overflow-y: auto; }
  .serac-variant-row { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; }
  .serac-variant-img { width: 48px; height: 48px; border-radius: 6px; object-fit: cover; background: #111; }
  .serac-variant-meta h4 { margin: 0; font-size: 13px; color: #fff; }
  .serac-variant-meta p { margin: 0; font-size: 12px; color: #bbb; }
  .serac-btn {
    border: 1px solid var(--gold);
    background: transparent;
    color: var(--gold);
    padding: 4px 8px;
    border-radius: 6px;
    font-size: 12px;
    cursor: pointer;
  }
  .serac-btn:hover { background: var(--gold); color: #000; }
  .serac-modal-footer {
    display: flex;
    justify-content: flex-end;
    gap: 8px;
    padding: 10px 14px;
    border-top: 1px solid rgba(255,255,255,0.05);
  }
  `;
  const s = document.createElement("style");
  s.id = "serac-variant-modal-styles";
  s.textContent = css;
  document.head.appendChild(s);
}

function buildVariantRowsForProduct(productId) {
  const c = getCart();
  const rows = [];
  c.forEach(item => {
    const matches =
      String(item.id) === String(productId) ||
      (item.parentId && String(item.parentId) === String(productId)) ||
      (item.productId && String(item.productId) === String(productId)) ||
      (typeof item.id === 'string' && String(item.id).startsWith(String(productId) + '-'));
    if (matches) {
      const master = productsData[String(productId)] || {};
      const name = item.name || master.name || `Product ${productId}`;
      const imageUrl = item.image || master.imageUrl || (master.images && master.images[0]) || '';
      rows.push({
        id: item.id,
        name,
        imageUrl,
        color: item.color || item.selectedColor || null,
        size: item.size || item.selectedSize || null,
        quantity: item.quantity || 0
      });
    }
  });
  return rows;
}

/* ---------- SHOW VARIANT MODAL ---------- */
function showVariantModal(productId, triggerElem = null) {
  injectModalStyles();
  document.querySelectorAll('.serac-modal-backdrop').forEach(e => e.remove());

  const rows = buildVariantRowsForProduct(productId);
  if (!rows || rows.length === 0) {
    window.location.href = `product.html?productId=${encodeURIComponent(productId)}`;
    return;
  }

  const backdrop = document.createElement("div");
  backdrop.className = "serac-modal-backdrop";

  const modal = document.createElement("div");
  modal.className = "serac-modal";
  modal.setAttribute('role', 'dialog');
  modal.setAttribute('aria-modal', 'true');

  /* ---------- Header ---------- */
  const header = document.createElement("div");
  header.className = "serac-modal-header";
  const title = document.createElement("div");
  title.className = "serac-modal-title";
  title.textContent = "Your selection";
  const closeBtn = document.createElement("button");
  closeBtn.className = "serac-modal-close";
  closeBtn.textContent = "Clear all";
  header.appendChild(title);
  header.appendChild(closeBtn);

  /* ---------- Body ---------- */
  const body = document.createElement("div");
  body.className = "serac-modal-body";

  rows.forEach(item => {
    const row = document.createElement("div");
    row.className = "serac-variant-row";

    const img = document.createElement("img");
    img.className = "serac-variant-img";
    img.src = item.imageUrl || '';
    img.alt = item.name || "Product";

    const meta = document.createElement("div");
    meta.className = "serac-variant-meta";

    const h = document.createElement("h4");
    h.textContent = item.name || "Product";

    const p = document.createElement("p");
    const parts = [];
    if (item.color) parts.push(`Color: ${item.color}`);
    if (item.size) parts.push(`Size: ${item.size}`);
    parts.push(`Qty: ${item.quantity || 0}`);
    p.textContent = parts.join(" • ");

    meta.appendChild(h);
    meta.appendChild(p);
    row.appendChild(img);
    row.appendChild(meta);
    body.appendChild(row);
  });

  /* ---------- Footer ---------- */
  const footer = document.createElement("div");
  footer.className = "serac-modal-footer";

  const editAllBtn = document.createElement("button");
  editAllBtn.className = "serac-btn";
  editAllBtn.textContent = "Edit Selections";
  editAllBtn.addEventListener("click", (ev) => {
    ev.stopPropagation();
    backdrop.remove();
    window.location.href = `product.html?productId=${encodeURIComponent(productId)}`;
  });

  const closeFooterBtn = document.createElement("button");
  closeFooterBtn.className = "serac-btn";
  closeFooterBtn.textContent = "Close";
  closeFooterBtn.addEventListener("click", () => backdrop.remove());

  footer.appendChild(editAllBtn);
  footer.appendChild(closeFooterBtn);

  modal.appendChild(header);
  modal.appendChild(body);
  modal.appendChild(footer);
  backdrop.appendChild(modal);
  document.body.appendChild(backdrop);

  // 🔹 Dynamic positioning near clicked element
  if (triggerElem) {
    const rect = triggerElem.getBoundingClientRect();
    const modalRect = modal.getBoundingClientRect();
    const spaceRight = window.innerWidth - rect.right;
    const spaceLeft = rect.left;
    const spaceBottom = window.innerHeight - rect.bottom;
    const spaceTop = rect.top;

    let top = rect.bottom + 8;
    let left = rect.left;

    if (spaceRight < modalRect.width && spaceLeft > modalRect.width)
      left = rect.right - modalRect.width;
    if (spaceBottom < modalRect.height && spaceTop > modalRect.height)
      top = rect.top - modalRect.height - 8;

    modal.style.position = 'fixed';
    modal.style.top = `${Math.max(10, top)}px`;
    modal.style.left = `${Math.max(10, left)}px`;
    modal.style.zIndex = '10000';
  }

  // 🔹 Close logic
  closeBtn.addEventListener("click", () => {
    localStorage.removeItem('cart'); // clears all selections
    backdrop.remove();
  });
  backdrop.addEventListener("click", e => {
    if (e.target === backdrop) backdrop.remove();
  });
}

/* ---------- EVENT: View Selection / Select Your Choice ---------- */
// This ensures the modal opens correctly when any "Select your choice" or "View selection" button is clicked.
document.addEventListener('click', (e) => {
  const btn = e.target.closest('.select-variant');
  if (!btn) return;
  const productId = btn.dataset.id || btn.getAttribute('data-id');
  if (!productId) return;
  showVariantModal(productId, btn);
});


/* ---------- Load & render products (Serac collection) ---------- */
async function loadProducts() {
  try {
    if (productGrid) productGrid.innerHTML = '<p style="text-align:center; color:var(--muted);">Loading products…</p>';
    const q = query(collection(db, "brands", "serac", "products"), where("published", "==", true));
    const snapshot = await getDocs(q);
    const products = [];
    productsData = {};
    snapshot.forEach(docSnap => {
      const data = docSnap.data();
      if (!data.name) return;
      const p = { id: docSnap.id, ...data };
      products.push(p);
      productsData[docSnap.id] = p;
    });
    displayProducts(products);
  } catch (e) {
    console.error(e);
    if (productGrid) productGrid.innerHTML = '<p style="text-align:center;color:tomato;">Failed to load products.</p>';
  }
}

/* ---------- Display with pagination ---------- */
function displayProducts(products) {
  const term = (searchInput?.value || '').toLowerCase();
  let filtered = (products || []).filter(p => (p.name || '').toLowerCase().includes(term));

  const sortVal = sortSelect?.value;
  const currency = currencySelect?.value || (localStorage.getItem(CURRENCY_KEY) || 'NGN');

  function getPriceForCurrency(product) {
    return currency === 'NGN' ? product.priceNGN : currency === 'USD' ? product.priceUSD : currency === 'EUR' ? product.priceEUR : currency === 'GBP' ? product.priceGBP : product.priceNGN;
  }

  if (sortVal === 'alphabet') filtered.sort((a, b) => (a.name || '').localeCompare(b.name || ''));
  if (sortVal === 'price-asc') filtered.sort((a, b) => (getPriceForCurrency(a) || 0) - (getPriceForCurrency(b) || 0));
  if (sortVal === 'price-desc') filtered.sort((a, b) => (getPriceForCurrency(b) || 0) - (getPriceForCurrency(a) || 0));

  /* ---------- Pagination logic ---------- */
  const productsPerPage = 24; 
  let currentPage = window.currentPage || 1;
  const totalPages = Math.ceil(filtered.length / productsPerPage);

  if (currentPage > totalPages) currentPage = totalPages || 1;

  const start = (currentPage - 1) * productsPerPage;
  const end = start + productsPerPage;
  const paginated = filtered.slice(start, end);

  if (productGrid) productGrid.innerHTML = '';
  for (const p of paginated) {
    const quantity = getTotalQuantity(p.id);
    const priceForCurrency = getPriceForCurrency(p);

    // determine if this product has variants
    const hasVariants = Boolean(
      (p.variants && Array.isArray(p.variants) && p.variants.length > 0) ||
      (p.options && Array.isArray(p.options) && p.options.length > 0) ||
      (p.variantOptions && Array.isArray(p.variantOptions) && p.variantOptions.length > 0) ||
      p.variantsAvailable === true ||
      p.hasVariants === true ||
      p.isVariant === true ||
      (Array.isArray(p.colors) && p.colors.length > 0) ||
      (Array.isArray(p.sizes) && p.sizes.length > 0)
    );

    const div = document.createElement('div');
    div.className = 'product-card';
    div.id = `product-${p.id}`;
    // expose variant flag for updateProductUI
    div.dataset.hasVariants = hasVariants ? 'true' : 'false';

    // For variant products: show quantity badge but NO +/- controls, and show "Select your choice" button that navigates to product page.
    // For non-variant products: show +/- controls and Add to Cart.
    let quantityControlsHtml = '';
    if (hasVariants) {
      quantityControlsHtml = `
        <div class="quantity-controls" aria-hidden="true">
          <span class="quantity-badge">${quantity > 0 ? quantity : ''}</span>
        </div>
      `;
    } else {
      quantityControlsHtml = `
        <div class="quantity-controls">
          <button class="minus" aria-label="Decrease">-</button>
          <span class="quantity-badge">${quantity > 0 ? quantity : ''}</span>
          <button class="plus" aria-label="Increase">+</button>
        </div>
      `;
    }

    // Button: for variants use .select-variant, for non-variants use .add-cart
    const actionButtonHtml = hasVariants
      ? `<button class="select-variant gold-hover">${quantity > 0 ? 'View selection' : 'Select your choice'}</button>`
      : `<button class="add-cart" style="display:${quantity > 0 ? 'none' : 'block'};">Add to Cart</button>`;

    div.innerHTML = `
      ${p.customizationAvailable ? `<a href="customization.html?productId=${p.id}" class="customize-badge" onclick="event.stopPropagation()"><i class="fa-solid fa-wand-magic-sparkles"></i> Customize</a>` : ''}
      <a href="product.html?productId=${p.id}&price=${priceForCurrency}&currency=${currency}">
        <img src="${escapeHtml(p.imageUrl || '')}" alt="${escapeHtml(p.name || '')}">
      </a>
      <h3>${escapeHtml(p.name || '')}</h3>
      <div class="description">${escapeHtml(truncateText(p.description || '', 15))}</div>
      <div class="price">${formatPrice(p, currency)}</div>
      ${quantityControlsHtml}
      ${actionButtonHtml}
    `;

    // Event wiring depending on variant vs non-variant
    if (!hasVariants) {
      div.querySelector('.plus')?.addEventListener('click', e => { e.stopPropagation(); addToCart(p); });
      div.querySelector('.minus')?.addEventListener('click', e => { e.stopPropagation(); removeFromCart(p.id); });
      div.querySelector('.add-cart')?.addEventListener('click', e => { e.stopPropagation(); addToCart(p); });
    } else {
      // variant product: show modal if there are selected variants, otherwise go to product page
      const selectBtn = div.querySelector('.select-variant');
      if (selectBtn) {
        selectBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          // pass the clicked element to the modal so it can be positioned relative to the button
          const totalSelected = getTotalQuantity(p.id);
          if (totalSelected > 0) {
            // show modal with items for this product, positioned near the button
            showVariantModal(p.id, selectBtn);
          } else {
            // no variant selected yet -> navigate to product page to pick
            const url = `product.html?productId=${encodeURIComponent(p.id)}&price=${encodeURIComponent(priceForCurrency)}&currency=${encodeURIComponent(currency)}`;
            window.location.href = url;
          }
        });
      }
    }

    productGrid?.appendChild(div);
  }

  // ---------- Pagination controls with Previous/Next ----------
  const existingPagination = document.querySelector('.pagination');
  if (existingPagination) existingPagination.remove();

  const paginationContainer = document.createElement('div');
  paginationContainer.className = 'pagination';

  // Previous button
  const prevBtn = document.createElement('button');
  prevBtn.textContent = 'Previous';
  prevBtn.disabled = currentPage === 1 || totalPages <= 1;
  prevBtn.addEventListener('click', () => {
    if (currentPage > 1) {
      window.currentPage = currentPage - 1;
      displayProducts(products);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  });
  paginationContainer.appendChild(prevBtn);

  // Number buttons
  for (let i = 1; i <= Math.max(totalPages, 1); i++) {
    const btn = document.createElement('button');
    btn.textContent = i;
    btn.className = (i === currentPage) ? 'active' : '';
    btn.addEventListener('click', () => {
      window.currentPage = i;
      displayProducts(products);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });
    paginationContainer.appendChild(btn);
  }

  // Next button
  const nextBtn = document.createElement('button');
  nextBtn.textContent = 'Next';
  nextBtn.disabled = currentPage === totalPages || totalPages <= 1;
  nextBtn.addEventListener('click', () => {
    if (currentPage < totalPages) {
      window.currentPage = currentPage + 1;
      displayProducts(products);
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
  });
  paginationContainer.appendChild(nextBtn);

  if (productGrid && productGrid.parentElement) {
    productGrid.insertAdjacentElement('afterend', paginationContainer);
  } else {
    document.body.appendChild(paginationContainer);
  }

  // After rendering, ensure UI reflects cart totals
  updateCartCount();
  (paginated || []).forEach(p => updateProductUI(p.id));
}

/* ---------- Helpers ---------- */
function truncateText(text, wordLimit) { return text.split(' ').slice(0,wordLimit).join(' '); }
function escapeHtml(str) { if (!str && str !== 0) return ""; return String(str).replace(/[&<>"']/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": "&#39;" }[s])); }

/* ---------- Event wiring ---------- */
searchInput?.addEventListener('input', () => { window.currentPage = 1; loadProducts(); });
sortSelect?.addEventListener('change', () => { window.currentPage = 1; loadProducts(); });
// currencySelect?.addEventListener('change', () => {
//   try { localStorage.setItem(CURRENCY_KEY, currencySelect.value); } catch(e){}
//   window.currentPage = 1;
//   loadProducts();
// });
currencySelect?.addEventListener('change', () => {
  const newCurrency = currencySelect.value;
  try { localStorage.setItem(CURRENCY_KEY, newCurrency); } catch(e){}

  // 🔹 Update prices only
  Object.values(productsData).forEach(product => {
    const card = document.getElementById(`product-${product.id}`);
    if (!card) return;
    const priceElem = card.querySelector('.price');
    if (!priceElem) return;
    priceElem.textContent = formatPrice(product, newCurrency);
  });
});

  
// ✅ Fix: Hamburger toggle logic
if (hamburger && headerRight) {
  hamburger.addEventListener('click', () => {
    hamburger.classList.toggle('open');
    headerRight.classList.toggle('open');
    const expanded = hamburger.classList.contains('open');
    hamburger.setAttribute('aria-expanded', expanded);
  });
}


/* -------------------- HEADER/HERO BEHAVIOR (safe version – works with existing hamburger) -------------------- */
(function headerHeroBehavior(){
  const headerEl = document.querySelector('.site-header');
  const heroEl =
    document.querySelector('.hero') ||
    document.getElementById('heroSection') ||
    document.querySelector('.hero-about');
  const hamburger = document.getElementById('hamburger');
  if(!headerEl || !heroEl) return;

  let lastY = window.scrollY || 0;
  let hidden = false;
  let heroHeight = Math.round(heroEl.getBoundingClientRect().height);
  let hoverShown = false;

  function isMenuOpen(){
    return hamburger && hamburger.classList.contains('open');
  }

  function handleScroll(){
    const y = window.scrollY || 0;
    const menuOpen = isMenuOpen();

    // turn header dark after hero
    if(y > Math.max(50, heroHeight - 80))
      headerEl.classList.add('scrolled');
    else
      headerEl.classList.remove('scrolled');

    // if hamburger menu open, force header visible
    if(menuOpen){
      headerEl.style.top = '0';
      headerEl.style.opacity = '1';
      headerEl.style.pointerEvents = 'auto';
      return;
    }

    if(y > heroHeight - 80){
      if(y > lastY && !hidden){
        headerEl.style.top = '-90px';
        headerEl.style.opacity = '0';
        headerEl.style.pointerEvents = 'none';
        hidden = true;
      } else if(y < lastY && hidden){
        headerEl.style.top = '0';
        headerEl.style.opacity = '1';
        headerEl.style.pointerEvents = 'auto';
        headerEl.classList.add('scrolled');
        hidden = false;
      }
    } else {
      headerEl.style.top = '0';
      headerEl.style.opacity = '1';
      headerEl.style.pointerEvents = 'auto';
      headerEl.classList.remove('scrolled');
      hidden = false;
    }

    lastY = y;
  }

  // hover reveal (disabled when menu open)
  document.addEventListener('mousemove', (e) => {
    if(isMenuOpen()) return;

    if(e.clientY < 100){
      if(hidden){
        headerEl.style.top = '0';
        headerEl.style.opacity = '1';
        headerEl.style.pointerEvents = 'auto';
        headerEl.classList.add('scrolled');
        hidden = false;
        hoverShown = true;
      }
    } else if(hoverShown){
      setTimeout(()=>{
        if(window.scrollY > heroHeight - 80 && !isMenuOpen()){
          headerEl.style.top = '-90px';
          headerEl.style.opacity = '0';
          headerEl.style.pointerEvents = 'none';
          hidden = true;
        }
        hoverShown = false;
      }, 220);
    }
  });

  // when hamburger opens/closes, re-evaluate visibility
  if(hamburger){
    hamburger.addEventListener('click', () => {
      setTimeout(handleScroll, 200); // slight delay ensures proper detection
    });
  }

  window.addEventListener('resize', () => {
    heroHeight = Math.round(heroEl.getBoundingClientRect().height);
    handleScroll();
  }, { passive: true });

  window.addEventListener('scroll', handleScroll, { passive: true });
  window.addEventListener('load', () => {
    heroHeight = Math.round(heroEl.getBoundingClientRect().height);
    handleScroll();
  });
})();

/* ---------- SMOOTH SCROLL (closes mobile menu on click) ---------- */
document.querySelectorAll('.header-right a').forEach(link => {
  link.addEventListener('click', e => {
    const href = link.getAttribute('href');
    if (href && href.startsWith('#')) {
      e.preventDefault();
      const target = document.getElementById(href.slice(1));
      if (target) {
        window.scrollTo({ top: target.offsetTop - 80, behavior: 'smooth' });
      }
    }
    // close mobile menu if open
    if (headerRight && hamburger) {
      headerRight.classList.remove('open');
      hamburger.classList.remove('open');
      hamburger.setAttribute('aria-expanded', 'false');
    }
  });
});


/* -------------------- MOBILE CART ICON (show on small screens) -------------------- */
/* mobile cart visibility */
function handleMobileCart(){ 
  const el = document.querySelector('.mobile-cart');
  if(!el) return;
  el.style.display = window.innerWidth <= 900 ? 'flex' : 'none';
}
window.addEventListener('resize', handleMobileCart);
handleMobileCart();

/* header scrolled background (simple fallback) */
window.addEventListener('scroll', ()=>{
  const header = document.querySelector('.site-header');
  if(!header) return;
  if(window.scrollY > 50) header.classList.add('scrolled'); else header.classList.remove('scrolled');
});

/* storage sync (other tabs) */
function loadCartFromStorage() {
  try {
    return JSON.parse(localStorage.getItem(CART_KEY)) || [];
  } catch (e) {
    return [];
  }
}
function renderCart() {
  // Minimal render stub - update any cart UI you have on page.
  // If you have a full cart sidebar, plug in its rendering logic here.
  updateCartCount();
}
window.addEventListener('storage', ()=>{
  cart = loadCartFromStorage();
  cart = mergeCartItems(cart);
  updateCartCount();
  renderCart();
});

/* ---------- Sync UI when returning to page (ensures product page variant adds are reflected) ---------- */
window.addEventListener('pageshow', () => {
  cart = mergeCartItems(getCart());
  updateCartCount();
  Object.keys(productsData || {}).forEach(pid => updateProductUI(pid));
});

/* ---------- Initial load ---------- */
updateCartCount();
loadProducts();

/* ---------- Pagination styles + GOLD HOVER ---------- */
const style = document.createElement('style');
style.textContent = `
.pagination { display:flex; justify-content:center; align-items:center; gap:0.6rem; margin-top:2rem; padding:1rem 0.5rem; width:100%; flex-wrap:wrap; }
.pagination button { background: transparent !important; color: var(--gold); border: 1px solid var(--gold); padding:0.5rem 1rem; cursor:pointer; border-radius:6px; font-weight:500; transition:all 0.3s ease; }
.pagination button:hover { background: var(--gold); color:#fff; }
.pagination button.active { background: var(--gold); color:#fff; border-color: var(--gold); }
.pagination button:disabled { opacity:0.4; cursor:not-allowed; }

/* GOLD HOVER for select/view buttons */
.gold-hover { position:relative; background:transparent; color:var(--gold); border:1px solid var(--gold); padding:8px 12px; border-radius:8px; font-weight:600; overflow:hidden; transition: color 0.25s ease; }
.gold-hover::after { content:''; position:absolute; left:0; top:0; width:0; height:100%; background:var(--gold); z-index:-1; transition: width 0.25s ease; }
.gold-hover:hover { color:#000; }
.gold-hover:hover::after { width:100%; }
`;
document.head.appendChild(style);


</script>

</body>
</html>
