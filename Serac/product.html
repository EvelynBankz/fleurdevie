<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Sérac - Product</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root{
      --bg-dark:#141517;
      --bg-mid:#2A2B30;
      --gold:#B66E41;
      --muted:#bdbdbd;
      --accent-strong:rgba(182,110,65,0.95);
      --radius:12px;
      --transition:0.25s cubic-bezier(.2,.9,.2,1);
    }

    /* RESET */
    *{ box-sizing:border-box; margin:0; padding:0; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
    body{ font-family:"Montserrat",sans-serif; background:var(--bg-dark); color:#e6e6e6; line-height:1.6; }
    a { text-decoration:none; color:inherit; transition:color var(--transition); }

    /* HEADER */
    .site-header{ background:transparent; transition: background 0.3s, border-bottom 0.3s, top 0.3s; display:flex; justify-content:space-between; align-items:center; padding:16px 28px; position:fixed; top:0; left:0; right:0; z-index:1000; border-bottom:1px solid rgba(255,255,255,0.04); color:#f5f5f5; }
    .site-header.scrolled{ background:var(--bg-dark); border-bottom:1px solid rgba(255,255,255,0.06); }
    .header-left{ display:flex; align-items:center; gap:14px; }
    .brand-logo{ height:56px; width:auto; object-fit:contain; filter:drop-shadow(0 4px 12px rgba(0,0,0,0.6)); }
    .brand-title{ font-family:"Playfair Display",serif; font-size:22px; font-weight:700; color:var(--gold); }

    .header-right{ display:flex; gap:22px; align-items:left; }
    .header-right a{ color:#f5f5f3; position:relative; padding:6px 0; font-size:1rem; font-weight:500; }
    .header-right a::after{ content:""; position:absolute; bottom:-4px; left:0; width:0; height:2px; background:var(--gold); transition:width 0.3s; }
    .header-right a:hover{ color:var(--gold); }
    .header-right a:hover::after{ width:100%; }
    .cart-count{ background:var(--gold); color:var(--bg-dark); font-size:12px; font-weight:700; border-radius:50%; padding:3px 7px; margin-left:6px; box-shadow:0 4px 10px rgba(182,110,65,0.12); }

    /* HAMBURGER */
    .hamburger{ display:none; background:none; border:none; cursor:pointer; width:22px; height:16px; position:relative; }
    .hamburger span{ display:block; width:100%; height:2px; background:#b66e41; border-radius:2px; position:absolute; left:0; transition:0.3s; }
    .hamburger span:nth-child(1){ top:0; } .hamburger span:nth-child(2){ top:7px; } .hamburger span:nth-child(3){ top:14px; }
    .hamburger.open span:nth-child(1){ transform:rotate(45deg); top:7px; } .hamburger.open span:nth-child(2){ opacity:0; } .hamburger.open span:nth-child(3){ transform:rotate(-45deg); top:7px; }

    /* MAIN */
    main{ padding:24px; max-width:1100px; margin:140px auto 60px; display:flex; gap:40px; justify-content:center; align-items:flex-start; flex-wrap:wrap; }

    /* IMAGE */
    .product-image{ flex:1 1 400px; max-width:480px; display:flex; flex-direction:column; gap:14px; }
    .product-image img{ width:100%; border-radius:var(--radius); object-fit:cover; background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); box-shadow:0 10px 30px rgba(2,2,2,0.7), inset 0 -2px 6px rgba(0,0,0,0.4); transition:transform var(--transition), box-shadow var(--transition); cursor:pointer; }
    .product-image img:hover{ transform:translateY(-6px) scale(1.01); box-shadow:0 18px 42px rgba(0,0,0,0.7); }
    .thumbnail-container{ display:flex; gap:10px; overflow-x:auto; scroll-behavior:smooth; padding-bottom:6px; }
    .thumbnail-container img{ width:70px; height:70px; border-radius:8px; object-fit:cover; border:2px solid transparent; cursor:pointer; transition:transform 0.3s, border-color 0.3s; }
    .thumbnail-container img.selected{ border-color:var(--accent-strong); box-shadow:0 6px 18px rgba(182,110,65,0.12); }

    /* DETAILS */
    .product-details{ flex:1 1 400px; max-width:520px; display:flex; flex-direction:column; gap:12px; }
    .product-details h1{ font-family:"Playfair Display",serif; font-size:28px; color:#fff; }
    .product-details .description{ font-size:15px; color:var(--muted); }
    .product-details .price{ font-weight:700; font-size:20px; color:#fff; margin-bottom:6px; }

    /* OPTIONS */
    .option-group{ margin-top:10px; }
    .option-group h4{ font-size:14px; color:var(--gold); margin-bottom:6px; font-weight:600; letter-spacing:0.3px; }
    .options-container{ display:flex; gap:8px; flex-wrap:wrap; }
    .options-container button{ padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:var(--muted); cursor:pointer; font-weight:500; transition:all var(--transition); text-align:center; position:relative; }
    .options-container button:hover{ color:#fff; border-color:var(--gold); }
    /* replaced glow selection with a clear double-border selection style */
    .options-container button.selected{ box-shadow:none; border:2px double var(--gold); color:var(--gold); font-weight:700; background:transparent; }

    /* QUANTITY */
    .quantity-controls{ display:flex; align-items:center; gap:10px; }
    .quantity-controls button{ background:transparent; color:#fff; border:1px solid rgba(255,255,255,0.06); border-radius:10px; padding:10px 14px; cursor:pointer; font-weight:700; transition:background var(--transition), transform var(--transition); text-align:center; }
    .quantity-controls button:hover{ background:rgba(255,255,255,0.05); transform:translateY(-2px); }
    .quantity-badge{ font-weight:700; min-width:36px; text-align:center; color:var(--muted); }

  

/* --- UNIFIED BUTTON STYLE (matches Clear Selections, single dashed border) --- */
/* --- UNIFIED BUTTON STYLE (matches Clear Selections, single dashed border) --- */
.add-cart,
.customize-btn,
.back-btn {
  background: transparent !important;
  color: var(--accent-strong) !important;
  border: 2px dashed rgba(182,110,65,0.5) !important;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 700;
  font-size: 15px;
  padding: 6px 14px;
  transition: background var(--transition), color var(--transition), border var(--transition);
}

.add-cart:hover,
.customize-btn:hover,
.back-btn:hover {
  background: rgba(182,110,65,0.08);
  color: var(--accent-strong);
  border-color: rgba(182,110,65,0.8);
}

/* --- BUTTON ROW --- */
.buttons-row {
  display: flex;
  gap: 12px;
  margin-top: 10px;
  justify-content: center;
  align-items: center;
  flex-wrap: wrap;
}

.action-btn {
  min-width: 132px;
  text-align: center;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  border-radius: 8px;
  font-weight: 700;
  cursor: pointer;
  transition: transform var(--transition), opacity var(--transition);
}

.action-btn:hover {
  transform: translateY(-2px);
  opacity: 0.95;
}




    
    /* DETAILS (from Firestore) */
    .product-extra-details{ margin-top:18px; color:var(--muted); font-size:15px; line-height:1.7; white-space:pre-line; }
    .product-extra-details ul{ margin-left:20px; list-style:disc; }
    .product-extra-details li{ margin-bottom:6px; }

    /* variant badge styles */
    .variant-badge{ position:absolute; top:4px; right:6px; background:var(--gold); color:#fff; font-size:0.65rem; border-radius:50%; min-width:16px; height:16px; display:flex; align-items:center; justify-content:center; font-weight:600; box-shadow:0 0 3px rgba(0,0,0,0.4); pointer-events:none; }
    .options-container button.has-combo{ box-shadow:0 8px 20px rgba(182,110,65,0.12); }
    .options-container button.combo-active{ background:rgba(182,110,65,0.14); border-color:var(--gold); color:#fff; }

    /* MODAL */
    #optionModal{ display:none; position:fixed; inset:0; background: rgba(20,21,23,0.95); justify-content:center; align-items:center; z-index:2000; }
    #optionModal .modal-content{ background:var(--bg-mid); padding:28px 22px; border-radius:14px; max-width:380px; text-align:center; box-shadow:0 12px 36px rgba(0,0,0,0.8); }
    #optionModal .modal-content p{ font-size:1rem; color:#fff; margin-bottom:18px; }
    #optionModal .modal-content button{ padding:10px 20px; border:none; border-radius:10px; background:var(--gold); color:var(--bg-dark); cursor:pointer; font-weight:700; transition: all 0.2s; }
    #optionModal .modal-content button:hover{ transform:translateY(-2px); }

    /* RESPONSIVE */
    @media (max-width:900px){
      main{ flex-direction:column; align-items:center; padding:20px; margin-top:120px; gap:30px; }
      .product-image, .product-details{ max-width:100%; width:100%; }
      .product-image img{ max-height:420px; object-fit:contain; }
      .product-details{ text-align:left; padding:0 10px; }
      .buttons-row{ flex-direction:row; width:100%; justify-content:space-between; gap:8px; }
      .action-btn{ min-width:110px; flex:1 1 auto; }
      .add-cart, .customize-btn, .back-btn{ width:auto; }
      .header-right{ display:none; flex-direction:column; background:rgba(20,21,23,0.98); position:absolute; top:70px; right:0; width:220px; padding:18px; border-radius:8px; z-index:1100; }
      .header-right.open{ display:flex; }
      .hamburger{ display:block; }
    }

    /* ensure any prior mobile sticky leftover hidden */
    .mobile-actions{ display:none !important; }

    /* small helper for the Total placeholder */
    .total-container { font-weight:600; color:var(--muted); margin-top:8px; text-align:left; }
  </style>
</head>
<body>

  <header class="site-header">
    <div class="header-left">
      <img src="asset/logo.png" alt="Sérac Logo" class="brand-logo">
      <div class="brand-title">Sérac</div>
    </div>

    <nav class="header-right">
      <a href="index.html">Home</a>
      <a href="shop.html">Shop</a>
      <a href="about.html">About</a>
      <a href="cart.html">Cart <span class="cart-count" id="cartCount">0</span></a>
      <a href="customization.html">Customize</a>
      <a href="contact.html">Contact</a>
      <a href="trackorder.html">Track</a>
    </nav>

    <button class="hamburger" id="hamburger" aria-expanded="false"><span></span><span></span><span></span></button>
  </header>

  <!-- Note: visibility:hidden initially to avoid the flash. It's made visible after DOM is filled. -->
  <main id="productContainer" style="visibility:hidden;">
    <div class="product-image">
      <img id="productImg" src="" alt="Product Image" />
      <div class="thumbnail-container" id="thumbnailContainer"></div>
    </div>

    <div class="product-details">
      <h1 id="productName"></h1>
      <div class="description" id="productDescription"></div>
      <div class="price" id="productPrice"></div>

      <!-- Variant groups (separated) -->
      <div class="option-group" id="sizeGroup" style="display:none;">
        <h4>Sizes</h4>
        <div class="options-container" id="sizeOptions"></div>
      </div>

      <div class="option-group" id="colorGroup" style="display:none;">
        <h4>Colors</h4>
        <div class="options-container" id="colorOptions"></div>
      </div>

      <!-- TOTAL placeholder (JS updates this - moved before quantity) -->
      <div id="totalVariantCount" class="total-container" style="display:none;"></div>

      <div class="quantity-controls" style="margin-top:8px;">
        <button id="minus">-</button>
        <span class="quantity-badge" id="quantityBadge">0</span>
        <button id="plus">+</button>
      </div>

      <!-- Buttons row: unified styling -->
      <div class="buttons-row" style="margin-bottom:12px;">
        <button class="action-btn add-cart" id="addCartBtn">Add to Cart</button>
        <a href="customization.html" id="customizeBtn" class="action-btn customize-btn" style="display:none;">Customize Product</a>
        <!-- Clear selections button will be created by JS via ensureClearButton() and appended into this row -->
        <a href="shop.html" class="action-btn back-btn" id="backBtnDesktop">Back to Shop</a>
      </div>

      <!-- Firestore details: rendered only when present; supports basic formatting -->
      <div id="productDetailsSection" class="product-extra-details" style="display:none;"></div>
    </div>
  </main>

  <!-- Option modal -->
  <div id="optionModal">
    <div class="modal-content">
      <p>Please select relevant options before adding to cart.</p>
      <button id="closeModalBtn">Okay</button>
    </div>
  </div>

  <footer style="text-align:center; padding:28px 14px; color:var(--muted); margin-top:40px; border-top:1px solid rgba(255,255,255,0.03);">
    <p>© 2025 Sérac</p>
  </footer>

<script type="module">
  // ---------- FIREBASE INIT ----------
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey:"AIzaSyCuiZXHFYl1fVKnGwojavRvbekSBpkipJg",
    authDomain:"brandisby.firebaseapp.com",
    projectId:"brandisby",
    storageBucket:"brandisby.firebasestorage.app",
    messagingSenderId:"87213267039",
    appId:"1:87213267039:web:339e9fd49e3ad31f7423ea"
  };
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // ---------- DOM REFS ----------
  const productContainer = document.getElementById('productContainer');
  const productImg = document.getElementById('productImg');
  const productName = document.getElementById('productName');
  const productDescription = document.getElementById('productDescription');
  const productPrice = document.getElementById('productPrice');
  const quantityBadge = document.getElementById('quantityBadge'); // middle control
  const addCartBtn = document.getElementById('addCartBtn');
  const minusBtn = document.getElementById('minus');
  const plusBtn = document.getElementById('plus');
  const cartCountElem = document.getElementById('cartCount'); // global cart total
  const customizeBtn = document.getElementById('customizeBtn');
  const thumbnailContainer = document.getElementById('thumbnailContainer');
  const colorOptions = document.getElementById('colorOptions');
  const sizeOptions = document.getElementById('sizeOptions');
  const colorGroup = document.getElementById('colorGroup');
  const sizeGroup = document.getElementById('sizeGroup');
  const optionModal = document.getElementById('optionModal');
  const closeModalBtn = document.getElementById('closeModalBtn');
  const detailsSection = document.getElementById('productDetailsSection');
  const urlParams = new URLSearchParams(window.location.search);


  const headerEl = document.querySelector('.site-header');
  const hamburger = document.getElementById('hamburger');
  const headerRight = document.querySelector('.header-right');

  const STORAGE_KEY = 'seracCart';

  // ---------- HELPERS ----------
  function normalizeOption(str){
    if (str === null || typeof str === 'undefined') return '';
    return String(str).trim().toLowerCase();
  }
  function comboKeyNorm(color = '', size = ''){
    return `${normalizeOption(color)}|${normalizeOption(size)}`;
  }

  // ---------- CART STORAGE ----------
  function getCart(){ return JSON.parse(localStorage.getItem(STORAGE_KEY)) || []; }
  function setCart(cart){ localStorage.setItem(STORAGE_KEY, JSON.stringify(cart)); updateCartCount(); }
  function updateCartCount(){ if(cartCountElem) cartCountElem.textContent = getCart().reduce((sum,i)=>sum + Number(i.quantity||0), 0); }


// ---------- CURRENCY DETECTION (SYNC WITH SHOP) ----------
  function detectShopActiveCurrency() {
    if (window.shopActiveCurrency) return window.shopActiveCurrency;
    const stored = localStorage.getItem('seracCurrency');
    if (stored) return stored;
    return 'NGN';
  }

  function openProductFromModal(productId) {
    const curr = detectShopActiveCurrency();
    window.shopActiveCurrency = curr;
    window.open(`product.html?productId=${productId}&currency=${curr}`, '_blank');
  }

  // ---------- CURRENCY SYMBOL FORMAT ----------
  function formatPriceForDisplay(amount, currency){
    const symbols = { USD:'$', EUR:'€', NGN:'₦', GBP:'£' };
    const sym = symbols[currency] || currency;
    return `${sym}${Number(amount).toLocaleString()}`;
  }

  // ---------- CURRENCY / PRICE RESOLUTION (SYNC) ----------
  function resolveDisplayPriceCurrency(productId, productData){
    const shopCurrency = detectShopActiveCurrency();
    const currencySymbols = { NGN: '₦', USD: '$', EUR: '€', GBP: '£' };
    const symbol = currencySymbols[shopCurrency] || shopCurrency;

    if(productData){
      const perKey = 'price' + shopCurrency.toUpperCase();
      if(typeof productData[perKey] !== 'undefined' && productData[perKey] !== null){
        return { price: productData[perKey], currency: shopCurrency, symbol };
      }
    }

    const saved = parseSavedProductFromLocalStorage?.();
    if(saved && (String(saved.id) === String(productId) || String(saved.productId) === String(productId))){
      if(typeof saved.price !== 'undefined'){
        return { price: saved.price, currency: shopCurrency, symbol };
      }
    }

    const urlCurrencyParam = new URLSearchParams(window.location.search).get('currency');
    const urlPriceParam = new URLSearchParams(window.location.search).get('price');
    if(urlPriceParam){
      const p = parseFloat(String(urlPriceParam).replace(/[^0-9\.\-]+/g,''));
      if(!isNaN(p)) return { price: p, currency: shopCurrency, symbol };
    }

    const cartMatch = findCartPriceCurrencyForProduct?.(productId);
    if(cartMatch){
      return { price: cartMatch.price, currency: shopCurrency, symbol };
    }

    if(productData){
      if(typeof productData.price !== 'undefined') return { price: productData.price, currency: shopCurrency, symbol };
      const fallback = ['priceNGN','priceUSD','priceEUR','priceGBP'].find(k => typeof productData[k] !== 'undefined');
      if(fallback) return { price: productData[fallback], currency: shopCurrency, symbol };
    }

    return { price: 0, currency: shopCurrency, symbol };
  }

  // ---------- PRODUCT TOTAL UI ----------
  let totalCountElem = document.getElementById('totalVariantCount');
  function ensureProductTotalElem(){
    if(totalCountElem) return;
    totalCountElem = document.createElement('div');
    totalCountElem.id = 'totalVariantCount';
    totalCountElem.style.margin = '8px 0 20px';
    totalCountElem.style.color = 'var(--muted)';
    totalCountElem.style.fontSize = '0.95rem';
    if(productPrice && productPrice.parentNode){
      productPrice.parentNode.insertBefore(totalCountElem, productPrice.nextSibling);
    } else {
      if(productContainer) productContainer.insertBefore(totalCountElem, productContainer.firstChild);
    }
  }
  function updateProductTotalUI(pid){
    ensureProductTotalElem();
    const total = getCart().filter(i => i.id === pid).reduce((s,i)=> s + Number(i.quantity||0), 0);
    totalCountElem.textContent = `Total: ${total}`;
    if(addCartBtn) addCartBtn.style.display = total > 0 ? 'none' : 'flex';
    // ensure the total placeholder is visible only when meaningful
    if(totalCountElem) totalCountElem.style.display = total > 0 ? '' : 'none';
  }

  // ---------- COMBO QUANTITY HELPERS ----------
  function getComboQty(pid, color = '', size = ''){
    const normColor = normalizeOption(color);
    const normSize = normalizeOption(size);
    const cart = getCart();
    const it = cart.find(i => i.id === pid && normalizeOption(i.color) === normColor && normalizeOption(i.size) === normSize);
    return Number(it?.quantity || 0);
  }

  // ---------- SELECTED QUANTITY DISPLAY ----------
  function updateSelectedQuantityDisplay(){
    const sel = getSelectedOptions();
    const hasAnyVariant = hasVariants();
    if(!hasAnyVariant){
      const total = getCart().filter(i => i.id === productId).reduce((s,i)=> s + Number(i.quantity||0), 0);
      if(quantityBadge) quantityBadge.textContent = total;
    } else {
      const qty = (sel.color || sel.size) ? getComboQty(productId, sel.color, sel.size) : 0;
      if(quantityBadge) quantityBadge.textContent = qty;
    }
    updateProductTotalUI(productId);
  }

  // ---------- MODAL ----------
  function showModal(message){
    if(!optionModal){ alert(message); return; }
    const p = optionModal.querySelector('p');
    if(p) p.textContent = message;
    optionModal.style.display = 'flex';
  }
  function hideModalAndReset(){
    if(!optionModal) return;
    const p = optionModal.querySelector('p');
    if(p) p.textContent = 'Please select relevant options before adding to cart.';
    optionModal.style.display = 'none';
  }

  function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;'); }

  function renderDetailsToHtml(raw){
    if(!raw) return '';
    const lines = String(raw).split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
    if(lines.length === 0) return '';
    const allBullets = lines.every(l => l.startsWith('-') || l.startsWith('*'));
    if(allBullets){
      const inner = lines.map(l => `<li>${escapeHtml(l.replace(/^[-*]+\s*/, ''))}</li>`).join('');
      return `<ul>${inner}</ul>`;
    } else {
      let out = ''; let inList = false;
      for(const line of lines){
        if(line.startsWith('-') || line.startsWith('*')){
          if(!inList){ inList = true; out += '<ul>'; }
          out += `<li>${escapeHtml(line.replace(/^[-*]+\s*/, ''))}</li>`;
        } else {
          if(inList){ out += '</ul>'; inList = false; }
          out += `<p>${escapeHtml(line)}</p>`;
        }
      }
      if(inList) out += '</ul>';
      return out;
    }
  }

  // ---------- SELECTION HELPERS ----------
  function getSelectedOptions(){
    return {
      color: colorOptions?.querySelector('.selected')?.dataset?.value || '',
      size: sizeOptions?.querySelector('.selected')?.dataset?.value || ''
    };
  }
  function hasVariants(){ return (sizeOptions && sizeOptions.children.length > 0) || (colorOptions && colorOptions.children.length > 0); }
  function validateSelectionForAdd(){
    const sel = getSelectedOptions();
    const requiresSize = sizeOptions && sizeOptions.children.length;
    const requiresColor = colorOptions && colorOptions.children.length;
    if((requiresSize && !sel.size) || (requiresColor && !sel.color)){
      showModal('Please select the required options before adding to cart.');
      return false;
    }
    return true;
  }

  // ---------- CART OPERATIONS (normalized comparisons) ----------
  function addToCart(product){
    const cart = getCart();
    const idx = cart.findIndex(i => i.id === product.id && normalizeOption(i.color) === normalizeOption(product.color) && normalizeOption(i.size) === normalizeOption(product.size));
    if(idx > -1){
      cart[idx].quantity = (Number(cart[idx].quantity)||0) + 1;
    } else {
      cart.push({...product, quantity:1});
    }
    setCart(cart);
    updateVariantBadges();
    updateSelectedQuantityDisplay();
    refreshClearButtonVisibility();
  }

  function removeFromCartSpecific(pid, color = '', size = ''){
    const cart = getCart();
    const idx = cart.findIndex(i => i.id === pid && normalizeOption(i.color) === normalizeOption(color) && normalizeOption(i.size) === normalizeOption(size));
    if(idx > -1){
      cart[idx].quantity = (Number(cart[idx].quantity)||0) - 1;
      if(cart[idx].quantity <= 0) cart.splice(idx,1);
      setCart(cart);
      updateVariantBadges();
      updateSelectedQuantityDisplay();
      refreshClearButtonVisibility();
      return true;
    }
    return false;
  }

  function removeFromCartFallback(pid){
    const cart = getCart();
    for(let i = cart.length - 1; i >= 0; i--){
      if(cart[i].id === pid){
        cart[i].quantity = (Number(cart[i].quantity)||0) - 1;
        if(cart[i].quantity <= 0) cart.splice(i,1);
        setCart(cart);
        updateVariantBadges();
        updateSelectedQuantityDisplay();
        refreshClearButtonVisibility();
        return true;
      }
    }
    return false;
  }

  function clearProductCombos(pid){
    let cart = getCart();
    cart = cart.filter(i => i.id !== pid);
    setCart(cart);
    updateVariantBadges();
    updateSelectedQuantityDisplay();
    refreshClearButtonVisibility();
  }

  // ---------- VARIANT BADGES (uses dataset.value, normalized) ----------
  function updateVariantBadges(){
    const cart = getCart();
    document.querySelectorAll('.variant-badge').forEach(n => n.remove());
    document.querySelectorAll('#sizeOptions > button, #colorOptions > button').forEach(b => { b.classList.remove('has-combo','combo-active'); });

    const mapSizeTotals = {};
    const mapColorTotals = {};
    const mapCombo = {}; // key: normalized color|size

    cart.forEach(item=>{
      if(!item || item.id !== productId) return;
      const normColor = normalizeOption(item.color || '');
      const normSize = normalizeOption(item.size || '');
      const qty = Number(item.quantity || 0);
      mapSizeTotals[normSize] = (mapSizeTotals[normSize] || 0) + qty;
      mapColorTotals[normColor] = (mapColorTotals[normColor] || 0) + qty;
      const ck = comboKeyNorm(normColor, normSize);
      mapCombo[ck] = (mapCombo[ck] || 0) + qty;
    });

    const activeSize = sizeOptions?.querySelector('.selected')?.dataset?.value || null;
    const activeColor = colorOptions?.querySelector('.selected')?.dataset?.value || null;
    const actNormSize = normalizeOption(activeSize || '');
    const actNormColor = normalizeOption(activeColor || '');

    function attachBadgeToBtn(btn, count){
      if(!btn) return;
      let badge = btn.querySelector('.variant-badge');
      if(!badge){
        badge = document.createElement('span');
        badge.className = 'variant-badge';
        badge.style.position = 'absolute';
        badge.style.top = '4px';
        badge.style.right = '6px';
        badge.style.background = 'var(--gold)';
        badge.style.color = '#fff';
        badge.style.fontSize = '0.65rem';
        badge.style.borderRadius = '50%';
        badge.style.minWidth = '16px';
        badge.style.height = '16px';
        badge.style.display = 'flex';
        badge.style.alignItems = 'center';
        badge.style.justifyContent = 'center';
        badge.style.fontWeight = '600';
        btn.style.position = 'relative';
        btn.appendChild(badge);
      }
      badge.textContent = String(count);
      badge.style.display = count > 0 ? 'flex' : 'none';
    }

    // size badges (show totals for that size across colors)
    if(sizeOptions){
      Array.from(sizeOptions.children).forEach(btn=>{
        const s = normalizeOption(btn.dataset?.value || btn.textContent.trim());
        const total = mapSizeTotals[s] || 0;
        if(total > 0){
          attachBadgeToBtn(btn, total);
          btn.classList.add('has-combo');
        } else {
          const b = btn.querySelector('.variant-badge'); if(b) b.remove();
        }
      });
    }

    // color badges (if size active show combo counts for that size, else totals)
    if(colorOptions){
      Array.from(colorOptions.children).forEach(btn=>{
        const c = normalizeOption(btn.dataset?.value || btn.textContent.trim());
        const key = comboKeyNorm(c, actNormSize || '');
        const comboQty = mapCombo[key] || 0;
        const total = mapColorTotals[c] || 0;

        if(activeSize){
          if(comboQty > 0){
            attachBadgeToBtn(btn, comboQty);
            btn.classList.add('has-combo');
          } else {
            const b = btn.querySelector('.variant-badge'); if(b) b.remove();
            btn.classList.remove('has-combo');
          }
        } else {
          if(total > 0){
            attachBadgeToBtn(btn, total);
            btn.classList.add('has-combo');
          } else {
            const b = btn.querySelector('.variant-badge'); if(b) b.remove();
            btn.classList.remove('has-combo');
          }
        }
      });
    }

    if(activeSize && activeColor){
      const sBtn = sizeOptions?.querySelector('.selected');
      const cBtn = colorOptions?.querySelector('.selected');
      if(sBtn) sBtn.classList.add('combo-active');
      if(cBtn) cBtn.classList.add('combo-active');
    }
  }

  // ---------- CLEAR BUTTON ----------
  function countProductCombos(pid){ return getCart().filter(i => i.id === pid).length; }
  let clearButton = null;
  function ensureClearButton(){
    if(!productContainer) return;
    if(!clearButton){
      clearButton = document.createElement('button');
      clearButton.type = 'button';
      clearButton.id = 'clearSelectionBtn';
      clearButton.className = 'action-btn';
      clearButton.textContent = 'Clear selections';
      Object.assign(clearButton.style, {
        marginTop: '0px',
        padding: '6px 14px',
        background: 'transparent',
        color: 'var(--accent-strong)',        // font color
        border: '2px dashed rgba(182,110,65,0.5)', // increased border size (1px → 2px)
        borderRadius: '8px',
        cursor: 'pointer',
        fontWeight: '700',
        fontSize: '15px',                     // increased font size
        transition: 'background var(--transition), color var(--transition), border var(--transition)'
        // marginTop: '0px',
        // padding: '6px 10px',
        // background: 'transparent',
        // color:'var(--accent-strong)',
        // border: '1px dashed rgba(182,110,65,0.22)',
        // borderRadius: '10px',
        // cursor: 'pointer',
        // fontWeight: '700',
        // transition: 'background var(--transition)', 
        // color: 'var(--transition)'
      });
      // Append into the buttons-row if present (so it sits inline with other action buttons)
      const buttonsRow = document.querySelector('.buttons-row');
      if(buttonsRow) buttonsRow.insertBefore(clearButton, buttonsRow.querySelector('#backBtnDesktop') || null);
      else {
        const details = document.querySelector('.product-details');
        if(details) details.appendChild(clearButton); else productContainer.appendChild(clearButton);
      }
      clearButton.addEventListener('click', ()=> { clearProductCombos(productId); });
    }
    refreshClearButtonVisibility();
  }
  function refreshClearButtonVisibility(){
    const combos = countProductCombos(productId);
    if(!clearButton) return;
    if(combos >= 2){ clearButton.style.display = 'inline-flex'; clearButton.style.opacity = '1'; }
    else clearButton.style.display = 'none';
  }

  window.updateVariantBadges = updateVariantBadges;
  window.refreshClearButtonVisibility = refreshClearButtonVisibility;

  // ---------- LOAD PRODUCT ----------
  const productId = urlParams.get('productId');
  let currentProductData = null;
  let sizesList = [];
  let colorsList = [];
  let comboMap = {};
  let resolvedDisplay = { price: null, currency: null }; // will be set after product loads

  async function loadProduct(){
  if(!productId){
    productContainer.style.visibility = 'visible';
    productContainer.innerHTML = '<p style="text-align:center;color:#d9534f;">Product ID missing.</p>';
    return;
  }
  try{
    const docRef = doc(db, "brands", "serac", "products", productId);
    const docSnap = await getDoc(docRef);
    if(!docSnap.exists()){
      productContainer.style.visibility = 'visible';
      productContainer.innerHTML = '<p style="text-align:center;color:#d9534f;">Product not found.</p>';
      return;
    }
    const data = docSnap.data();
    currentProductData = data || {};

    // Resolve display price & currency (after we have product doc)
    resolvedDisplay = resolveDisplayPriceCurrency(productId, currentProductData);
    

      // --- IMAGES ---
      const images = Array.isArray(data.images) && data.images.length ? data.images.filter(Boolean) : (data.imageUrl ? [data.imageUrl] : []);
      if(productImg) productImg.src = images[0] || '';
      if(thumbnailContainer) thumbnailContainer.innerHTML = '';
      images.forEach((imgUrl, idx) => {
        if(!imgUrl) return;
        const thumb = document.createElement('img');
        thumb.src = imgUrl;
        if(idx === 0) thumb.classList.add('selected');
        thumb.addEventListener('click', () => {
          if(productImg) productImg.src = imgUrl;
          thumbnailContainer.querySelectorAll('img').forEach(i=>i.classList.remove('selected'));
          thumb.classList.add('selected');
        });
        thumbnailContainer.appendChild(thumb);
      });

      // --- NAME & DESCRIPTION ---
      if(productName) productName.textContent = data.name || '';
      if(productDescription) productDescription.textContent = data.description || '';

      // --- PRICE RENDER ---
      const displayPrice = resolvedDisplay.price ?? (data.price || 0);
      const displayCurrency = resolvedDisplay.currency || 'USD';
      const displaySymbol = resolvedDisplay.symbol || '';
      if(productPrice) productPrice.textContent = formatPriceForDisplay(displayPrice, displayCurrency);
      currentProductData.price = displayPrice;
      currentProductData.currency = displayCurrency;

      // --- CUSTOMIZATION ---
      if(data.customizationAvailable){
        if(customizeBtn){ customizeBtn.style.display = 'block'; customizeBtn.href = `customization.html?productId=${productId}`; }
      } else { if(customizeBtn) customizeBtn.style.display = 'none'; }

      // --- VARIANTS PARSE ---
      sizesList = [];
      colorsList = [];
      comboMap = {};
      if(Array.isArray(data.variants) && data.variants.length){
        data.variants.forEach(v => {
          const s = (v.size || '').toString();
          const c = (v.color || '').toString();
          if(s && !sizesList.includes(s)) sizesList.push(s);
          if(c && !colorsList.includes(c)) colorsList.push(c);
          const key = comboKeyNorm(c, s);
          comboMap[key] = comboMap[key] || {};
          if(typeof v.stock !== 'undefined') comboMap[key].stock = v.stock;
        });
      } else {
        if(Array.isArray(data.sizes)) sizesList = data.sizes.slice();
        if(Array.isArray(data.colors)) colorsList = data.colors.slice();
      }

      // --- RENDER SIZE BUTTONS ---
      if(sizeOptions) sizeOptions.innerHTML = '';
      if(sizesList.length){
        if(sizeGroup) sizeGroup.style.display = '';
        sizesList.forEach(s => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.textContent = s;
          btn.dataset.value = s; // store exact label
          btn.addEventListener('click', ()=> {
            Array.from(sizeOptions.children).forEach(b=>b.classList.remove('selected'));
            btn.classList.add('selected');
            updateVariantBadges();
            updateSelectedQuantityDisplay();
            refreshClearButtonVisibility();
          });
          sizeOptions.appendChild(btn);
        });
      } else { if(sizeGroup) sizeGroup.style.display = 'none'; }

      // --- RENDER COLOR BUTTONS ---
      if(colorOptions) colorOptions.innerHTML = '';
      if(colorsList.length){
        if(colorGroup) colorGroup.style.display = '';
        colorsList.forEach(c => {
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.textContent = c;
          btn.dataset.value = c; // store exact label
          btn.addEventListener('click', ()=> {
            Array.from(colorOptions.children).forEach(b=>b.classList.remove('selected'));
            btn.classList.add('selected');
            updateVariantBadges();
            updateSelectedQuantityDisplay();
            refreshClearButtonVisibility();
          });
          colorOptions.appendChild(btn);
        });
      } else { if(colorGroup) colorGroup.style.display = 'none'; }

      // --- DETAILS ---
      if(data.details){
        const html = renderDetailsToHtml(data.details);
        if(html){ detailsSection.innerHTML = html; detailsSection.style.display = ''; }
        else detailsSection.style.display = 'none';
      } else detailsSection.style.display = 'none';

      updateCartCount();
      updateVariantBadges();
      ensureClearButton();
      updateSelectedQuantityDisplay();
      productContainer.style.visibility = 'visible';
    } catch(err){
      console.error(err);
      productContainer.style.visibility = 'visible';
      productContainer.innerHTML = '<p style="text-align:center;color:#d9534f;">Failed to load product.</p>';
    }
  }

  // ---------- BUTTON EVENTS ----------
  addCartBtn?.addEventListener('click', () => {
    if(!currentProductData) return;
    if(hasVariants() && !validateSelectionForAdd()) return;
    const sel = getSelectedOptions();
    addToCart({ id: productId, name: currentProductData.name, price: currentProductData.price, currency: currentProductData.currency, imageUrl: productImg?.src, color: sel.color || '', size: sel.size || '' });
  });

  plusBtn?.addEventListener('click', () => {
    if(!currentProductData) return;
    if(hasVariants() && !validateSelectionForAdd()) return;
    const sel = getSelectedOptions();
    addToCart({ id: productId, name: currentProductData.name, price: currentProductData.price, currency: currentProductData.currency, imageUrl: productImg?.src, color: sel.color || '', size: sel.size || '' });
  });

  minusBtn?.addEventListener('click', () => {
    if(!currentProductData) return;
    const sel = getSelectedOptions();
    const requiresSize = sizeOptions && sizeOptions.children.length;
    const requiresColor = colorOptions && colorOptions.children.length;
    const productHasVariants = requiresSize || requiresColor;

    if(productHasVariants && !sel.size && !sel.color){
      showModal('Please select the variant combination you want to remove.');
      return;
    }

    if(productHasVariants && ( (requiresSize && !sel.size) || (requiresColor && !sel.color) )){
      showModal('Please select all variant options (size and/or color) before removing.');
      return;
    }

    if(productHasVariants){
      const removed = removeFromCartSpecific(productId, sel.color, sel.size);
      if(!removed) showModal('No items of that selection to remove.');
      return;
    }

    const baseRemoved = removeFromCartFallback(productId);
    if(!baseRemoved) showModal('No items to remove.');
  });

  closeModalBtn?.addEventListener('click', hideModalAndReset);

  // ---------- THUMBNAIL SWIPE ----------
  let isDown=false, startX, scrollLeft;
  if(thumbnailContainer){
    thumbnailContainer.addEventListener('mousedown', e => { isDown=true; startX = e.pageX - thumbnailContainer.offsetLeft; scrollLeft = thumbnailContainer.scrollLeft; });
    thumbnailContainer.addEventListener('mouseup', () => { isDown=false; });
    thumbnailContainer.addEventListener('mouseleave', () => { isDown=false; });
    thumbnailContainer.addEventListener('mousemove', e => { if(!isDown) return; e.preventDefault(); const x = e.pageX - thumbnailContainer.offsetLeft; thumbnailContainer.scrollLeft = scrollLeft - (x - startX) * 2; });
  }

  // ---------- STORAGE SYNC ----------
  window.addEventListener('storage', () => { updateCartCount(); updateVariantBadges(); updateSelectedQuantityDisplay(); refreshClearButtonVisibility(); });

  // ---------- INIT ----------
  updateCartCount();
  loadProduct();

  /* ---------- HEADER / HAMBURGER (unchanged) ---------- */
  (function headerHeroBehavior(){
    const heroEl = document.querySelector('.hero') || { getBoundingClientRect: () => ({ height: 0 }) };
    if (!headerEl) return;
    let lastY = window.scrollY || 0, hidden=false, hoverShown=false, heroHeight = Math.round(heroEl.getBoundingClientRect().height || 0);
    function isMenuOpen(){ return hamburger && (hamburger.classList.contains('open') || headerRight.classList.contains('open')); }
    function showHeader(forceScrolled=false){ headerEl.style.top='0'; headerEl.style.opacity='1'; headerEl.style.pointerEvents='auto'; hidden=false; if(forceScrolled) headerEl.classList.add('scrolled'); }
    function hideHeader(){ headerEl.style.top='-90px'; headerEl.style.opacity='0'; headerEl.style.pointerEvents='none'; hidden=true; }
    function handleScroll(){ const y = window.scrollY || 0; const menuOpen = isMenuOpen(); const threshold = Math.max(50, (heroHeight || 0) - 80);
      if (y > threshold) headerEl.classList.add('scrolled'); else headerEl.classList.remove('scrolled');
      if (menuOpen) { showHeader(true); lastY = y; return; }
      if (y > (heroHeight - 80)) { if (y > lastY && !hidden) hideHeader(); else if (y < lastY && hidden) showHeader(true); } else { showHeader(y > 50); if (y <= 50) headerEl.classList.remove('scrolled'); }
      lastY = y;
    }
    document.addEventListener('mousemove', (e)=>{ if(isMenuOpen()) return; if(e.clientY < 100){ if(hidden){ showHeader(true); hoverShown = true; } } else if(hoverShown){ setTimeout(()=>{ if(window.scrollY > (heroHeight - 80) && !isMenuOpen()) hideHeader(); hoverShown=false; },220); } }, { passive:true });
    if(hamburger && headerRight){
      hamburger.addEventListener('click', ()=>{ const isNowOpen = hamburger.classList.toggle('open'); headerRight.classList.toggle('open', isNowOpen); hamburger.setAttribute('aria-expanded', isNowOpen ? 'true' : 'false'); if(isNowOpen){ showHeader(true); headerEl.classList.add('scrolled'); } else { setTimeout(handleScroll,160); } });
    }
    window.addEventListener('resize', ()=>{ heroHeight = Math.round(heroEl.getBoundingClientRect().height || 0); handleScroll(); }, { passive:true });
    window.addEventListener('scroll', handleScroll, { passive:true });
    window.addEventListener('load', ()=>{ heroHeight = Math.round(heroEl.getBoundingClientRect().height || 0); handleScroll(); });
  })();

  /* ---------- SMOOTH SCROLL (closes mobile menu) ---------- */
  document.querySelectorAll('.header-right a').forEach(link => {
    link.addEventListener('click', e => {
      const href = link.getAttribute('href');
      if (href && href.startsWith('#')) { e.preventDefault(); const target = document.getElementById(href.slice(1)); if (target) window.scrollTo({ top: target.offsetTop - 80, behavior: 'smooth' }); }
      if (headerRight && hamburger) { headerRight.classList.remove('open'); hamburger.classList.remove('open'); hamburger.setAttribute('aria-expanded', 'false'); }
    });
  });
</script>
</body>
</html>
