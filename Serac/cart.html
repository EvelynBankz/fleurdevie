<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sérac - Cart</title>

<!-- Fonts + Icons -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
:root{
  --bg-dark: #141517;
  --bg-mid: #2A2B30;
  --gold: #B66E41;
  --muted: #bdbdbd;
  --accent-strong: rgba(182,110,65,0.95);
  --radius: 12px;
  --transition: 0.25s cubic-bezier(.2,.9,.2,1);
}

/* RESET */
* { margin:0; padding:0; box-sizing:border-box; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }
html,body { height:100%; }
body { font-family:"Montserrat", sans-serif; background:var(--bg-dark); color:#e6e6e6; line-height:1.6; }
a { text-decoration:none; color:inherit; transition: color var(--transition); }

/* HEADER */
.site-header {
  background: transparent;
  transition: background 0.3s ease, border-bottom 0.3s ease, opacity 0.3s ease;
  color:#f5f5f5;
  display:flex; justify-content:space-between; align-items:center;
  padding:16px 28px;
  position:fixed; top:0; left:0; right:0;
  z-index:1000;
  border-bottom:1px solid rgba(255,255,255,0.04);
  opacity: 1;
}
.site-header.scrolled {
  background: var(--bg-dark);
  border-bottom: 1px solid rgba(255,255,255,0.06);
  opacity: 1;
}
.site-header:not(.scrolled) {
  opacity: 0.95;
}

.header-left { display:flex; align-items:center; gap:14px; }
.brand-logo { height:56px; width:auto; object-fit:contain; filter: drop-shadow(0 4px 12px rgba(0,0,0,0.6)); }
.brand-title { font-family:"Playfair Display", serif; font-size:22px; font-weight:700; color:var(--gold); letter-spacing:0.6px; }

/* HEADER LINKS + underline animation */
.header-right {
  display: flex;
  gap: 24px;
  font-weight: 500;
}

.header-right a {
  position: relative;
  color: #F5F5F3;
  padding: 6px 0;
  font-size: 1rem;
  transition: color 0.3s ease;
}

.header-right a::after {
  content: "";
  position: absolute;
  bottom: -4px;
  left: 0;
  width: 0;
  height: 2px;
  background: #B66E41;
  transition: width 0.3s ease;
}

.header-right a:hover {
  color: #B66E41; /* text color on hover */
}

.header-right a:hover::after {
  width: 100%; /* underline expands on hover */
}
  
/* cart count bubble */
.cart-count {
  background:var(--gold);
  color:var(--bg-dark);
  font-size:12px;
  font-weight:700;
  border-radius:50%;
  padding:3px 7px;
  margin-left:6px;
  box-shadow:0 4px 10px rgba(182,110,65,0.12);
}

/* Hamburger */
.hamburger { display:none; background:none; border:none; cursor:pointer; width:30px; height:24px; position:relative; }
.hamburger span { display:block; width:100%; height:3px; background:var(--gold); border-radius:2px; position:absolute; left:0; transition:0.3s; }
.hamburger span:nth-child(1){ top:0; }
.hamburger span:nth-child(2){ top:10px; }
.hamburger span:nth-child(3){ top:20px; }
.hamburger.open span:nth-child(1){ transform:rotate(45deg); top:10px; background:var(--gold); }
.hamburger.open span:nth-child(2){ opacity:0; }
.hamburger.open span:nth-child(3){ transform:rotate(-45deg); top:10px; background:var(--gold); }

/* HERO */
.hero {
  position: relative;
  height: 95vh;
  display: flex;
  justify-content: center;
  align-items: center;
  text-align: center;
  overflow: hidden;
  padding-top:72px;
  border-bottom-left-radius: 12px;
  border-bottom-right-radius:12px;
}
.hero::after {
  content: "";
  position: absolute;
  inset: 0;
  background: url("asset/bg25.jpg") center/cover no-repeat;
  transform: scale(1.06);
  z-index: -1;
  border-radius: 12px;
  box-shadow: inset 0 0 0 2000px rgba(20,21,23,0.55);
}
.hero-text { position: relative; display: inline-block; margin-bottom:12px; }
.hero-text h1 { font-family:"Playfair Display", serif; font-size: clamp(24px,5vw,48px); margin-bottom:12px; color:var(--gold); }
.hero-text p { font-size: clamp(16px,2vw,22px); max-width:700px; color:#F5F5F3 }

/* CART PAGE */
section.cart { padding:56px 18px; background: transparent; }
.container { max-width:1100px; margin:auto; }
h2 { text-align:center; font-size:24px; font-family:"Playfair Display", serif; margin-bottom:36px; color:#bfbfbf; letter-spacing:0.2px; }

.currency-selector {
  display: flex;
  justify-content: flex-end;
  align-items: center;
  gap: 6px;
  margin-bottom: 10px;
}
.currency-selector label { margin-right:8px; color:rgba(231,231,231,0.72); }
.currency-selector select {
  appearance: none;
  background-color: transparent;
  color: #e7e7e7;
  border: 1px solid rgba(231, 231, 231, 0.35);
  border-radius: 6px;
  padding: 6px 28px 6px 10px;
  font-family: "Montserrat", sans-serif;
  font-weight: 500;
  font-size: 13px;
  cursor: pointer;
  transition: all 0.3s ease;
  background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg width='10' height='6' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath fill='%23e7e7e7' d='M0 0l5 6 5-6z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  background-size: 10px 6px;
}
.currency-selector select:hover { border-color: rgba(231, 231, 231, 0.65); }
.currency-selector select:focus { outline: none; border-color: #ffffff; }

/* CART ITEMS */
.cart-grid { display:flex; flex-direction:column; gap:clamp(10px,2vw,18px); }
.cart-item {
  background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.03));
  padding:clamp(12px,1.4vw,18px);
  border-radius:12px;
  display:flex; flex-direction:column; gap:12px;
  box-shadow: 0 8px 30px rgba(0,0,0,0.6);
  border:1px solid rgba(255,255,255,0.03);
  transition: transform 220ms var(--transition), height 260ms ease;
  min-height: clamp(88px, 12vw, 140px);
  overflow:hidden;
}
.cart-item-header { display:flex; align-items:center; gap:16px; }
.cart-item-header img {
  width: clamp(64px, 12vw, 120px);
  height: clamp(64px, 12vw, 120px);
  object-fit:cover;
  border-radius:10px;
  border:1px solid rgba(255,255,255,0.08);
  box-shadow: 0 8px 24px rgba(0,0,0,0.6);
  flex-shrink:0;
}
.cart-item-details { flex:1; display:flex; flex-direction:column; color:var(--text); min-width:0; }
.cart-item-details h3 { font-family:"Playfair Display", serif; margin-bottom:6px; font-size:1.05rem; color:#fff; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.variant-summary { font-size:0.95rem; color:rgba(231,231,231,0.72); margin-bottom:6px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.price { font-weight:700; margin-bottom:8px; color:var(--gold); font-size:1rem; }

/* quantity controls */
.quantity-controls { display:flex; align-items:center; gap:8px; margin-bottom:8px; flex-wrap:wrap; }
.quantity-controls button {
  background: transparent; color:#e6e6e6; border:1px solid rgba(255,255,255,0.06);
  border-radius:8px; padding:8px 12px; cursor:pointer; font-weight:700; transition: all var(--transition);
}
.quantity-controls button:hover { transform:translateY(-3px); border-color:var(--gold); color:var(--gold); box-shadow: 0 8px 20px rgba(182,110,65,0.08); }
.quantity-controls input { width:64px; text-align:center; padding:8px; border-radius:8px; border:1px solid rgba(255,255,255,0.06); background:transparent; color:#e6e6e6; }

/* show variants */
.show-variants-btn {
  background: transparent; color:#e6e6e6; border: 1px solid rgba(255,255,255,0.05);
  border-radius: 8px; padding: 6px 8px; cursor: pointer; font-weight: 700; margin-top: 6px; display: inline-block; font-size: 13px; transition: all var(--transition);
}
.show-variants-btn:hover { background: rgba(182,110,65,0.06); border-color: var(--gold); color: var(--gold); transform:translateY(-3px); }

.variants-container { display:none; flex-direction:column; gap:8px; margin-top:8px; padding-left:8px; border-left:2px dashed rgba(255,255,255,0.03); }
.variant-row { display:flex; align-items:center; gap:8px; justify-content:space-between; flex-wrap:wrap; padding:8px 6px; border-radius:8px; background: rgba(255,255,255,0.01); border:1px solid rgba(255,255,255,0.02); }
.variant-meta { color:rgba(231,231,231,0.72); font-size:0.95rem; flex:1; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }

.cart-subtotal { text-align:right; font-weight:700; margin-top:10px; color:#fff; font-size:1.05rem; }
.cart-empty { text-align:center; font-size:18px; margin-top:20px; color:rgba(231,231,231,0.72); display:none; }
.cart-buttons { margin-top:20px; display:flex; justify-content:flex-end; gap:12px; flex-wrap:wrap; }
.cart-buttons a { padding:12px 20px; border-radius:10px; font-weight:700; transition: all var(--transition); display:inline-block; }
.cart-buttons .continue-btn { background:transparent; color:#e6e6e6; border:1px solid rgba(255,255,255,0.04); }
.cart-buttons .checkout-btn { background: linear-gradient(180deg, var(--gold), #a55a36); color:#fff; border:none; }

footer { text-align:center; padding:22px; background:transparent; color:#bdbdbd; margin-top:60px; border-top:1px solid rgba(255,255,255,0.02); }

/* RESPONSIVE */
@media(max-width:900px){
  .header-right { display:none; flex-direction:column; background:rgba(20,21,23,0.98); position:absolute; top:70px; right:0; width:220px; padding:18px; border-radius:8px; z-index:1100; }
  .header-right.open { display:flex; }
  .hamburger { display:block; }
  .hero-text h1 { font-size:32px; }
  .mobile-cart { display:flex; align-items:center; margin-right:10px; }
  .mobile-cart a { color:var(--gold); font-size:20px; position:relative; }
  .mobile-cart .cart-count { position:absolute; top:-8px; right:-8px; }
  .cart-item-header img { width:90px; height:90px; }
  .quantity-controls input { width:56px; }
}

@media(max-width:600px){
  .hero { height:40vh; margin-top:0; padding-top:80px; }
  .hero-text h1 { font-size:clamp(24px,5vw,32px); line-height:1.2; margin:0; }
  .hero-text p { font-size:clamp(14px,2.5vw,18px); margin:0 auto; }
}
  
button:focus, a:focus, input:focus, select:focus { outline: 3px solid rgba(182,110,65,0.12); outline-offset:2px; }

/* Chat-style floating support button */
  #floatingSupportBtn {
    position: fixed;
    bottom: 25px;
    right: 25px;
    width: 56px;
    height: 56px;
    background: #1a202b; /* Sérac primary color */
    color: #fff;
    border: none;
    border-radius: 50%;
    cursor: pointer;
    font-size: 24px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 6px 20px rgba(182, 110, 65, 1);
    transition: all 0.3s ease;
    z-index: 9999;
  }

  #floatingSupportBtn:hover {
    background: #20232b;
    transform: translateY(-2px);
    box-shadow: 0 8px 24px rgba(75, 78, 84, 1.0);
  }

  /* Tooltip */
  .support-tooltip {
    position: absolute;
    bottom: 50px;      /* tooltip above button */
    left: 20%;
    transform: translateX(-50%);
    background: #1c1e22;
    color: #fff;
    padding: 6px 12px;
    border-radius: 8px;
    font-size: 14px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease, transform 0.3s ease;
  }

  #floatingSupportBtn:hover .support-tooltip {
    opacity: 1;
    transform: translateX(-50%) translateY(-6px);
  }
</style>

  
<style>
@media(min-width: 900px) {
  .hero { position: relative; overflow: visible; }

  .hero-peek {
    position: absolute;
    bottom: -20px;
    left: 50%;
    transform: translateX(-50%);
    width: 90%;
    height: 20px;
    border-radius: 10px / 50%;
    z-index: 2;
    box-shadow: 0 -6px 15px rgba(0,0,0,0.15);
    animation: peekFloat 2s ease-in-out infinite alternate;
  }

  .hero-peek[data-theme="dark"] {
    background: linear-gradient(to top, rgba(182,110,65,0.3), transparent);
  }

  .hero-peek[data-theme="light"] {
    background: linear-gradient(to top, rgba(255,235,200,0.35), transparent);
  }

  @keyframes peekFloat {
    0% { transform: translateX(-50%) translateY(0); opacity: 0.85; }
    100% { transform: translateX(-50%) translateY(-4px); opacity: 1; }
  }
}
</style>
  
</head>
<body>

<header class="site-header">
  <div class="header-left">
    <img src="asset/logo.png" alt="Sérac Logo" class="brand-logo">
    <div class="brand-title">Sérac</div>
  </div>

  <!-- mobile cart (visible only on small screens) -->
  <div class="mobile-cart" style="display:none;">
    <a href="cart.html"><i class="fa-solid fa-cart-shopping"></i><span class="cart-count" id="cartCountMobile">0</span></a>
  </div>

  <nav class="header-right">
    <a href="index.html">Home</a>
    <a href="about.html">About</a>
     <a href="shop.html">Shop</a>
    <a href="cart.html">Cart <span class="cart-count" id="cartCount">0</span></a>
    <a href="customization.html">Customize</a>
    <a href="contact.html">Contact</a>
    <a href="trackorder.html">Track</a>
  </nav>

  <button class="hamburger" id="hamburger" aria-label="Menu"><span></span><span></span><span></span></button>
</header>

<section class="hero">
  <div class="hero-text">
    <h1>Your Cart</h1>
    <p>Review your items before checkout</p>
  </div>
</section>

<section class="cart">
  <div class="container">
    <h2>Shopping Cart</h2>
    <div class="currency-selector">
      <label for="currency">Currency: </label>
      <div class="select-wrapper" id="currencyWrapper">
        <select id="currency">
          <option value="NGN">NGN</option>
          <option value="USD">USD</option>
          <option value="EUR">EUR</option>
          <option value="GBP">GBP</option>
        </select>
      </div>
    </div>

    <div class="cart-grid" id="cartGrid"></div>
    <div class="cart-empty" id="cartEmpty">Your cart is empty.</div>
    <div class="cart-subtotal" id="cartSubtotal"></div>
    <div class="cart-buttons">
      <a href="shop.html" class="continue-btn">Continue Shopping</a>
      <a href="checkout/index.html" class="checkout-btn" id="checkoutBtn">Proceed to Checkout</a>
    </div>
  </div>
</section>

<!-- Floating Chat-Style Support Button -->
  <button id="floatingSupportBtn" aria-label="Contact Support">
    <i class="fas fa-headset"></i>
    <span class="support-tooltip">Support</span>
  </button>
  
<footer>
  <p>© 2025 Sérac</p>
</footer>

<script type="module">
/* ---------- Firebase ---------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCuiZXHFYl1fVKnGwojavRvbekSBpkipJg",
  authDomain: "brandisby.firebaseapp.com",
  projectId: "brandisby",
  storageBucket: "brandisby.firebasestorage.app",
  messagingSenderId: "87213267039",
  appId: "1:87213267039:web:339e9fd49e3ad31f7423ea"
};
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ---------- DOM refs ---------- */
const cartGrid = document.getElementById('cartGrid');
const cartEmpty = document.getElementById('cartEmpty');
const cartCountElem = document.getElementById('cartCount');
const cartCountMobileElem = document.getElementById('cartCountMobile');
const cartSubtotalElem = document.getElementById('cartSubtotal');
const checkoutBtn = document.getElementById('checkoutBtn');
const currencySelect = document.getElementById('currency');
const currencyWrapper = document.getElementById('currencyWrapper');
const hamburger = document.getElementById('hamburger');
const headerRight = document.querySelector('.header-right');

const STORAGE_KEY = 'seracCart';
const CURRENCY_KEY = 'seracCurrency';

/* ---------- State ---------- */
function loadCartFromStorage(){
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if(!raw) return [];
    const parsed = JSON.parse(raw);
    return Array.isArray(parsed) ? parsed : [];
  } catch (e) {
    console.warn('Failed to parse cart from localStorage', e);
    return [];
  }
}
let cart = loadCartFromStorage();
let productCache = {}; // product docs cache

/* ---------- Helpers ---------- */
function formatPrice(value, currency){
  const localeMap = { USD:'en-US', EUR:'de-DE', GBP:'en-GB', NGN:'en-NG' };
  const minFrac = currency === 'NGN' ? 0 : 2;
  try {
    return new Intl.NumberFormat(localeMap[currency] || 'en-US', { style:'currency', currency, minimumFractionDigits:minFrac }).format(Number(value||0));
  } catch(e){
    return `${currency} ${Number(value||0).toFixed(minFrac)}`;
  }
}

function escapeHtml(str){ if(!str && str !== 0) return ""; return String(str).replace(/[&<>"']/g, s => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": "&#39;" }[s])); }

function mergeCartItems(cartArray){
  const merged = [];
  (cartArray || []).forEach(item=>{
    const idx = merged.findIndex(i => i.id === item.id && (i.color||'')=== (item.color||'') && (i.size||'') === (item.size||''));
    if(idx===-1) merged.push({...item});
    else merged[idx].quantity = (merged[idx].quantity||0) + (item.quantity||0);
  });
  return merged;
}

function totalQuantityByProduct(productId){
  return cart.filter(i=>i.id===productId).reduce((sum,i)=>sum+(i.quantity||0),0);
}
function groupVariants(productId){ return cart.filter(i=>i.id===productId); }

async function fetchProductData(productId){
  try{
    if(productCache[productId]) return productCache[productId];
    const dref = doc(db,"brands","serac","products",productId);
    const snap = await getDoc(dref);
    if(snap.exists()){
      productCache[productId] = snap.data();
      return productCache[productId];
    }
  }catch(e){ console.warn("Fetch product failed", productId, e); }
  return null;
}

function computeSubtotal(currency){
  let subtotal = 0;
  for(const it of cart){
    const product = productCache[it.id];
    const price = (product && product[`price${currency}`]) || it.price || 0;
    subtotal += Number(price || 0) * Number(it.quantity || 0);
  }
  return subtotal;
}

/* ---------- UI: cart count (prevent flash) ---------- */
if(cartCountElem) cartCountElem.classList.add('hidden');
if(cartCountMobileElem) cartCountMobileElem.classList.add('hidden');

function updateCartCount(){
  const totalItems = cart.reduce((sum,i)=>sum+(i.quantity||0),0);
  const text = totalItems;
  if(cartCountElem) cartCountElem.textContent = text;
  if(cartCountMobileElem) cartCountMobileElem.textContent = text;

  if(totalItems > 0){
    if(cartCountElem) { cartCountElem.classList.remove('hidden'); cartCountElem.classList.add('pulse'); }
    if(cartCountMobileElem) { cartCountMobileElem.classList.remove('hidden'); cartCountMobileElem.classList.add('pulse'); }
    setTimeout(()=>{ if(cartCountElem) cartCountElem.classList.remove('pulse'); if(cartCountMobileElem) cartCountMobileElem.classList.remove('pulse'); },160);
  } else {
    if(cartCountElem) cartCountElem.classList.add('hidden');
    if(cartCountMobileElem) cartCountMobileElem.classList.add('hidden');
  }
}

/* ---------- Render cart ---------- */
async function renderCart(){
  // clear grid
  if(productCache === undefined) productCache = {};
  cartGrid && (cartGrid.innerHTML = '');

  if(!cart.length){
    cartEmpty && (cartEmpty.style.display='block');
    cartSubtotalElem && (cartSubtotalElem.textContent='');
    checkoutBtn && (checkoutBtn.style.display='none');
    updateCartCount();
    return;
  }
  cartEmpty && (cartEmpty.style.display='none');
  checkoutBtn && (checkoutBtn.style.display='inline-block');

  // Ensure currency select shows the currently selected currency from localStorage
  const currency = currencySelect?.value || localStorage.getItem(CURRENCY_KEY) || 'NGN';
  if(currencySelect && currencySelect.value !== currency) currencySelect.value = currency;

  let subtotal = 0;
  const productIds = [...new Set(cart.map(i=>i.id))];

  for(const pid of productIds){
    const product = await fetchProductData(pid);
    const variants = groupVariants(pid);
    const totalQty = totalQuantityByProduct(pid);
    const thumbnail = (product && Array.isArray(product.images) && product.images[0]) || product?.imageUrl || 'asset/placeholder.jpg';
    const lineTotal = variants.reduce((sum,v)=>sum + (Number((product && product[`price${currency}`]) || v.price || 0) * Number(v.quantity || 0)),0);
    subtotal += lineTotal;

    const hasVariantMeta = variants.length > 1 || variants.some(v=> (v.color && v.color.trim()!=='') || (v.size && v.size.trim()!=='' ));
    // IMPORTANT: when hasVariantMeta we show SUMMARY as "Quantity: N" (no in-main quantity controls) and provide a "Show Choices" button.
    const variantSummaryText = hasVariantMeta ? `Quantity: ${totalQty}` : `Quantity: ${totalQty}`;

    const itemDiv = document.createElement('div');
    itemDiv.className = 'cart-item';
    itemDiv.id = `cart-item-${pid}`;
    itemDiv.dataset.productId = pid;

    itemDiv.innerHTML = `
      <div class="cart-item-header">
        <img src="${thumbnail}" alt="${(product && product.name) ? escapeHtml(product.name) : 'Product'}">
        <div class="cart-item-details">
          <h3 title="${(product && product.name) ? escapeHtml(product.name) : 'Product'}">${(product && product.name) ? escapeHtml(product.name) : 'Product'}</h3>
          <div class="variant-summary">${variantSummaryText}</div>
          <div class="price">${formatPrice(lineTotal, currency)}</div>

          <!-- MAIN QUANTITY: only visible when there are NO variant choices -->
          <div class="quantity-controls main-quantity" ${hasVariantMeta ? 'style="display:none;"' : ''}>
            <button class="qty-minus" data-id="${pid}">-</button>
            <input type="number" min="0" value="${totalQty}" data-id="${pid}">
            <button class="qty-plus" data-id="${pid}">+</button>
          </div>

          ${hasVariantMeta ? '<button class="show-variants-btn">Show Choices</button>' : ''}

          <div class="variants-container" style="display:none;">
            ${variants.map(v=>`<div class="variant-row" data-id="${v.id}" data-color="${(v.color||'')}" data-size="${(v.size||'')}">
                <div class="variant-meta">${v.color? v.color+' / ':''}${v.size? v.size+' x ':''}${v.quantity}</div>
                <div class="quantity-controls variant-controls">
                  <button class="v-minus" data-id="${v.id}" data-color="${(v.color||'')}" data-size="${(v.size||'')}">-</button>
                  <input type="number" min="0" value="${v.quantity}" data-id="${v.id}" data-color="${(v.color||'')}" data-size="${(v.size||'')}">
                  <button class="v-plus" data-id="${v.id}" data-color="${(v.color||'')}" data-size="${(v.size||'')}">+</button>
                </div>
              </div>`).join('')}
          </div>

        </div>
      </div>
    `;
    cartGrid && cartGrid.appendChild(itemDiv);
  }

  cartSubtotalElem && (cartSubtotalElem.textContent = 'Subtotal: ' + formatPrice(subtotal, currency));
  localStorage.setItem(STORAGE_KEY, JSON.stringify(cart));
  updateCartCount();
}

/* ---------- Update single product row (fine-grained) ---------- */
async function updateItemRow(productId){
  // Update only the row for productId (no full re-render)
  const itemDiv = document.getElementById(`cart-item-${productId}`);
  const currency = currencySelect?.value || localStorage.getItem(CURRENCY_KEY) || 'NGN';
  const variants = groupVariants(productId);

  // If no variants left, remove row and update subtotal/count
  if(variants.length === 0){
    if(itemDiv) itemDiv.remove();
    const subtotal = computeSubtotal(currency);
    if(cartSubtotalElem) cartSubtotalElem.textContent = subtotal ? 'Subtotal: ' + formatPrice(subtotal, currency) : '';
    if(cart.length === 0){
      cartEmpty && (cartEmpty.style.display='block');
      checkoutBtn && (checkoutBtn.style.display='none');
    }
    updateCartCount();
    localStorage.setItem(STORAGE_KEY, JSON.stringify(cart));
    return;
  }

  const product = await fetchProductData(productId);
  if(!product) {
    // product not found; fallback to re-render
    return renderCart();
  }

  // If row doesn't exist (maybe it was removed), re-render
  if(!itemDiv) return renderCart();

  const totalQty = totalQuantityByProduct(productId);
  const lineTotal = variants.reduce((s,v)=> s + (Number((product && product[`price${currency}`]) || v.price || 0) * Number(v.quantity || 0)), 0);
  const hasVariantMeta = variants.length > 1 || variants.some(v=> (v.color && v.color.trim()!=='') || (v.size && v.size.trim()!=='' ));

  // update price
  const priceEl = itemDiv.querySelector('.price');
  if(priceEl) priceEl.textContent = formatPrice(lineTotal, currency);

  // update summary
  const summaryEl = itemDiv.querySelector('.variant-summary');
  if(summaryEl) summaryEl.textContent = `Quantity: ${totalQty}`;

  // main quantity: show only when no variant meta (single product)
  const mainQtyEl = itemDiv.querySelector('.main-quantity');
  if(mainQtyEl){
    if(hasVariantMeta){
      mainQtyEl.style.display = 'none';
    } else {
      mainQtyEl.style.display = 'flex';
      const mainInput = mainQtyEl.querySelector('input[type="number"]');
      if(mainInput) mainInput.value = totalQty;
    }
  }

  // Update variants container DOM
  const variantsContainer = itemDiv.querySelector('.variants-container');
  if(variantsContainer){
    variantsContainer.innerHTML = variants.map(v=>`
      <div class="variant-row" data-id="${v.id}" data-color="${(v.color||'')}" data-size="${(v.size||'')}">
        <div class="variant-meta">${v.color? v.color+' / ':''}${v.size? v.size+' x ':''}${v.quantity}</div>
        <div class="quantity-controls variant-controls">
          <button class="v-minus" data-id="${v.id}" data-color="${(v.color||'')}" data-size="${(v.size||'')}">-</button>
          <input type="number" min="0" value="${v.quantity}" data-id="${v.id}" data-color="${(v.color||'')}" data-size="${(v.size||'')}">
          <button class="v-plus" data-id="${v.id}" data-color="${(v.color||'')}" data-size="${(v.size||'')}">+</button>
        </div>
      </div>
    `).join('');
    // keep variantsContainer hidden by default; leave toggled state to button logic
  }

  // update subtotal, storage and count
  const subtotal = computeSubtotal(currency);
  if(cartSubtotalElem) cartSubtotalElem.textContent = subtotal ? 'Subtotal: ' + formatPrice(subtotal, currency) : '';
  localStorage.setItem(STORAGE_KEY, JSON.stringify(cart));
  updateCartCount();
}

/* persist + targeted update */
function persistAndUpdate(productId){
  cart = cart.filter(i => (i.quantity||0) > 0);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(cart));
  if(productId) updateItemRow(productId);
  else renderCart();
}

/* ---------- Event delegation for cart interactions ---------- */
cartGrid && cartGrid.addEventListener('click', e=>{
  const target = e.target;
  const pid = target.dataset.id;

  // MAIN + / - (only used when no variants present, main-quantity is visible)
  if(target.classList.contains('qty-plus')){
    const productVariants = cart.filter(i=>i.id===pid);
    if(productVariants.length===0) return;
    // If multiple variants exist (shouldn't in this UI) we increment the first matching
    productVariants[0].quantity = (productVariants[0].quantity||0) + 1;
    persistAndUpdate(pid);
    return;
  }

  if(target.classList.contains('qty-minus')){
    const productVariants = cart.filter(i=>i.id===pid);
    if(productVariants.length===0) return;
    const idx = cart.findIndex(i => i.id===pid && (i.quantity||0)>0);
    if(idx!==-1){
      cart[idx].quantity = (cart[idx].quantity||0) - 1;
      if(cart[idx].quantity <= 0) cart.splice(idx,1);
      persistAndUpdate(pid);
    }
    return;
  }

  // Variant-level plus/minus
  if(target.classList.contains('v-plus')){
    const id = target.dataset.id; const color = target.dataset.color||''; const size = target.dataset.size||'';
    const idx = cart.findIndex(i=>i.id===id && (i.color||'')===color && (i.size||'')===size);
    if(idx!==-1){ cart[idx].quantity = (cart[idx].quantity||0) + 1; persistAndUpdate(id); }
    return;
  }

  if(target.classList.contains('v-minus')){
    const id = target.dataset.id; const color = target.dataset.color||''; const size = target.dataset.size||'';
    const idx = cart.findIndex(i=>i.id===id && (i.color||'')===color && (i.size||'')===size);
    if(idx!==-1){
      cart[idx].quantity = (cart[idx].quantity||0) - 1;
      if(cart[idx].quantity <= 0) cart.splice(idx,1);
      persistAndUpdate(id);
    }
    return;
  }

  // Show/Hide choices
  if(target.classList.contains('show-variants-btn')){
    const container = target.nextElementSibling; // variants-container
    if(!container) return;
    const isOpen = container.style.display === 'flex';
    container.style.display = isOpen ? 'none' : 'flex';
    target.textContent = isOpen ? 'Show Choices' : 'Hide Choices';
    return;
  }
});

/* numeric inputs handling */
cartGrid && cartGrid.addEventListener('input', e=>{
  const target = e.target;
  if(target.tagName !== 'INPUT') return;
  const id = target.dataset.id; const color = target.dataset.color||''; const size = target.dataset.size||'';
  const val = parseInt(target.value, 10);
  if(isNaN(val) || val < 0) return;

  if(color || size){
    const idx = cart.findIndex(i=>i.id===id && (i.color||'')===color && (i.size||'')===size);
    if(idx!==-1){
      cart[idx].quantity = val;
      if(cart[idx].quantity === 0) cart.splice(idx,1);
      persistAndUpdate(id);
    }
  } else {
    // updating main quantity (single-item case)
    const idx = cart.findIndex(i=>i.id===id);
    if(idx!==-1){
      cart[idx].quantity = val;
      if(cart[idx].quantity === 0) cart.splice(idx,1);
      persistAndUpdate(id);
    }
  }
});

/* currency change handling */
if(currencySelect) currencySelect.addEventListener('change', async ()=>{
  currencyWrapper && currencyWrapper.classList.add('loading');
  // write selected currency to localStorage so other pages/tabs will sync
  try { localStorage.setItem(CURRENCY_KEY, currencySelect.value); } catch(e){ console.warn("Failed to save currency", e); }
  // small UX delay
  await new Promise(r=>setTimeout(r,260));
  currencyWrapper && currencyWrapper.classList.remove('loading');
  // re-render cart with new currency
  await renderCart();
});

/* mobile cart visibility */
function handleMobileCart(){ 
  const el = document.querySelector('.mobile-cart');
  if(!el) return;
  el.style.display = window.innerWidth <= 600 ? 'flex' : 'none';
}
window.addEventListener('resize', handleMobileCart);
handleMobileCart();

/* storage sync (other tabs) */
/* Replaced the generic handler with a key-aware handler to sync currency and cart properly */
window.addEventListener('storage', (ev) => {
  try {
    // If cart storage changed, reload cart state and re-render
    if (ev.key === STORAGE_KEY) {
      cart = loadCartFromStorage();
      cart = mergeCartItems(cart);
      updateCartCount();
      renderCart();
      return;
    }

    // If currency changed in another tab/page, update the dropdown and re-render
    if (ev.key === CURRENCY_KEY) {
      const newCurrency = ev.newValue || localStorage.getItem(CURRENCY_KEY) || 'NGN';
      if (currencySelect && currencySelect.value !== newCurrency) {
        try { currencySelect.value = newCurrency; } catch(e) {}
      }
      renderCart();
      return;
    }

    // Fallback: if other keys changed, just refresh cart state conservatively
    // (this preserves previous behavior in case some other code updates localStorage)
    if (!ev.key) {
      cart = loadCartFromStorage();
      cart = mergeCartItems(cart);
      updateCartCount();
      renderCart();
    }
  } catch (err) {
    console.warn("Storage event handling error", err);
  }
});

/* -------------------- HEADER/HERO BEHAVIOR (darken immediately; hide after hero) -------------------- */
(function headerHeroBehavior(){
  const headerEl = document.querySelector('.site-header') || document.getElementById('siteHeader');
  const heroEl = document.querySelector('.hero') || document.getElementById('heroSection') || document.querySelector('.hero-about');
  const hamburger = document.getElementById('hamburger');
  const headerRight = document.querySelector('.header-right');

  if (!headerEl || !heroEl) return;

  let lastY = window.scrollY || 0;
  let hidden = false;
  let hoverShown = false;
  let heroHeight = Math.round(heroEl.getBoundingClientRect().height);

  function isMenuOpen() {
    return hamburger && hamburger.classList.contains('open');
  }

  function showHeader(forceScrolledClass = false) {
    headerEl.style.top = '0';
    headerEl.style.opacity = '1';
    headerEl.style.pointerEvents = 'auto';
    hidden = false;
    if (forceScrolledClass) headerEl.classList.add('scrolled');
  }

  function hideHeader() {
    headerEl.style.top = '-90px';
    headerEl.style.opacity = '0';
    headerEl.style.pointerEvents = 'none';
    hidden = true;
  }

  function updateScrolledClassOnScroll(y) {
    if (y > 0) headerEl.classList.add('scrolled');
    else headerEl.classList.remove('scrolled');
  }

  function handleScroll() {
    const y = window.scrollY || 0;
    const menuOpen = isMenuOpen();
    const threshold = Math.max(50, heroHeight - 80);

    updateScrolledClassOnScroll(y);

    if (menuOpen) {
      showHeader(true);
      lastY = y;
      return;
    }

    if (y > threshold) {
      if (y > lastY && !hidden) hideHeader();
      else if (y < lastY && hidden) showHeader(true);
    } else {
      if (y === 0) headerEl.classList.remove('scrolled');
      showHeader(false);
    }

    lastY = y;
  }

  // Hover reveal (only when menu is closed)
  document.addEventListener('mousemove', (e) => {
    if (isMenuOpen()) return;
    if (e.clientY < 100) {
      if (hidden) {
        showHeader(true);
        hoverShown = true;
      }
    } else if (hoverShown) {
      setTimeout(() => {
        if (window.scrollY > Math.max(50, heroHeight - 80) && !isMenuOpen()) hideHeader();
        hoverShown = false;
      }, 220);
    }
  }, { passive: true });
  

  /* === FIXED HAMBURGER MENU BEHAVIOR === */
  if (hamburger && headerRight) {
    hamburger.addEventListener('click', () => {
      const isNowOpen = hamburger.classList.toggle('open');
      headerRight.classList.toggle('open', isNowOpen);

      if (isNowOpen) {
        // Show header fully and keep dark so dropdown is readable
        showHeader(true);
        headerEl.classList.add('scrolled');
      } else {
        handleScroll();
      }
    });
  }

  window.addEventListener('resize', () => {
    heroHeight = Math.round(heroEl.getBoundingClientRect().height);
    handleScroll();
  }, { passive: true });

  window.addEventListener('scroll', handleScroll, { passive: true });

  window.addEventListener('load', () => {
    heroHeight = Math.round(heroEl.getBoundingClientRect().height);
    updateScrolledClassOnScroll(window.scrollY || 0);
    handleScroll();
  });
})();

/* === SMOOTH SCROLL === */
document.querySelectorAll('.header-right a').forEach(link => {
  link.addEventListener('click', e => {
    const href = link.getAttribute('href');
    if (href && href.startsWith('#')) {
      e.preventDefault();
      const target = document.getElementById(href.slice(1));
      if (target) {
        window.scrollTo({ top: target.offsetTop - 80, behavior: 'smooth' });
      }
      headerRight.classList.remove('open');
      hamburger.classList.remove('open');
    }
  });
});

/* ---------- Init ---------- */
(async function init(){
  // Ensure currency select reflects saved preference at start
  try {
    const savedCurrency = localStorage.getItem(CURRENCY_KEY);
    if (currencySelect && savedCurrency) currencySelect.value = savedCurrency;
  } catch(e){ /* ignore */ }

  // load and merge safely, update count early (prevents transient zero flash)
  cart = mergeCartItems(loadCartFromStorage());
  updateCartCount();
  await renderCart();
})();
</script>

<script>
(function() {
  const applyHeroPeek = () => {
    const heroes = document.querySelectorAll('.hero');
    heroes.forEach(hero => {
      if (hero.querySelector('.hero-peek')) return;

      const peek = document.createElement('div');
      peek.className = 'hero-peek';

      // Determine hero brightness (basic)
      const bg = window.getComputedStyle(hero).backgroundColor;
      let darkHero = true;
      if (bg && bg.startsWith && bg.startsWith('rgb')) {
        const rgb = bg.match(/\d+/g).map(Number);
        const brightness = (rgb[0]*299 + rgb[1]*587 + rgb[2]*114) / 1000;
        darkHero = brightness < 128; // simple threshold
      }

      peek.dataset.theme = darkHero ? 'dark' : 'light';
      hero.appendChild(peek);
    });
  };

  window.addEventListener('load', applyHeroPeek);
  window.addEventListener('resize', applyHeroPeek);
})();
</script>


</body>
</html>
