<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Fleur De Vie Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing:border-box; margin:0; padding:0; }
    body { font-family: "Montserrat", sans-serif; background:#F5E6CC; color:#112e1f; line-height:1.6; }
    a { text-decoration:none; color:inherit; }

    header { background:#112e1f; color:#FFD6BA; padding:16px; text-align:center; font-family:"Playfair Display", serif; font-size:24px; font-weight:700; }

    .container { max-width:1000px; margin:2rem auto; padding:2rem; background:#FFD6BA; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); }

    h2 { font-family:"Playfair Display", serif; margin-bottom:16px; color:#112e1f; }

    label { display:block; margin-top:1rem; font-weight:500; }
    input, textarea, select { width:100%; padding:0.6rem; margin-top:0.5rem; border:1px solid #112e1f; border-radius:6px; font-size:1rem; }

    button { margin-top:1rem; padding:0.75rem 1.2rem; background:#112e1f; color:#FFD6BA; border:none; border-radius:6px; cursor:pointer; font-weight:600; transition:0.3s; }
    button:hover { background:#0a1d14; }

    .message { margin-top:1rem; font-weight:500; font-size:1rem; text-align:center; }

    table { width:100%; border-collapse:collapse; margin-top:1.5rem; background:#fff; border-radius:12px; overflow:hidden; }
    th, td { padding:0.75rem; border-bottom:1px solid #ddd; text-align:left; font-size:0.95rem; vertical-align:top; }
    th { background:#F5E6CC; font-family:"Playfair Display", serif; color:#112e1f; }
    td img { width:60px; border-radius:6px; }

    .actions button { margin-right:0.5rem; padding:0.4rem 0.6rem; font-size:0.9rem; }
    .actions button:hover { opacity:0.85; }

    .small-note { font-size:0.9rem; color:#334d3a; margin-top:8px; }

    /* Dashboard Navigation */
    .dashboard-nav { display:flex; gap:10px; margin-bottom:1.5rem; }
    .dashboard-nav button { flex:1; }
    .section { display:none; margin-top:1rem; }
    .section.active { display:block; }

    .details-row { background:#fff6e8; }
    .details-row td { padding:12px; }

    /* Orders filter/search */
    .order-filters { display:flex; gap:10px; margin-bottom:1rem; flex-wrap:wrap; }
    .order-filters input, .order-filters select { flex:1; max-width: 320px; }

    .quote-item { border:1px solid #eee; padding:8px; margin-top:8px; background:#fff; border-radius:6px; }

    .copy-btn { background:none; border:none; cursor:pointer; margin-left:6px; font-size:1rem; }
    .copy-btn:hover { opacity:0.7; }

    @media(max-width:600px){
      .container { padding:1rem; }
      table, th, td { font-size:0.85rem; }
      th, td { padding:0.5rem; }
      .dashboard-nav { flex-direction:column; }
      .order-filters { flex-direction: column; }
    }

    /* Add Item panel styling (small) */
    .add-item-panel { border:1px dashed rgba(17,46,31,0.12); padding:12px; margin-top:8px; background:#fff; border-radius:8px; }
    .inline-grid { display:grid; grid-template-columns: repeat(4,1fr); gap:8px; }
    @media(max-width:600px){ .inline-grid { grid-template-columns: 1fr; } }

    /* Repeatable product fields */
    .repeatable { margin-top:8px; }
    .repeatable .row { display:flex; gap:8px; margin-top:8px; }
    .repeatable .row input { flex:1; }
    .repeatable .row button { flex-shrink:0; padding:0.4rem 0.6rem; }

    /* Modal for quote view */
    .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,0.45); display:none; align-items:center; justify-content:center; z-index:9999; }
    .modal { background:#fff; padding:16px; border-radius:10px; max-width:800px; width:95%; max-height:90vh; overflow:auto; }
    .modal .modal-header { display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .modal .modal-body { margin-top:12px; }
    .modal .close { background:none; border:1px solid #112e1f; color:#112e1f; padding:6px 10px; border-radius:6px; cursor:pointer; }

    /* small status tag */
    .status-tag { display:inline-block;padding:4px 8px;border-radius:6px;font-size:0.9rem;font-weight:600; }
    .status-tag.paid { background:#0fa958; color:white; }
    .status-tag.unpaid { background:#d9534f; color:white; }
    .dim-text { color:#666; font-size:0.9rem; }
    .quote-stage-select { padding:4px 6px; border-radius:4px; border:1px solid #ccc; font-size:0.9rem; }
    .toggleTable { background:#112e1f; color:#FFD6BA; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; margin:10px 0; }
    .collapsed { display:none; }
    .row-highlight { transition:background-color 0.6s ease; background-color:#ffeeba; }
  </style>
</head>
<body>

<header>Fleur De Vie Admin Dashboard</header>

<!-- LOGIN FORM -->
<div class="container" id="loginContainer">
  <h2>Admin Login</h2>
  <form id="loginForm">
    <label for="loginEmail">Email</label>
    <input type="email" id="loginEmail" required>

    <label for="loginPassword">Password</label>
    <input type="password" id="loginPassword" required>

    <button type="submit">Login</button>
    <div class="message" id="loginMessage"></div>
  </form>
</div>

<!-- DASHBOARD -->
<div class="container" id="dashboardContainer" style="display:none;">
  <div class="dashboard-nav">
    <button type="button" data-target="productsSection">üì¶ Products</button>
    <button type="button" data-target="quotesSection">üí≥ Quotes</button>
    <button type="button" data-target="ordersSection">üßæ Orders</button>
  </div>

  <!-- PRODUCTS -->
  <div class="section" id="productsSection">
    <h2>Manage Products</h2>
    <form id="productForm">
      <label>Name</label>
      <input type="text" id="productName" required>
      
      <label>Price (NGN)</label>
      <input type="number" id="productPriceNGN" step="0.01" inputmode="decimal" required>
      <label>Price (USD)</label>
      <input type="number" id="productPriceUSD" step="0.01" inputmode="decimal">
      <label>Price (EUR)</label>
      <input type="number" id="productPriceEUR" step="0.01" inputmode="decimal">
      <label>Price (GBP)</label>
      <input type="number" id="productPriceGBP" step="0.01" inputmode="decimal">
      
      <label>Description</label>
      <textarea id="productDesc"></textarea>

      <!-- Repeatable Sizes -->
      <label>Sizes</label>
      <div id="sizesRepeat" class="repeatable"></div>
      <div style="margin-top:6px;">
        <button type="button" id="addSizeBtn" style="background:#fff;color:#112e1f;border:1px solid #112e1f;">+ Add Size</button>
      </div>

      <!-- Repeatable Colors -->
      <label>Colors</label>
      <div id="colorsRepeat" class="repeatable"></div>
      <div style="margin-top:6px;">
        <button type="button" id="addColorBtn" style="background:#fff;color:#112e1f;border:1px solid #112e1f;">+ Add Color</button>
      </div>

      <!-- Repeatable Images -->
      <label>Images (URLs)</label>
      <div id="imagesRepeat" class="repeatable"></div>
      <div style="margin-top:6px;">
        <button type="button" id="addImageBtn" style="background:#fff;color:#112e1f;border:1px solid #112e1f;">+ Add Image</button>
        <div class="small-note">Add multiple image URLs. First image will be used as thumbnail in the products table.</div>
      </div>
      
      <label>Customization Available</label>
      <select id="productCustom">
        <option value="false">No</option>
        <option value="true">Yes</option>
      </select>

      <label>Published</label>
      <select id="productPublished">
        <option value="false">No</option>
        <option value="true">Yes</option>
      </select>

      <button type="submit">Add Product</button>
    </form>
    <div id="productMessage" class="message"></div>

    <label style="margin-top:12px;">Table Currency:</label>
    <select id="tableCurrency">
      <option value="NGN">NGN</option>
      <option value="USD">USD</option>
      <option value="EUR">EUR</option>
      <option value="GBP">GBP</option>
    </select>

    <button class="toggleTable" data-target="productsTable">ÀÖ Hide Table</button>
    <table id="productsTable">
      <thead>
        <tr><th>Name</th><th>Price</th><th>Image</th><th>Customization</th><th>Published</th><th>Actions</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- QUOTES -->
  <div class="section" id="quotesSection">
    <h2>Generate Quote</h2>
    <form id="quoteForm">
      <label>Customer Name</label>
      <input type="text" id="quoteCustomer" required>
      <label>Customer Email</label>
      <input type="email" id="quoteEmail" required>

      <h3>Quote Items</h3>

      <div id="addItemPanel" class="add-item-panel" style="display:none;">
        <label>Item Name</label>
        <input type="text" id="ai_name" placeholder="Item name">
        <label>Quantity</label>
        <input type="number" id="ai_qty" min="1" value="1">
        <label>Description</label>
        <input type="text" id="ai_desc" placeholder="Description (optional)">
        <div class="inline-grid" style="margin-top:8px;">
          <div><label>Price NGN</label><input type="number" id="ai_price_ngn" step="0.01" inputmode="decimal"></div>
          <div><label>Price USD</label><input type="number" id="ai_price_usd" step="0.01" inputmode="decimal"></div>
          <div><label>Price EUR</label><input type="number" id="ai_price_eur" step="0.01" inputmode="decimal"></div>
          <div><label>Price GBP</label><input type="number" id="ai_price_gbp" step="0.01" inputmode="decimal"></div>
        </div>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button type="button" id="ai_add">Add</button>
          <button type="button" id="ai_cancel" style="background:#fff;color:#112e1f;border:1px solid #112e1f;">Cancel</button>
        </div>
      </div>

      <div id="quoteItems"></div>
      <button type="button" id="addQuoteItem">+ Add Item</button>

      <div style="display:flex; gap:8px; align-items:center; margin-top:8px;">
        <button type="button" id="generateQuoteLinkBtn" style="background:#0b6b4b;">Generate Link</button>
        <div id="generatedQuoteLink" style="margin-left:8px;"></div>
      </div>
    </form>
    <div id="quoteMessage" class="message"></div>

    <label style="margin-top:12px;">Display Currency for Quotes</label>
    <select id="quotesDisplayCurrency">
      <option value="NGN">NGN</option>
      <option value="USD">USD</option>
      <option value="EUR">EUR</option>
      <option value="GBP">GBP</option>
    </select>

    <button class="toggleTable" data-target="quotesTable">ÀÖ Hide Table</button>
    <table id="quotesTable">
      <thead>
        <tr><th>Customer</th><th>Email</th><th>Checkout Link</th><th>Total</th><th>Status</th><th>Actions</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Quote Modal -->
  <div id="quoteModalBackdrop" class="modal-backdrop">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="quoteModalTitle">
      <div class="modal-header">
        <h3 id="quoteModalTitle">Quote Details</h3>
        <div>
          <button id="openCheckoutBtn" class="close">Open Checkout</button>
          <button id="closeModalBtn" class="close">Close</button>
        </div>
      </div>
      <div class="modal-body" id="quoteModalBody"></div>
    </div>
  </div>

  <!-- ORDERS -->
  <div class="section" id="ordersSection">
    <h2>Manage Orders</h2>

    <!-- Filters + Export -->
    <div class="order-filters">
      <input type="text" id="orderSearch" placeholder="Search by customer or email...">
      <select id="orderStatusFilter">
        <option value="">All Status</option>
        <option>Pending</option>
        <option>Paid</option>
        <option>Processing</option>
        <option>Shipped</option>
        <option>Completed</option>
        <option>Cancelled</option>
      </select>

      <label style="width:100%; margin-top:8px;">Export options</label>
      <select id="exportCurrency" style="max-width:200px;">
        <option value="NGN">NGN</option>
        <option value="USD">USD</option>
        <option value="EUR">EUR</option>
        <option value="GBP">GBP</option>
      </select>
      <input type="date" id="exportFrom">
      <input type="date" id="exportTo">
      <button id="exportOrders">Export Orders CSV</button>
    </div>

    <button class="toggleTable" data-target="ordersTable">ÀÖ Hide Table</button>
    <table id="ordersTable">
      <thead>
        <tr><th>Order ID</th><th>Tracking Number</th><th>Email</th><th>Total</th><th>Status</th><th>Actions</th></tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<!-- ORDER DETAILS MODAL -->
<div id="orderDetailsModal" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <h3>Order Details</h3>
      <button id="closeOrderModal" class="close">&times;</button>
    </div>
    <div class="modal-body" id="orderDetailsBody"></div>
    <div style="margin-top:20px;text-align:right;">
      <button id="deleteOrderBtn" style="background:#d9534f;color:white;padding:6px 12px;border:none;border-radius:6px;">Delete Order</button>
    </div>
  </div>
</div>

<script type="module">
/* -------------------- FIREBASE IMPORTS (modular) -------------------- */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";
import {
  getFirestore, collection, addDoc, doc, updateDoc, deleteDoc,
  onSnapshot, getDoc, query, where, orderBy, getDocs, arrayUnion, setDoc
} from "https://www.gstatic.com/firebasejs/12.3.0/firebase-firestore.js";

/* -------------------- CONFIG (shared) -------------------- */
const firebaseConfig = {
  apiKey: "AIzaSyCuiZXHFYl1fVKnGwojavRvbekSBpkipJg",
  authDomain: "brandisby.firebaseapp.com",
  projectId: "brandisby",
  storageBucket: "brandisby.firebasestorage.app",
  messagingSenderId: "87213267039",
  appId: "1:87213267039:web:339e9fd49e3ad31f7423ea"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* -------------------- ALLOWED ADMINS -------------------- */
/* keep as your list ‚Äî add more emails if needed */
const allowedAdmins = ["yourstruly.fleurdevie@gmail.com"].map(e => e.toLowerCase().trim());

/* -------------------- STATE -------------------- */
let currentEditingProductId = null;
let productsCache = []; // array of product objects {id, ...}
let quotesCache = [];   // array of quote objects {id, ...}
let allOrders = [];     // array of orders
let quoteDraftItems = [];

/* -------------------- DOM REFS -------------------- */
/* Auth + UI */
const loginForm = document.getElementById("loginForm");
const loginMessage = document.getElementById("loginMessage");
const loginContainer = document.getElementById("loginContainer");
const dashboardContainer = document.getElementById("dashboardContainer");

/* Products */
const productForm = document.getElementById("productForm");
const productMessage = document.getElementById("productMessage");
const productsTableBody = document.querySelector("#productsTable tbody");
const tableCurrencySelect = document.getElementById("tableCurrency");
const sizesRepeat = document.getElementById("sizesRepeat");
const colorsRepeat = document.getElementById("colorsRepeat");
const imagesRepeat = document.getElementById("imagesRepeat");
const addSizeBtn = document.getElementById("addSizeBtn");
const addColorBtn = document.getElementById("addColorBtn");
const addImageBtn = document.getElementById("addImageBtn");

/* Quotes */
const quoteForm = document.getElementById("quoteForm");
const quoteItemsDiv = document.getElementById("quoteItems");
const addQuoteItemBtn = document.getElementById("addQuoteItem");
const generateQuoteLinkBtn = document.getElementById("generateQuoteLinkBtn");
const generatedQuoteLink = document.getElementById("generatedQuoteLink");
const quotesTableBody = document.querySelector("#quotesTable tbody");
const quoteMessage = document.getElementById("quoteMessage");
const quotesDisplayCurrency = document.getElementById("quotesDisplayCurrency");
const addItemPanel = document.getElementById("addItemPanel");
const ai_add = document.getElementById("ai_add");
const ai_cancel = document.getElementById("ai_cancel");

/* Orders */
const ordersTableBody = document.querySelector("#ordersTable tbody");
const orderSearch = document.getElementById("orderSearch");
const orderStatusFilter = document.getElementById("orderStatusFilter");
const exportBtn = document.getElementById("exportOrders");
const exportCurrency = document.getElementById("exportCurrency");
const exportFrom = document.getElementById("exportFrom");
const exportTo = document.getElementById("exportTo");

/* Modal */
const quoteModalBackdrop = document.getElementById("quoteModalBackdrop");
const quoteModalBody = document.getElementById("quoteModalBody");
const closeModalBtn = document.getElementById("closeModalBtn");
const openCheckoutBtn = document.getElementById("openCheckoutBtn");

/* Order Details modal */
const orderDetailsModal = document.getElementById("orderDetailsModal");
const orderDetailsBody = document.getElementById("orderDetailsBody");
const closeOrderModal = document.getElementById("closeOrderModal");
const deleteOrderBtn = document.getElementById("deleteOrderBtn");

/* -------------------- UTILS -------------------- */
function formatCurrency(value, currency){
  const localeMap = { NGN:'en-NG', USD:'en-US', EUR:'de-DE', GBP:'en-GB' };
  const minFrac = currency === 'NGN' ? 0 : 2;
  try {
    return new Intl.NumberFormat(localeMap[currency] || 'en-US', { style:'currency', currency, minimumFractionDigits: minFrac }).format(value);
  } catch(e) {
    return `${value} ${currency}`;
  }
}
function escapeHtml(str){ if (!str && str !== 0) return ""; return String(str).replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"}[s])); }

/* Repeatable inputs helpers */
function createRepeatRow(value='', placeholder='') {
  const row = document.createElement('div');
  row.className = 'row';
  row.innerHTML = `
    <input type="text" value="${escapeHtml(value)}" placeholder="${escapeHtml(placeholder)}" />
    <button type="button" class="remove-row" title="Remove">Remove</button>
  `;
  row.querySelector('.remove-row').addEventListener('click', () => row.remove());
  return row;
}
function addSizeInput(val=''){ sizesRepeat.appendChild(createRepeatRow(val,'Size e.g. S, M, L')); }
function addColorInput(val=''){ colorsRepeat.appendChild(createRepeatRow(val,'Color e.g. Olive')); }
function addImageInput(val=''){ imagesRepeat.appendChild(createRepeatRow(val,'https://.../image.jpg')); }
addSizeBtn?.addEventListener('click', () => addSizeInput());
addColorBtn?.addEventListener('click', () => addColorInput());
addImageBtn?.addEventListener('click', () => addImageInput());
addSizeInput(); addColorInput(); addImageInput();

/* -------------------- AUTH -------------------- */
loginForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  loginMessage.textContent = "";
  try {
    const email = document.getElementById("loginEmail").value;
    const password = document.getElementById("loginPassword").value;
    const userCred = await signInWithEmailAndPassword(auth, email, password);
    const normalized = (userCred.user.email || "").toLowerCase().trim();
    if (allowedAdmins.includes(normalized)) {
      loginContainer.style.display = "none";
      dashboardContainer.style.display = "block";
      startSubscriptions();
      showSection("productsSection");
    } else {
      loginMessage.textContent = "‚ùå Not authorized.";
      loginMessage.style.color = "red";
      await signOut(auth);
    }
  } catch (err) {
    console.error("Login error:", err);
    loginMessage.textContent = `‚ùå ${err.code || ""}: ${err.message || err}`;
    loginMessage.style.color = "red";
  }
});

onAuthStateChanged(auth, user => {
  if (user && allowedAdmins.includes((user.email || "").toLowerCase().trim())) {
    loginContainer.style.display = "none";
    dashboardContainer.style.display = "block";
    startSubscriptions();
    showSection("productsSection");
  } else {
    loginContainer.style.display = "block";
    dashboardContainer.style.display = "none";
  }
});

/* Navigation */
document.querySelectorAll(".dashboard-nav button").forEach(btn => {
  btn.addEventListener("click", () => showSection(btn.dataset.target));
});
function showSection(id) {
  document.querySelectorAll(".section").forEach(s => s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
}

/* -------------------- PRODUCTS: subscribe + render + helpers -------------------- */
function refreshProductRow(product) {
  // update or create in productsCache
  const idx = productsCache.findIndex(p => p.id === product.id);
  if (idx === -1) productsCache.push(product); else productsCache[idx] = product;

  // try to find existing table row
  let existing = productsTableBody.querySelector(`tr[data-id="${product.id}"]`);
  const currency = tableCurrencySelect.value || 'NGN';
  const priceMap = { NGN: product.priceNGN || 0, USD: product.priceUSD || 0, EUR: product.priceEUR || 0, GBP: product.priceGBP || 0 };
  const price = priceMap[currency] || 0;
  const firstImg = (product.images && product.images.length) ? product.images[0] : (product.imageUrl || "");
  const imagesCount = (product.images && product.images.length) ? ` (${product.images.length})` : "";

  const trHtml = `
    <td>${escapeHtml(product.name||'')}</td>
    <td class="product-price">${formatCurrency(price, currency)}</td>
    <td>${ firstImg ? `<img src="${firstImg}" alt="${escapeHtml(product.name)}" style="height:50px;width:auto;border-radius:6px;">` : '' }${imagesCount}</td>
    <td>${product.customizationAvailable ? 'Yes' : 'No'}</td>
    <td>${product.published ? 'Yes' : 'No'}</td>
    <td>
      <button data-id="${product.id}" class="edit-product">Edit</button>
      <button data-id="${product.id}" class="delete-product">Delete</button>
    </td>
  `;

  if (existing) {
    existing.innerHTML = trHtml;
  } else {
    existing = document.createElement("tr");
    existing.dataset.id = product.id;
    existing.innerHTML = trHtml;
    productsTableBody.appendChild(existing);
  }

  // highlight only the changed row
  existing.classList.add('row-highlight');
  setTimeout(()=> existing.classList.remove('row-highlight'), 700);

  // wire handlers
  existing.querySelector(".edit-product").onclick = () => editProduct(product.id);
  existing.querySelector(".delete-product").onclick = async () => {
    if (!confirm("Delete this product?")) return;
    try {
      await deleteDoc(doc(db, "brands", "fleurdevie", "products", product.id));
      existing.remove();
      productsCache = productsCache.filter(p => p.id !== product.id);
    } catch (err) {
      console.error("Failed to delete", err);
      alert("Delete failed: " + (err.message || err));
    }
  };
}

function renderProductsTable() {
  const currency = tableCurrencySelect.value || 'NGN';
  productsTableBody.innerHTML = "";
  productsCache.forEach(p => {
    const priceMap = { NGN: p.priceNGN || 0, USD: p.priceUSD || 0, EUR: p.priceEUR || 0, GBP: p.priceGBP || 0 };
    const priceVal = priceMap[currency] || 0;
    const firstImg = (p.images && p.images.length) ? p.images[0] : (p.imageUrl || "");
    const imagesCount = (p.images && p.images.length) ? ` (${p.images.length})` : "";
    const tr = document.createElement("tr");
    tr.dataset.id = p.id;
    tr.innerHTML = `
      <td>${escapeHtml(p.name || '')}</td>
      <td class="product-price">${formatCurrency(priceVal, currency)}</td>
      <td>${ firstImg ? `<img src="${firstImg}" alt="${escapeHtml(p.name)}">` : '' }${imagesCount}</td>
      <td>${p.customizationAvailable ? "Yes" : "No"}</td>
      <td>${p.published ? "Yes" : "No"}</td>
      <td class="actions">
        <button class="delete-product" data-id="${p.id}">Delete</button>
        <button class="edit-product" data-id="${p.id}">Edit</button>
      </td>
    `;
    productsTableBody.appendChild(tr);

    // wire handlers
    tr.querySelector(".edit-product").addEventListener("click", () => editProduct(p.id));
    tr.querySelector(".delete-product").addEventListener("click", async () => {
      if (!confirm("Delete this product?")) return;
      try {
        await deleteDoc(doc(db, "brands", "fleurdevie", "products", p.id));
      } catch (err) {
        console.error("Delete product error", err);
        alert("Delete failed: " + (err.message || err));
      }
    });
  });
}

/* update only prices in table when currency changes */
function updateTablePrices() {
  const currency = tableCurrencySelect.value || 'NGN';
  productsCache.forEach(product => {
    const tr = productsTableBody.querySelector(`tr[data-id="${product.id}"]`);
    if (tr) {
      const priceMap = { NGN: product.priceNGN || 0, USD: product.priceUSD || 0, EUR: product.priceEUR || 0, GBP: product.priceGBP || 0 };
      const priceCell = tr.querySelector(".product-price");
      if (priceCell) priceCell.textContent = formatCurrency(priceMap[currency] || 0, currency);
    }
  });
}

/* subscribe products */
function subscribeProducts() {
  const productsRef = collection(db, "brands", "fleurdevie", "products");
  onSnapshot(productsRef, snap => {
    productsCache = [];
    const seenIds = new Set();
    snap.forEach(docSnap => {
      const p = { id: docSnap.id, ...docSnap.data() };
      productsCache.push(p);
      refreshProductRow(p);
      seenIds.add(p.id);
    });
    // remove any orphan rows
    productsTableBody.querySelectorAll("tr[data-id]").forEach(tr => {
      if (!seenIds.has(tr.dataset.id)) tr.remove();
    });
  }, err => {
    console.error("Products snapshot error:", err);
    productMessage.textContent = `‚ùå ${err.code || ""}: ${err.message || err}`;
    productMessage.style.color = "red";
  });
}

/* product form submit */
productForm.addEventListener("submit", async (e) => {
  e.preventDefault();
  const data = {
    name: document.getElementById("productName").value.trim(),
    priceNGN: parseFloat(document.getElementById("productPriceNGN").value) || 0,
    priceUSD: parseFloat(document.getElementById("productPriceUSD").value) || 0,
    priceEUR: parseFloat(document.getElementById("productPriceEUR").value) || 0,
    priceGBP: parseFloat(document.getElementById("productPriceGBP").value) || 0,
    description: document.getElementById("productDesc").value || "",
    customizationAvailable: document.getElementById("productCustom").value === "true",
    published: document.getElementById("productPublished").value === "true",
    updatedAt: new Date().toISOString()
  };

  const sizes = Array.from(sizesRepeat.querySelectorAll('input')).map(i => i.value.trim()).filter(Boolean);
  const colors = Array.from(colorsRepeat.querySelectorAll('input')).map(i => i.value.trim()).filter(Boolean);
  const images = Array.from(imagesRepeat.querySelectorAll('input')).map(i => i.value.trim()).filter(Boolean);

  data.sizes = sizes;
  data.colors = colors;
  data.images = images;
  data.imageUrl = images[0] || "";

  try {
    let productId;
    if (currentEditingProductId) {
      await updateDoc(doc(db, "brands", "fleurdevie", "products", currentEditingProductId), data);
      productMessage.textContent = "‚úÖ Product updated.";
      productMessage.style.color = "green";
      productId = currentEditingProductId;
      currentEditingProductId = null;
      productForm.querySelector("button[type='submit']").textContent = "Add Product";
    } else {
      const docRef = await addDoc(collection(db, "brands", "fleurdevie", "products"), data);
      productMessage.textContent = "‚úÖ Product added.";
      productMessage.style.color = "green";
      productId = docRef.id;
    }

    // reset form & repeatable fields
    productForm.reset();
    sizesRepeat.innerHTML = ""; colorsRepeat.innerHTML = ""; imagesRepeat.innerHTML = "";
    addSizeInput(); addColorInput(); addImageInput();

    // update cache and refresh single row
    const newProduct = { id: productId, ...data };
    const existingIndex = productsCache.findIndex(p => p.id === productId);
    if (existingIndex > -1) productsCache[existingIndex] = newProduct; else productsCache.push(newProduct);
    refreshProductRow(newProduct);

  } catch (err) {
    console.error(err);
    productMessage.textContent = "‚ùå Error saving product.";
    productMessage.style.color = "red";
  }
});

/* edit product */
async function editProduct(id){
  try {
    const docRef = doc(db, "brands", "fleurdevie", "products", id);
    const snap = await getDoc(docRef);
    if (!snap.exists()) return alert("Product not found");
    const p = snap.data();
    currentEditingProductId = id;

    document.getElementById("productName").value = p.name || "";
    document.getElementById("productPriceNGN").value = p.priceNGN != null ? p.priceNGN : "";
    document.getElementById("productPriceUSD").value = p.priceUSD != null ? p.priceUSD : "";
    document.getElementById("productPriceEUR").value = p.priceEUR != null ? p.priceEUR : "";
    document.getElementById("productPriceGBP").value = p.priceGBP != null ? p.priceGBP : "";
    document.getElementById("productDesc").value = p.description || "";
    document.getElementById("productCustom").value = p.customizationAvailable ? "true" : "false";
    document.getElementById("productPublished").value = p.published ? "true" : "false";

    sizesRepeat.innerHTML = "";
    (p.sizes || []).forEach(s => addSizeInput(s));
    if ((p.sizes || []).length === 0) addSizeInput();

    colorsRepeat.innerHTML = "";
    (p.colors || []).forEach(c => addColorInput(c));
    if ((p.colors || []).length === 0) addColorInput();

    imagesRepeat.innerHTML = "";
    (p.images || []).forEach(i => addImageInput(i));
    if ((p.images || []).length === 0) addImageInput();

    productForm.scrollIntoView({behavior:"smooth"});
    productForm.querySelector("button[type='submit']").textContent = "Save Product";
  } catch (err) {
    console.error("Edit product failed", err);
    alert("Failed to load product for edit.");
  }
}

/* -------------------- QUOTES: draft UI, save, subscribe, render -------------------- */
function renderDraftItems(){
  quoteItemsDiv.innerHTML = '';
  if(!quoteDraftItems.length){ 
    quoteItemsDiv.innerHTML = '<div class="small-note">No items added yet.</div>'; 
    return; 
  }
  quoteDraftItems.forEach((it, idx) => {
    const div = document.createElement("div");
    div.className = "quote-item";
    div.innerHTML = `<div style="display:flex;justify-content:space-between;gap:12px;align-items:flex-start;">
      <div style="flex:1;"><strong>${escapeHtml(it.name)}</strong> √ó ${it.qty}<br><small>${escapeHtml(it.desc||'')}</small>
      <div style="margin-top:8px;display:grid;grid-template-columns:repeat(4,1fr);gap:8px;">
        <div>NGN: ${it.priceNGN!=null?formatCurrency(it.priceNGN,'NGN'):'-'}</div>
        <div>USD: ${it.priceUSD!=null?formatCurrency(it.priceUSD,'USD'):'-'}</div>
        <div>EUR: ${it.priceEUR!=null?formatCurrency(it.priceEUR,'EUR'):'-'}</div>
        <div>GBP: ${it.priceGBP!=null?formatCurrency(it.priceGBP,'GBP'):'-'}</div>
      </div></div>
      <div style="min-width:90px;text-align:right;"><button data-idx="${idx}" class="remove-draft">Remove</button></div>
    </div>`;
    quoteItemsDiv.appendChild(div);
  });
  document.querySelectorAll(".remove-draft").forEach(btn => btn.addEventListener("click", () => { 
    quoteDraftItems.splice(parseInt(btn.dataset.idx), 1); renderDraftItems(); 
  }));
}

/* Add Item panel toggles & handlers */
addQuoteItemBtn.addEventListener("click", () => {
  addItemPanel.style.display = addItemPanel.style.display === "none" ? "block" : "none";
  if (addItemPanel.style.display === "block") document.getElementById("ai_name").focus();
});
ai_cancel?.addEventListener("click", () => {
  addItemPanel.style.display = "none";
  document.getElementById("ai_name").value = "";
  document.getElementById("ai_qty").value = 1;
  document.getElementById("ai_desc").value = "";
  document.getElementById("ai_price_ngn").value = "";
  document.getElementById("ai_price_usd").value = "";
  document.getElementById("ai_price_eur").value = "";
  document.getElementById("ai_price_gbp").value = "";
});
ai_add?.addEventListener("click", () => {
  const name = document.getElementById("ai_name").value.trim();
  const qty = parseInt(document.getElementById("ai_qty").value) || 0;
  if (!name || qty <= 0) { alert("Please enter item name and quantity."); return; }
  const item = {
    name,
    qty,
    desc: document.getElementById("ai_desc").value || "",
    priceNGN: document.getElementById("ai_price_ngn").value ? parseFloat(document.getElementById("ai_price_ngn").value) : null,
    priceUSD: document.getElementById("ai_price_usd").value ? parseFloat(document.getElementById("ai_price_usd").value) : null,
    priceEUR: document.getElementById("ai_price_eur").value ? parseFloat(document.getElementById("ai_price_eur").value) : null,
    priceGBP: document.getElementById("ai_price_gbp").value ? parseFloat(document.getElementById("ai_price_gbp").value) : null
  };
  quoteDraftItems.push(item);
  // clear panel & hide
  document.getElementById("ai_name").value = "";
  document.getElementById("ai_qty").value = 1;
  document.getElementById("ai_desc").value = "";
  document.getElementById("ai_price_ngn").value = "";
  document.getElementById("ai_price_usd").value = "";
  document.getElementById("ai_price_eur").value = "";
  document.getElementById("ai_price_gbp").value = "";
  addItemPanel.style.display = "none";
  renderDraftItems();
});

/* Generate Quote Link (store quote in Firestore and also attempt to store locally) */
generateQuoteLinkBtn.addEventListener("click", async () => {
  const customer = document.getElementById("quoteCustomer").value.trim();
  const email = document.getElementById("quoteEmail").value.trim();
  if (!customer || !email) { alert("Customer name and email required."); return; }
  if (!quoteDraftItems.length) { alert("Add at least one item."); return; }

  const data = {
    customer: customer,
    email: email,
    items: quoteDraftItems,
    status: "Unpaid",
    createdAt: new Date().toISOString()
  };

  try {
    const docRef = await addDoc(collection(db, "brands", "fleurdevie", "quotes"), data);
    const id = docRef.id;

    // Link to Fleur De Vie checkout (relative)
    const link = `./checkout/index.html?quoteId=${id}`;

    try { localStorage.setItem(id, JSON.stringify(data)); } catch(e){ console.warn("localStorage set failed", e); }

    generatedQuoteLink.innerHTML = `
      <a href="${link}" target="_blank" id="gqlink">${link}</a>
      <button class="copy-btn" id="copyGeneratedBtn" data-link="${link}">üìã</button>
    `;
    document.getElementById("copyGeneratedBtn").addEventListener("click", async () => {
      await navigator.clipboard.writeText(link);
      const btn = document.getElementById("copyGeneratedBtn");
      btn.textContent = "‚úÖ";
      setTimeout(() => btn.textContent = "üìã", 1000);
    });

    quoteMessage.textContent = "‚úÖ Quote saved and link generated.";
    quoteMessage.style.color = "green";
    quoteForm.reset();
    quoteDraftItems = [];
    renderDraftItems();
  } catch (err) {
    console.error("Save quote failed", err);
    quoteMessage.textContent = "‚ùå Error saving quote.";
    quoteMessage.style.color = "red";
  }
});

/* compute total from items in a given currency */
function computeTotalFromItems(items = [], currency = 'NGN') {
  let total = 0;
  if (!items || !items.length) return 0;
  items.forEach(it => {
    const qty = parseFloat(it.qty) || 0;
    let price = 0;
    if (currency === 'NGN') price = it.priceNGN || 0;
    if (currency === 'USD') price = it.priceUSD || 0;
    if (currency === 'EUR') price = it.priceEUR || 0;
    if (currency === 'GBP') price = it.priceGBP || 0;
    total += (price * qty);
  });
  return total;
}

/* -------------------- QUOTES: subscribe & render -------------------- */
function subscribeQuotes() {
  const quotesRef = collection(db, "brands", "fleurdevie", "quotes");
  onSnapshot(quotesRef, snap => {
    quotesCache = [];
    quotesTableBody.innerHTML = "";
    snap.forEach(docSnap => {
      const q = { id: docSnap.id, ...docSnap.data() };
      quotesCache.push(q);
    });
    renderQuotesTable();
  }, err => {
    console.error("Quotes snapshot error:", err);
    quoteMessage.textContent = `‚ùå ${err.code || ""}: ${err.message || err}`;
    quoteMessage.style.color = "red";
  });
}

function renderQuotesTable() {
  const displayCurrency = quotesDisplayCurrency.value || 'NGN';
  quotesTableBody.innerHTML = "";

  quotesCache.forEach(q => {
    const id = q.id;
    const computedTotal = computeTotalFromItems(q.items || [], displayCurrency);
    let displayTotal = "‚Äî";
    if (computedTotal > 0) {
      displayTotal = formatCurrency(computedTotal, displayCurrency);
    } else if (q.total != null) {
      displayTotal = `${formatCurrency(q.total, q.currency || displayCurrency)} (${q.currency || displayCurrency})`;
    }

    const link = `./checkout/index.html?quoteId=${id}`;
    const status = (q.status || "Unpaid").toLowerCase();
    const stage = q.stage || "Processing";

    const statusDisplay = status === "paid"
      ? `<span class="status-tag paid">Paid ‚úÖ</span>`
      : `<span class="status-tag unpaid">Unpaid ‚è≥</span>`;

    const stageDropdown = status === "paid"
      ? `
        <select data-id="${id}" class="quote-stage-select">
          <option ${stage === 'Processing' ? 'selected' : ''}>Processing</option>
          <option ${stage === 'Packaging' ? 'selected' : ''}>Packaging</option>
          <option ${stage === 'Shipped' ? 'selected' : ''}>Shipped</option>
          <option ${stage === 'Delivered' ? 'selected' : ''}>Delivered</option>
        </select>
      `
      : `<span class="dim-text">‚Äî</span>`;

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${escapeHtml(q.customer || "")}</td>
      <td>${escapeHtml(q.email || "")}</td>
      <td style="max-width:60%;">
        <a href="${link}" target="_blank" style="display:inline-block; max-width:100%; overflow:hidden; text-overflow:ellipsis;">${link}</a> 
        <button class="copy-btn" data-link="${link}">üìã</button>
      </td>
      <td>${displayTotal}</td>
      <td>${statusDisplay}</td>
      <td>${stageDropdown}</td>
      <td class="actions">
        <button class="view-quote" data-id="${id}">View</button>
        <button class="delete-quote" data-id="${id}">Delete</button>
      </td>
    `;
    quotesTableBody.appendChild(row);

    // Copy link
    row.querySelectorAll(".copy-btn").forEach(btn => {
      btn.addEventListener("click", async () => {
        try {
          await navigator.clipboard.writeText(btn.dataset.link);
          const prev = btn.textContent;
          btn.textContent = "‚úÖ";
          setTimeout(() => btn.textContent = prev, 1000);
        } catch {
          alert("Copy failed. Link: " + btn.dataset.link);
        }
      });
    });

    // View button
    row.querySelector(".view-quote").addEventListener("click", () => openQuoteModal(q));

    // Delete button
    row.querySelector(".delete-quote").addEventListener("click", async () => {
      if (!confirm("Delete this quote?")) return;
      try {
        await deleteDoc(doc(db, "brands", "fleurdevie", "quotes", q.id));
      } catch (err) {
        console.error(err);
        alert("Delete failed");
      }
    });

    // Stage dropdown update (if present)
    const stageSelect = row.querySelector(".quote-stage-select");
    if (stageSelect) {
      stageSelect.addEventListener("change", async (ev) => {
        const newStage = ev.target.value;
        const id = ev.target.dataset.id;
        try {
          await updateDoc(doc(db, "brands", "fleurdevie", "quotes", id), { stage: newStage });
        } catch (err) {
          console.error("Failed to update stage", err);
          alert("Failed to update stage: " + (err.message || err));
        }
      });
    }
  });
}

/* -------------------- QUOTE MODAL -------------------- */
function openQuoteModal(q) {
  quoteModalBody.innerHTML = "";
  const displayCurrency = quotesDisplayCurrency.value || 'NGN';
  const link = `./checkout/index.html?quoteId=${q.id}`;

  const header = document.createElement("div");
  header.style.display = "flex";
  header.style.justifyContent = "space-between";
  header.style.gap = "12px";
  header.innerHTML = `
    <div>
      <strong>${escapeHtml(q.customer || '')}</strong><br><small>${escapeHtml(q.email || '')}</small><br><small>Quote currency: ${q.currency || displayCurrency}</small>
    </div>
    <div style="text-align:right;">
      <a href="${link}" target="_blank">${link}</a>
      <button class="copy-btn" id="modalCopyBtn" data-link="${link}">üìã</button>
    </div>
  `;
  quoteModalBody.appendChild(header);
  quoteModalBody.appendChild(document.createElement("hr"));

  let computedTotal = 0;
  (q.items || []).forEach(it => {
    const qty = parseFloat(it.qty) || 0;
    let price = 0;
    if (displayCurrency === 'NGN') price = it.priceNGN || 0;
    if (displayCurrency === 'USD') price = it.priceUSD || 0;
    if (displayCurrency === 'EUR') price = it.priceEUR || 0;
    if (displayCurrency === 'GBP') price = it.priceGBP || 0;
    const line = price * qty;
    computedTotal += line;

    const div = document.createElement("div");
    div.style.border = "1px solid #eee";
    div.style.padding = "8px";
    div.style.marginBottom = "8px";
    div.style.borderRadius = "6px";
    div.innerHTML = `<strong>${escapeHtml(it.name)}</strong> √ó ${qty} <br><small>${escapeHtml(it.desc||'')}</small><div style="margin-top:6px;">${formatCurrency(price, displayCurrency)} each ‚Äî Line total: ${formatCurrency(line, displayCurrency)}</div>`;
    quoteModalBody.appendChild(div);
  });

  if (computedTotal > 0) {
    const totalDiv = document.createElement("div");
    totalDiv.style.marginTop = "8px";
    totalDiv.innerHTML = `<strong>Total: ${formatCurrency(computedTotal, displayCurrency)}</strong>`;
    quoteModalBody.appendChild(totalDiv);
  } else if (q.total != null) {
    const totalDiv = document.createElement("div");
    totalDiv.style.marginTop = "8px";
    totalDiv.innerHTML = `<strong>Total (explicit): ${formatCurrency(q.total, q.currency || displayCurrency)} (${q.currency || displayCurrency})</strong>`;
    quoteModalBody.appendChild(totalDiv);
  } else {
    const totalDiv = document.createElement("div");
    totalDiv.style.marginTop = "8px";
    totalDiv.innerHTML = `<strong>Total: ‚Äî</strong>`;
    quoteModalBody.appendChild(totalDiv);
  }

  // wire modal copy button
  const modalCopyBtn = document.getElementById('modalCopyBtn');
  if (modalCopyBtn) {
    modalCopyBtn.addEventListener('click', async () => {
      try {
        await navigator.clipboard.writeText(modalCopyBtn.dataset.link);
        modalCopyBtn.textContent = "‚úÖ";
        setTimeout(() => modalCopyBtn.textContent = "üìã", 1000);
      } catch (e) {
        alert("Copy failed. Link: " + modalCopyBtn.dataset.link);
      }
    });
  }

  // open
  quoteModalBackdrop.dataset.currentId = q.id;
  quoteModalBackdrop.dataset.currentLink = link;
  quoteModalBackdrop.style.display = "flex";
}

/* modal close wiring */
closeModalBtn.addEventListener('click', () => { 
  quoteModalBackdrop.style.display = 'none'; 
  quoteModalBackdrop.dataset.currentId = ''; 
  quoteModalBackdrop.dataset.currentLink = '';
});
quoteModalBackdrop.addEventListener('click', (ev) => { 
  if (ev.target === quoteModalBackdrop) { 
    quoteModalBackdrop.style.display = 'none'; 
    quoteModalBackdrop.dataset.currentId = ''; 
    quoteModalBackdrop.dataset.currentLink = '';
  } 
});
openCheckoutBtn.addEventListener('click', () => {
  const link = quoteModalBackdrop.dataset.currentLink;
  if (link) window.open(link, '_blank');
});

/* -------------------- ORDERS: subscribe + render + export -------------------- */
function logStatusChange(orderRef, newStatus, changedBy = "admin") {
  const entry = {
    status: newStatus,
    changedBy,
    changedAt: new Date().toISOString()
  };
  return updateDoc(orderRef, {
    status: newStatus,
    statusHistory: arrayUnion(entry)
  });
}

function renderOrders(orders) {
  const term = (orderSearch.value || "").toLowerCase();
  const status = orderStatusFilter.value;
  const tbody = ordersTableBody;
  tbody.innerHTML = "";

  const filtered = orders.filter(o => {
    const matchesStatus = !status || o.status === status;
    const matchesTerm =
      !term ||
      (o.trackingNumber || "").toLowerCase().includes(term) ||
      (o.email || "").toLowerCase().includes(term) ||
      (o.customer || "").toLowerCase().includes(term) ||
      (o.id || "").toLowerCase().includes(term);
    return matchesStatus && matchesTerm;
  });

  filtered.forEach(o => {
    const orderIdDisplay = `<a href="./order-details.html?orderId=${o.id}" target="_blank">${escapeHtml(o.id)}</a>`;
    const colorMap = {
      Paid: "#2A9D8F",
      Pending: "#F4A261",
      Processing: "#8A4D2B",
      Shipped: "#C2855E",
      Completed: "#2ECC71",
      Cancelled: "#E74C3C"
    };

    const statusDropdown = `
      <select class="statusSelect" data-id="${o.id}" style="background:${colorMap[o.status] || "#999"};color:#fff;border:none;padding:4px 8px;border-radius:6px;">
        ${["Paid","Pending","Processing","Shipped","Completed","Cancelled"]
          .map(
            s => `<option value="${s}" ${o.status === s ? "selected" : ""}>${s}</option>`
          ).join("")}
      </select>
    `;

    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${orderIdDisplay}</td>
      <td>${escapeHtml(o.trackingNumber || o.trackingRef || o.tx_ref || "‚Äî")}</td>
      <td>${escapeHtml(o.email || "")}</td>
      <td>${formatCurrency(parseFloat(o.total || 0), o.currency || "NGN")}</td>
      <td>${statusDropdown}</td>
      <td>
        <button class="viewOrderBtn" data-id="${o.id}" style="background:#112e1f;color:white;border:none;padding:4px 8px;border-radius:6px;">View</button>
        <button class="deleteOrderBtn" data-id="${o.id}" style="background:#d9534f;color:white;border:none;padding:4px 8px;border-radius:6px;">Delete</button>
      </td>
    `;
    tbody.appendChild(row);
  });

  /* Wire dropdowns + actions */
  document.querySelectorAll(".statusSelect").forEach(sel => {
    sel.addEventListener("change", async e => {
      const orderId = e.target.dataset.id;
      const newStatus = e.target.value;
      const orderRef = doc(db, "brands", "fleurdevie", "orders", orderId);
      await logStatusChange(orderRef, newStatus, "admin");
      console.log(`‚úÖ Order ${orderId} updated to ${newStatus}`);
    });
  });

  document.querySelectorAll(".viewOrderBtn").forEach(btn => {
    btn.addEventListener("click", e => openOrderModal(e.target.dataset.id));
  });

  document.querySelectorAll(".deleteOrderBtn").forEach(btn => {
    btn.addEventListener("click", e => deleteOrder(e.target.dataset.id));
  });
}

async function openOrderModal(orderId) {
  const docSnap = await getDoc(doc(db, "brands", "fleurdevie", "orders", orderId));
  if (!docSnap.exists()) return alert("Order not found");
  const o = { id: docSnap.id, ...docSnap.data() };

  let historyHtml = "";
  if (Array.isArray(o.statusHistory)) {
    historyHtml =
      "<h4>Status History</h4><ul style='padding-left:16px;'>" +
      o.statusHistory
        .map(
          h =>
            `<li>${escapeHtml(h.status)} ‚Äî <small>${escapeHtml(h.changedBy || '')}</small> at ${new Date(h.changedAt).toLocaleString()}</li>`
        )
        .join("") +
      "</ul>";
  }

  orderDetailsBody.innerHTML = `
    <p><b>Order ID:</b> ${escapeHtml(o.id)}</p>
    <p><b>Tracking Number:</b> ${escapeHtml(o.trackingNumber || o.trackingRef || o.tx_ref || "‚Äî")}</p>
    <p><b>Email:</b> ${escapeHtml(o.email || "")}</p>
    <p><b>Address:</b> ${escapeHtml(o.address || "‚Äî")}</p>
    <p><b>Amount:</b> ${formatCurrency(parseFloat(o.total || 0), o.currency || "NGN")}</p>
    <p><b>Status:</b> ${escapeHtml(o.status || "")}</p>
    ${historyHtml}
  `;

  orderDetailsModal.style.display = "flex";
  deleteOrderBtn.onclick = () => deleteOrder(orderId);
}

closeOrderModal.onclick = () => { orderDetailsModal.style.display = "none"; };

async function deleteOrder(orderId) {
  if (!confirm("Are you sure you want to delete this order?")) return;
  await deleteDoc(doc(db, "brands", "fleurdevie", "orders", orderId));
  alert("‚úÖ Order deleted.");
  orderDetailsModal.style.display = "none";
}

/* ---------------- AUTO-COMPLETE SHIPPED AFTER 48H ---------------- */
async function autoCompleteShippedOrders() {
  try {
    const cutoff = new Date(Date.now() - 48 * 60 * 60 * 1000); // 48h ago
    const qSnap = await getDocs(query(collection(db, "brands", "fleurdevie", "orders"), where("status", "==", "Shipped")));
    for (const docSnap of qSnap.docs) {
      const o = docSnap.data();
      const created = new Date(o.createdAt || o.createdAt?.toDate?.() || Date.now());
      if (created < cutoff) {
        await logStatusChange(doc(db, "brands", "fleurdevie", "orders", docSnap.id), "Completed", "auto-system");
      }
    }
  } catch (err) {
    console.error("Auto update failed:", err);
  }
}
autoCompleteShippedOrders();
setInterval(autoCompleteShippedOrders, 60 * 60 * 1000);

/* ---------------- EXPORT ---------------- */
async function fetchRates(base = "NGN") {
  try {
    const res = await fetch(`https://api.exchangerate.host/latest?base=${encodeURIComponent(base)}&symbols=USD,EUR,GBP,NGN`);
    const data = await res.json();
    if (data && data.rates) return data.rates;
  } catch (e) { console.warn("Failed to fetch rates", e); }
  return { NGN: 1, USD: 0.0022, EUR: 0.002, GBP: 0.0018 };
}

async function exportOrdersCSV(e) {
  e.preventDefault();
  const from = exportFrom.value || null;
  const to = exportTo.value || null;
  const targetCurrency = exportCurrency.value || "NGN";
  const toExport = allOrders.filter(o => {
    if (!o.createdAt) return true;
    const d = new Date(o.createdAt);
    if (isNaN(d)) return true;
    if (from) {
      const fromD = new Date(from);
      if (d < fromD) return false;
    }
    if (to) {
      const toD = new Date(to);
      toD.setHours(23, 59, 59, 999);
      if (d > toD) return false;
    }
    return true;
  });

  const ratesFromNGN = await fetchRates("NGN");
  const rows = [];
  rows.push([
    "orderId",
    "trackingNumber",
    "email",
    "createdAt",
    "status",
    "originalCurrency",
    "originalTotal",
    `total_${targetCurrency}`,
    "source"
  ]);

  for (const o of toExport) {
    const origCurrency = o.currency || "NGN";
    const origTotal = parseFloat(o.total || 0);
    let converted = origTotal;
    if (origCurrency !== targetCurrency) {
      const rateOrder = ratesFromNGN[origCurrency];
      const rateTarget = ratesFromNGN[targetCurrency];
      if (rateOrder && rateTarget)
        converted = (origTotal / rateOrder) * rateTarget;
    }
    if (!o.status) o.status = "Paid";
    rows.push([
      o.id || "",
      o.trackingNumber || o.trackingRef || o.tx_ref || "",
      o.email || "",
      o.createdAt || "",
      o.status,
      origCurrency,
      origTotal,
      converted,
      o.source || ""
    ]);
  }

  const csv = rows
    .map(r =>
      r
        .map(cell => {
          const s = String(cell || "");
          return s.includes(",") || s.includes('"') || s.includes("\n")
            ? `"${s.replace(/"/g, '""')}"`
            : s;
        })
        .join(",")
    )
    .join("\n");

  const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `fleurdevie_orders_${targetCurrency}_${new Date().toISOString().slice(0, 10)}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}
exportBtn.addEventListener("click", exportOrdersCSV);

/* ---------------- QUOTE FORM (alternate quick add) ---------------- */
function startSubscriptions() {
  subscribeProducts();
  subscribeQuotes();
  subscribeOrders();
}

/* ---------------- SUBSCRIBE ORDERS (realtime) ---------------- */
function subscribeOrders() {
  // Admins should see all orders; others none ‚Äî this uses onSnapshot to watch orders
  const ordersRef = collection(db, "brands", "fleurdevie", "orders");
  onSnapshot(ordersRef, snap => {
    allOrders = [];
    snap.forEach(docSnap => {
      const o = { id: docSnap.id, ...docSnap.data() };
      if (!o.status) o.status = "Paid";
      allOrders.push(o);
    });
    renderOrders(allOrders);
  }, err => {
    console.error("Orders snapshot error:", err);
    alert("Orders load error: " + (err.message || err));
  });
}

/* ---------------- QUOTES: modal wiring on currency change ---------------- */
document.addEventListener("DOMContentLoaded", () => {
  tableCurrencySelect?.addEventListener("change", updateTablePrices);
  renderDraftItems();

  quotesDisplayCurrency.addEventListener("change", () => {
    renderQuotesTable();
    if (quoteModalBackdrop.style.display === "flex") {
      const curId = quoteModalBackdrop.dataset.currentId;
      if (curId) {
        // refresh modal content from cache
        const q = quotesCache.find(x => x.id === curId);
        if (q) openQuoteModal(q);
      }
    }
  });

  startSubscriptions();
});

/* Toggle table buttons */
document.querySelectorAll(".toggleTable").forEach(btn => {
  btn.addEventListener("click", () => {
    const targetId = btn.dataset.target;
    const table = document.getElementById(targetId);
    if (!table) return;
    table.classList.toggle("collapsed");
    if (table.classList.contains("collapsed")) {
      btn.textContent = "ÀÑ Show Table";
    } else {
      btn.textContent = "ÀÖ Hide Table";
    }
  });
});

/* Wire up simple delete/edit windows in global scope (for inline onclicks) */
window.deleteProduct = async (id) => {
  if (!confirm("Delete this product?")) return;
  try { await deleteDoc(doc(db, "brands", "fleurdevie", "products", id)); } 
  catch(err){console.error(err); alert("Error deleting product");}
};
window.editProduct = async (id) => { await editProduct(id); };
window.deleteQuote = async (id) => {
  if (!confirm("Delete this quote?")) return;
  try { await deleteDoc(doc(db, "brands", "fleurdevie", "quotes", id)); }
  catch(err){console.error(err); alert("Error deleting quote");}
};
window.viewQuoteModal = (id) => populateQuoteModal(id);

/* populateQuoteModal supports both cache and fetching */
async function populateQuoteModal(id) {
  const displayCurrency = quotesDisplayCurrency.value || 'NGN';
  const qObj = quotesCache.find(qc => qc.id === id);
  let q;
  if (qObj) q = qObj;
  else {
    const snap = await getDoc(doc(db, "brands", "fleurdevie", "quotes", id));
    if (!snap.exists()) return alert("Quote not found");
    q = { id: snap.id, ...snap.data() };
  }
  openQuoteModal(q);
}

/* ------------------- INIT ------------------- */
startSubscriptions();

</script>

</body>
</html>
